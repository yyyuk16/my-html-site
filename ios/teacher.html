<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>日本語GPT-2チャット</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="flex items-center justify-center min-h-screen" style="background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);">
  <div class="bg-white w-full max-w-2xl h-[90vh] rounded-[22px] shadow-lg border border-[#E8F5E9] flex flex-col" style="box-shadow: 0 4px 15px rgba(67, 160, 71, 0.10);">
    
    <!-- ヘッダー -->
    <div class="text-white p-4 rounded-t-[22px] flex justify-between items-center" style="background: linear-gradient(135deg, #A5D6A7 0%, #2E7D32 100%);">
             <div class="flex items-center space-x-3">
               <button onclick="location.href='ai.html'" class="bg-white text-[#43A047] px-3 py-1 rounded-[10px] text-sm font-semibold hover:bg-[#E8F5E9] transition-colors flex items-center space-x-1">
                 <span>←</span>
                 <span>戻る</span>
               </button>
               <h1 class="text-lg font-bold">日本語GPT-2 Small チャット</h1>
             </div>
             <div class="flex items-center space-x-2">
         <input id="apiTokenInput" type="password" placeholder="HuggingFace APIトークン" class="px-2 py-1 text-sm text-gray-800 rounded-[10px] border-0 focus:ring-2 focus:ring-[#A5D6A7]"/>
         <button id="saveButton" class="bg-white text-[#43A047] px-3 py-1 rounded-[10px] text-sm font-semibold hover:bg-[#E8F5E9] transition-colors">保存</button>
       </div>
    </div>

    <!-- チャット画面 -->
    <div id="chatContainer" class="flex-grow p-4 overflow-y-auto space-y-3" style="background: rgba(255, 255, 255, 0.98);">
             <div class="bg-white p-3 rounded-[16px] max-w-[80%] shadow-sm border border-[#E8F5E9]">
                  <p class="text-[#1A1A1A]">チャットボットです！APIトークンを入力するとAI応答、入力しないとフォールバック応答で会話できます。</p>
       </div>
    </div>

    <!-- 入力欄 -->
    <div class="p-4 rounded-b-[22px] flex space-x-2" style="background: linear-gradient(120deg, #E8F5E9 0%, #A5D6A7 100%);">
      <input id="userInput" type="text" placeholder="メッセージを入力..." class="flex-grow p-2 border border-[#C8E6C9] rounded-[10px] focus:ring-2 focus:ring-[#A5D6A7] focus:border-[#43A047] outline-none"/>
      <button id="sendButton" class="text-white px-4 py-2 rounded-[10px] font-semibold shadow-md hover:shadow-lg transition-all" style="background: linear-gradient(135deg, #A5D6A7 0%, #2E7D32 100%);">送信</button>
    </div>

  </div>

  <script>
    const chatContainer = document.getElementById("chatContainer");
    const userInput = document.getElementById("userInput");
    const sendButton = document.getElementById("sendButton");
    const apiTokenInput = document.getElementById("apiTokenInput");
    const saveButton = document.getElementById("saveButton");

         const currentModel = "rinna/japanese-gpt2-small";
     let apiToken = localStorage.getItem("huggingface_api_token") || "";
     
     // フォールバック用の応答パターン
     const fallbackResponses = [
       "こんにちは！お元気ですか？",
       "なるほど、それは興味深いですね。",
       "もう少し詳しく教えてください。",
       "そうですね、確かにその通りかもしれません。",
       "ありがとうございます。他にも何かありますか？",
       "お疲れ様です。何かお手伝いできることはありますか？",
       "それは良いアイデアですね！",
       "確かに、その考えは面白いです。",
       "もっと詳しく聞かせてください。",
       "なるほど、理解しました。"
     ];

     // APIトークン入力欄の初期値を設定
     apiTokenInput.value = apiToken;

     // APIトークンを保存する
     saveButton.addEventListener("click", () => {
       apiToken = apiTokenInput.value.trim();
       localStorage.setItem("huggingface_api_token", apiToken);
       alert("APIトークンを保存しました。");
     });

    function addMessage(sender, text) {
      const div = document.createElement("div");
      div.classList.add("flex");
      if (sender === "user") {
        div.classList.add("justify-end");
        div.innerHTML = `<div class="text-white p-3 rounded-[16px] max-w-[80%] shadow-md" style="background: linear-gradient(135deg, #A5D6A7 0%, #2E7D32 100%);">${text}</div>`;
      } else {
        div.innerHTML = `<div class="bg-white p-3 rounded-[16px] max-w-[80%] shadow-sm border border-[#E8F5E9]">${text}</div>`;
      }
      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

         async function fetchAIResponse(message) {
       if (!apiToken) {
         // APIトークンがない場合はフォールバック応答
         const randomResponse = fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
         addMessage("assistant", randomResponse);
         return;
       }

      try {
        const response = await fetch(`https://api-inference.huggingface.co/models/${currentModel}`, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${apiToken}`,
            "Content-Type": "application/json"
          },
                     body: JSON.stringify({
             inputs: message,
             parameters: {
               max_length: 100,
               temperature: 0.7,
               do_sample: true,
               top_p: 0.9
             }
           })
        });

        if (!response.ok) {
          // APIエラーの場合はフォールバック応答
          const randomResponse = fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
          addMessage("assistant", randomResponse);
          return;
        }
        
        const data = await response.json();
        const aiResponse = data.generated_text || data[0]?.generated_text || "応答なし";
        addMessage("assistant", aiResponse);

      } catch (err) {
        // ネットワークエラーの場合もフォールバック応答
        const randomResponse = fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
        addMessage("assistant", randomResponse);
      }
    }

    sendButton.addEventListener("click", () => {
      const msg = userInput.value.trim();
      if (!msg) return;
      addMessage("user", msg);
      fetchAIResponse(msg);
      userInput.value = "";
    });

    userInput.addEventListener("keypress", e => {
      if (e.key === "Enter") sendButton.click();
    });
  </script>
</body>
</html>
