<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="ã‚¯ã‚¤ã‚ºçµæœ">ã‚¯ã‚¤ã‚ºçµæœ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
         <link rel="stylesheet" href="maintab.css">
     <style>
       /* å­¦ç¿’é€²æ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
       .progress-section {
         margin: 40px 0;
         padding: 30px;
         background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
         border-radius: 20px;
         color: white;
         box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
       }
       
       .progress-section h2 {
         text-align: center;
         margin-bottom: 30px;
         font-size: 2em;
         font-weight: 300;
         text-shadow: 0 2px 4px rgba(0,0,0,0.3);
       }
       
       .progress-grid {
         display: grid;
         grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
         gap: 25px;
         margin-top: 30px;
       }
       
       .progress-card {
         background: rgba(255, 255, 255, 0.1);
         backdrop-filter: blur(10px);
         border-radius: 15px;
         padding: 25px;
         text-align: center;
         border: 1px solid rgba(255, 255, 255, 0.2);
         transition: all 0.3s ease;
       }
       
       .progress-card:hover {
         transform: translateY(-5px);
         background: rgba(255, 255, 255, 0.15);
         box-shadow: 0 15px 35px rgba(0,0,0,0.2);
       }
       
       .progress-icon {
         font-size: 3em;
         margin-bottom: 15px;
         display: block;
       }
       
       .progress-card h3 {
         margin: 0 0 15px 0;
         font-size: 1.1em;
         font-weight: 500;
         opacity: 0.9;
       }
       
       .progress-value {
         font-size: 2.5em;
         font-weight: bold;
         margin-bottom: 20px;
         text-shadow: 0 2px 4px rgba(0,0,0,0.3);
       }
       
       .progress-bar {
         width: 100%;
         height: 8px;
         background: rgba(255, 255, 255, 0.2);
         border-radius: 4px;
         overflow: hidden;
       }
       
       .progress-fill {
         height: 100%;
         background: linear-gradient(90deg, #4CAF50, #8BC34A);
         border-radius: 4px;
         transition: width 1s ease, background-color 0.5s ease;
         width: 0%;
       }
       
       /* ã‚¹ã‚³ã‚¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
       .scores-section {
         margin: 40px 0;
         padding: 30px;
         background: #f8f9fa;
         border-radius: 20px;
         box-shadow: 0 5px 20px rgba(0,0,0,0.08);
       }
       
       .scores-section h2 {
         text-align: center;
         margin-bottom: 30px;
         color: #333;
         font-size: 2em;
         font-weight: 300;
       }
       
       /* ã‚¹ã‚³ã‚¢ã‚«ãƒ¼ãƒ‰ */
       .score-card {
         background: white;
         border-radius: 15px;
         padding: 25px;
         margin-bottom: 20px;
         box-shadow: 0 5px 20px rgba(0,0,0,0.08);
         border: 1px solid #e9ecef;
         transition: all 0.3s ease;
         position: relative;
         overflow: hidden;
       }
       
       .score-card:hover {
         transform: translateY(-3px);
         box-shadow: 0 10px 30px rgba(0,0,0,0.15);
       }
       
       .score-card.best-score {
         border: 2px solid #ffd700;
         background: linear-gradient(135deg, #fff9c4 0%, #ffffff 100%);
         box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
       }
       
       .score-card-header {
         display: flex;
         justify-content: space-between;
         align-items: center;
         margin-bottom: 20px;
         padding-bottom: 15px;
         border-bottom: 2px solid #f0f0f0;
       }
       
       .score-card-date {
         display: flex;
         align-items: center;
         color: #666;
         font-size: 0.9em;
       }
       
       .date-icon {
         margin-right: 8px;
         font-size: 1.2em;
       }
       
       .score-card-rank {
         display: flex;
         gap: 10px;
       }
       
       .rank-badge {
         padding: 6px 12px;
         border-radius: 20px;
         font-size: 0.8em;
         font-weight: bold;
         text-transform: uppercase;
         letter-spacing: 0.5px;
       }
       
       .rank-s { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #b8860b; }
       .rank-a { background: linear-gradient(135deg, #c0c0c0, #e5e5e5); color: #666; }
       .rank-b { background: linear-gradient(135deg, #cd7f32, #daa520); color: #8b4513; }
       .rank-c { background: linear-gradient(135deg, #ff6b6b, #ff8e8e); color: #c41e3a; }
       .rank-d { background: linear-gradient(135deg, #6c757d, #868e96); color: #495057; }
       
       .score-card-body {
         display: grid;
         grid-template-columns: 1fr 1fr;
         gap: 25px;
         align-items: center;
       }
       
       .score-card-main {
         text-align: center;
       }
       
       .score-accuracy, .score-correct {
         margin-bottom: 20px;
       }
       
       .accuracy-label, .correct-label {
         display: block;
         font-size: 0.9em;
         color: #666;
         margin-bottom: 5px;
         text-transform: uppercase;
         letter-spacing: 0.5px;
       }
       
       .accuracy-value {
         display: block;
         font-size: 2.5em;
         font-weight: bold;
         color: #1976d2;
       }
       
       .correct-value {
         display: block;
         font-size: 1.8em;
         font-weight: bold;
         color: #4caf50;
       }
       
       .score-card-details {
         display: flex;
         flex-direction: column;
         gap: 15px;
       }
       
       .detail-item {
         display: flex;
         align-items: center;
         gap: 10px;
         padding: 10px;
         background: #f8f9fa;
         border-radius: 8px;
       }
       
       .detail-icon {
         font-size: 1.2em;
       }
       
       .detail-label {
         font-weight: 500;
         color: #666;
         min-width: 80px;
       }
       
       .detail-value {
         font-weight: 600;
         color: #333;
       }
       
       .best-score-badge {
         position: absolute;
         top: 15px;
         right: 15px;
         background: linear-gradient(135deg, #ffd700, #ffed4e);
         color: #b8860b;
         padding: 8px 15px;
         border-radius: 20px;
         font-size: 0.8em;
         font-weight: bold;
         box-shadow: 0 3px 10px rgba(255, 215, 0, 0.3);
         animation: pulse 2s infinite;
       }
       
       @keyframes pulse {
         0% { transform: scale(1); }
         50% { transform: scale(1.05); }
         100% { transform: scale(1); }
       }
       
       /* ã‚¹ã‚³ã‚¢ãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
       .no-scores-message {
         text-align: center;
         padding: 60px 20px;
         color: #666;
       }
       
       .no-scores-icon {
         font-size: 4em;
         margin-bottom: 20px;
         opacity: 0.5;
       }
       
       .no-scores-message h3 {
         margin: 0 0 15px 0;
         color: #333;
         font-size: 1.5em;
         font-weight: 300;
       }
       
       .no-scores-message p {
         margin: 0;
         font-size: 1.1em;
         line-height: 1.6;
       }
       
       /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
       @media (max-width: 768px) {
         .progress-grid {
           grid-template-columns: 1fr;
           gap: 20px;
         }
         
         .score-card-body {
           grid-template-columns: 1fr;
           gap: 20px;
         }
         
         .score-card-header {
           flex-direction: column;
           gap: 15px;
           align-items: flex-start;
         }
         
         .progress-section, .scores-section {
           padding: 20px;
           margin: 20px 0;
         }
       }
     </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- ç¿»è¨³æ©Ÿèƒ½ -->
    <script src="translation.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 data-translate="åŒ»ç™‚æƒ…å ±ç®¡ç†ã‚¢ãƒ—ãƒª">åŒ»ç™‚æƒ…å ±ç®¡ç†ã‚¢ãƒ—ãƒª</h1>
    </div>
      
    <div class="tab-container">
        <div class="tab-header">
         
          <button class="tab-button" onclick="location.href='ai.html'">
            <span class="tab-icon">ğŸ’¬</span>
            <span class="tab-text" data-translate="ãƒãƒ£ãƒƒãƒˆ">ãƒãƒ£ãƒƒãƒˆ</span>
          </button>
          <button class="tab-button active" onclick="location.href='score.html'">
            <span class="tab-icon">â“</span>
            <span class="tab-text" data-translate="Q&A">Q&A</span>
          </button>
          <button class="tab-button" onclick="location.href='movie.html'">
            <span class="tab-icon">ğŸ¬</span>
            <span class="tab-text" data-translate="å‹•ç”»è¦–è´">å‹•ç”»è¦–è´</span>
          </button>
          <button class="tab-button" onclick="location.href='profile.html'">
            <span class="tab-icon">ğŸ‘¤</span>
            <span class="tab-text" data-translate="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</span>
          </button>
        </div>
    </div>
    <!-- ã‚¯ã‚¤ã‚ºã®ã‚¹ã‚³ã‚¢è¡¨ç¤ºã¨ãƒ©ãƒ³ã‚¯è¡¨ç¤ºã®ç”»é¢ -->
    <!-- ã‚¯ã‚¤ã‚ºã®ã‚¹ã‚³ã‚¢ã¨ãƒ©ãƒ³ã‚¯ã‚’firebaseã®movie_quiz_scoresã‹ã‚‰åæ˜ ã™ã‚‹ç”»é¢ -->

         <div class="stats-container">
         <div class="stats-card">
             <h2 data-translate="ã‚¯ã‚¤ã‚ºæˆç¸¾æ¨ç§»">ã‚¯ã‚¤ã‚ºæˆç¸¾æ¨ç§»</h2>
             <div class="chart-container">
                 <canvas id="movieScoreChart"></canvas>
             </div>
         </div>
     </div>

     <!-- ã‚¯ã‚¤ã‚ºé–‹å§‹ãƒœã‚¿ãƒ³ -->
     <div style="text-align: center; margin: 30px 0;">
                   <button onclick="location.href='allq&a.html'" class="quiz-btn" style="
             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
             color: white;
             border: none;
             padding: 15px 30px;
             font-size: 1.2em;
             border-radius: 25px;
             cursor: pointer;
             box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
             transition: all 0.3s ease;
             font-weight: bold;
         " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.6)'" 
         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)'">
             ğŸ¯ ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹ã™ã‚‹
         </button>
         <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
             æ–°ã—ã„ã‚¯ã‚¤ã‚ºã«æŒ‘æˆ¦ã—ã¦ã€æˆç¸¾ã‚’æ›´æ–°ã—ã¾ã—ã‚‡ã†ï¼
         </p>
     </div>

           <!-- å­¦ç¿’é€²æ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="progress-section">
        <h2 data-translate="å­¦ç¿’é€²æ—">å­¦ç¿’é€²æ—</h2>
        <div class="progress-grid">
          <div class="progress-card">
            <div class="progress-icon">ğŸ“š</div>
            <h3>å­¦ç¿’ç¶™ç¶šæ—¥æ•°</h3>
            <div class="progress-value" id="learning-days">0æ—¥</div>
            <div class="progress-bar">
              <div class="progress-fill" id="learning-days-bar"></div>
            </div>
          </div>
          
          <div class="progress-card">
            <div class="progress-icon">ğŸ¯</div>
            <h3>ç›®æ¨™é”æˆç‡</h3>
            <div class="progress-value" id="goal-achievement">0%</div>
            <div class="progress-bar">
              <div class="progress-fill" id="goal-achievement-bar"></div>
            </div>
          </div>
          
          <div class="progress-card">
            <div class="progress-icon">ğŸ”¥</div>
            <h3>é€£ç¶šæ­£è§£</h3>
            <div class="progress-value" id="streak">0å•</div>
            <div class="progress-bar">
              <div class="progress-fill" id="streak-bar"></div>
            </div>
          </div>
          
          <div class="progress-card">
            <div class="progress-icon">â­</div>
            <h3>ãƒ¬ãƒ™ãƒ«</h3>
            <div class="progress-value" id="level">åˆå¿ƒè€…</div>
            <div class="progress-bar">
              <div class="progress-fill" id="level-bar"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div class="scores-section">
        <h2 data-translate="ã‚¯ã‚¤ã‚ºå±¥æ­´">ã‚¯ã‚¤ã‚ºå±¥æ­´</h2>
        <div id="scores-container"></div>
      </div>
  </div>
  <script>
    // Firebaseã®è¨­å®š
    const firebaseConfig = {
        apiKey: "AIzaSyC31W-TEE7mIBGFwrRxJAuPugjnEFfWe_k",
        authDomain: "web01-2484d.firebaseapp.com",
        projectId: "web01-2484d",
        storageBucket: "web01-2484d.appspot.com",
        messagingSenderId: "90159472898",
        appId: "1:90159472898:web:261ec71f9919611011e21b"
    };
    firebase.initializeApp(firebaseConfig);

    let movieScoreChart = null;

    // å‹•ç”»ã‚¯ã‚¤ã‚ºã‚¹ã‚³ã‚¢ã‚’å–å¾—
    async function loadMovieScores(userId) {
      try {
        const db = firebase.firestore();
        const snapshot = await db.collection('movie_quiz_scores')
          .where('userId', '==', userId)
          .orderBy('timestamp', 'desc')
          .get();
        
        const scores = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          scores.push({
            ...data,
            id: doc.id,
            quizType: 'movie'
          });
        });
        
        return scores;
      } catch (e) {
        console.error("å‹•ç”»ã‚¯ã‚¤ã‚ºã‚¹ã‚³ã‚¢ã®å–å¾—ã«å¤±æ•—:", e);
        return [];
      }
    }

    // AIã‚¯ã‚¤ã‚ºã‚¹ã‚³ã‚¢ã‚’å–å¾—
    async function loadAIQuizScores(userId) {
      try {
        console.log("loadAIQuizScoresé–‹å§‹ - userId:", userId);
        const db = firebase.firestore();
        
        // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼ã‚’é¿ã‘ã‚‹ãŸã‚ã€orderByã‚’ä¸€æ™‚çš„ã«å‰Šé™¤
        console.log("ai_quiz_scoresã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ã‚¯ã‚¨ãƒªå®Ÿè¡Œä¸­...");
        const snapshot = await db.collection('ai_quiz_scores')
          .where('userId', '==', userId)
          .get();
        
        console.log("ã‚¯ã‚¨ãƒªçµæœ - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°:", snapshot.size);
        
        const scores = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          console.log("ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿:", doc.id, data);
          scores.push({
            ...data,
            id: doc.id,
            quizType: 'ai'
          });
        });
        
        console.log("å‡¦ç†å‰ã®ã‚¹ã‚³ã‚¢é…åˆ—:", scores);
        
        // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã‚½ãƒ¼ãƒˆ
        scores.sort((a, b) => {
          const ta = a.timestamp && typeof a.timestamp.toDate === "function" 
            ? a.timestamp.toDate() 
            : new Date(a.timestamp);
          const tb = b.timestamp && typeof b.timestamp.toDate === "function" 
            ? b.timestamp.toDate() 
            : new Date(b.timestamp);
          return tb - ta; // é™é †
        });
        
        console.log("ã‚½ãƒ¼ãƒˆå¾Œã®ã‚¹ã‚³ã‚¢é…åˆ—:", scores);
        return scores;
      } catch (e) {
        console.error("AIã‚¯ã‚¤ã‚ºã‚¹ã‚³ã‚¢ã®å–å¾—ã«å¤±æ•—:", e);
        return [];
      }
    }

    // AIã‚¯ã‚¤ã‚ºã‚¹ã‚³ã‚¢ã®ã¿ã‚’å–å¾—ã—ã€ã‚°ãƒ©ãƒ•ã¨ã‚«ãƒ¼ãƒ‰ã«åæ˜ 
    async function loadAIQuizScoresOnly(userId) {
      try {
        console.log("AIã‚¯ã‚¤ã‚ºã‚¹ã‚³ã‚¢ã‚’å–å¾—ä¸­...");
        const aiScores = await loadAIQuizScores(userId);
        console.log("å–å¾—ã•ã‚ŒãŸAIã‚¯ã‚¤ã‚ºã‚¹ã‚³ã‚¢:", aiScores);
        
        if (aiScores.length === 0) {
          console.log("AIã‚¯ã‚¤ã‚ºã‚¹ã‚³ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“");
          updateMovieScoreChart([]);
          renderMovieScores([]);
          return;
        }
        
        console.log(`${aiScores.length}ä»¶ã®AIã‚¯ã‚¤ã‚ºã‚¹ã‚³ã‚¢ã‚’å‡¦ç†ä¸­...`);
        updateMovieScoreChart(aiScores);
        renderMovieScores(aiScores);
        updateStatistics(aiScores);
        
      } catch (e) {
        console.error("AIã‚¯ã‚¤ã‚ºã‚¹ã‚³ã‚¢ã®å–å¾—ã«å¤±æ•—:", e);
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤º
        const scoresContainer = document.getElementById('scores-container');
        if (scoresContainer) {
          scoresContainer.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #666;">
              <p>AIã‚¯ã‚¤ã‚ºã®çµæœã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚</p>
              <p>ã‚¨ãƒ©ãƒ¼: ${e.message}</p>
              <p>ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
          `;
        }
        updateMovieScoreChart([]);
        renderMovieScores([]);
      }
    }

    // æ­£ç­”ç‡ã‹ã‚‰ãƒ©ãƒ³ã‚¯ã‚’åˆ¤å®šï¼ˆå€‹åˆ¥ã‚¯ã‚¤ã‚ºã®ãƒ©ãƒ³ã‚¯è¡¨ç¤ºç”¨ï¼‰
    function getRank(accuracy) {
      if (accuracy === null || accuracy === undefined) return { label: 'N/A', class: 'rank-d' };
      if (accuracy >= 90) return { label: 'S', class: 'rank-s' };
      if (accuracy >= 80) return { label: 'A', class: 'rank-a' };
      if (accuracy >= 60) return { label: 'B', class: 'rank-b' };
      if (accuracy >= 40) return { label: 'C', class: 'rank-c' };
      return { label: 'D', class: 'rank-d' };
    }

    // ã‚¯ã‚¤ã‚ºæˆç¸¾æ¨ç§»ã‚°ãƒ©ãƒ•
    function updateMovieScoreChart(scores) {
      const ctx = document.getElementById('movieScoreChart').getContext('2d');
      if (movieScoreChart) movieScoreChart.destroy();
      
      if (!scores || scores.length === 0) {
        movieScoreChart = new Chart(ctx, {
          type: 'line',
          data: { 
            labels: [], 
            datasets: [
              { label: 'æ­£ç­”ç‡', data: [] },
              { label: 'æ­£è§£æ•°', data: [] }
            ] 
          },
          options: { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: 'ã‚¯ã‚¤ã‚ºæˆç¸¾æ¨ç§»'
              }
            }
          }
        });
        return;
      }
      
      // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
      const sortedScores = scores.slice().sort((a, b) => {
        const ta = a.timestamp && typeof a.timestamp.toDate === "function" 
          ? a.timestamp.toDate() 
          : new Date(a.timestamp);
        const tb = b.timestamp && typeof b.timestamp.toDate === "function" 
          ? b.timestamp.toDate() 
          : new Date(b.timestamp);
        return ta - tb;
      });
      
      const labels = sortedScores.map(score => {
        let d = score.timestamp && typeof score.timestamp.toDate === "function"
          ? score.timestamp.toDate()
          : new Date(score.timestamp);
        return d.toLocaleDateString('ja-JP');
      });
      
      const accuracyData = sortedScores.map(score => parseFloat(score.accuracy) || 0);
      const correctData = sortedScores.map(score => score.correct || 0);

      movieScoreChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'æ­£ç­”ç‡ (%)',
              data: accuracyData,
              borderColor: '#4D8CFF',
              backgroundColor: 'rgba(77, 140, 255, 0.1)',
              tension: 0.4,
              fill: true,
              yAxisID: 'y'
            },
            {
              label: 'æ­£è§£æ•°',
              data: correctData,
              borderColor: '#FF6B6B',
              backgroundColor: 'rgba(255, 107, 107, 0.1)',
              tension: 0.4,
              fill: false,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            title: {
              display: true,
              text: 'ã‚¯ã‚¤ã‚ºæˆç¸¾æ¨ç§»'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  if (context.dataset.label === 'æ­£ç­”ç‡ (%)') {
                    return `æ­£ç­”ç‡: ${context.parsed.y}%`;
                  } else {
                    return `æ­£è§£æ•°: ${context.parsed.y}å•`;
                  }
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'æ—¥ä»˜'
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: 'æ­£ç­”ç‡ (%)'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              beginAtZero: true,
              title: {
                display: true,
                text: 'æ­£è§£æ•°'
              },
              grid: {
                drawOnChartArea: false,
              },
            }
          }
        }
      });
    }

         // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
     function updateStatistics(scores) {
       console.log("updateStatisticsé–‹å§‹ - scores:", scores);
       if (!scores || scores.length === 0) {
         console.log("çµ±è¨ˆæƒ…å ±æ›´æ–°: ã‚¹ã‚³ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“");
         return;
       }
       
       const totalQuizzes = scores.length;
       const totalCorrect = scores.reduce((sum, score) => sum + (score.correct || 0), 0);
       const totalQuestions = scores.reduce((sum, score) => sum + (score.total || 0), 0);
       const averageAccuracy = scores.reduce((sum, score) => sum + (parseFloat(score.accuracy) || 0), 0) / totalQuizzes;
       
       console.log("çµ±è¨ˆè¨ˆç®—çµæœ:", {
         totalQuizzes,
         totalCorrect,
         totalQuestions,
         averageAccuracy
       });
       
       // çµ±è¨ˆã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
       const statsContainer = document.querySelector('.stats-container');
       if (statsContainer) {
         const existingStats = statsContainer.querySelector('.stats-summary');
         if (existingStats) {
           existingStats.remove();
         }
         
         const statsSummary = document.createElement('div');
         statsSummary.className = 'stats-summary';
         statsSummary.innerHTML = `
           <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
             <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 20px; text-align: center;">
               <h3 style="margin: 0 0 10px 0; color: #1976d2;">ç·ã‚¯ã‚¤ã‚ºæ•°</h3>
               <p style="font-size: 2em; font-weight: bold; margin: 0; color: #1976d2;">${totalQuizzes}</p>
             </div>
             <div style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 8px; padding: 20px; text-align: center;">
               <h3 style="margin: 0 0 10px 0; color: #388e3c;">ç·æ­£è§£æ•°</h3>
               <p style="font-size: 2em; font-weight: bold; margin: 0; color: #388e3c;">${totalCorrect}</p>
             </div>
             <div style="background: #fff3e0; border: 1px solid #ff9800; border-radius: 8px; padding: 20px; text-align: center;">
               <h3 style="margin: 0 0 10px 0; color: #f57c00;">ç·å•é¡Œæ•°</h3>
               <p style="font-size: 2em; font-weight: bold; margin: 0; color: #f57c00;">${totalQuestions}</p>
             </div>
             <div style="background: #fce4ec; border: 1px solid #e91e63; border-radius: 8px; padding: 20px; text-align: center;">
               <h3 style="margin: 0 0 10px 0; color: #c2185b;">å¹³å‡æ­£ç­”ç‡</h3>
               <p style="font-size: 2em; font-weight: bold; margin: 0; color: #c2185b;">${averageAccuracy.toFixed(1)}%</p>
             </div>
           </div>
         `;
         
         statsContainer.appendChild(statsSummary);
         console.log("çµ±è¨ˆæƒ…å ±ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã—ãŸ");
       } else {
         console.log("statsContainerãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
       }
       
       // å­¦ç¿’é€²æ—ã‚’æ›´æ–°
       updateLearningProgress(scores);
     }
     
     // å­¦ç¿’é€²æ—ã‚’æ›´æ–°
     function updateLearningProgress(scores) {
       if (!scores || scores.length === 0) return;
       
       // å­¦ç¿’ç¶™ç¶šæ—¥æ•°ã‚’è¨ˆç®—
       const uniqueDates = [...new Set(scores.map(score => {
         const date = score.timestamp && typeof score.timestamp.toDate === "function" 
           ? score.timestamp.toDate() 
           : new Date(score.timestamp);
         return date.toDateString();
       }))];
       const learningDays = uniqueDates.length;
       
       // ç›®æ¨™é”æˆç‡ã‚’è¨ˆç®—ï¼ˆ80%ä»¥ä¸Šã‚’ç›®æ¨™ã¨ã™ã‚‹ï¼‰
       const highAccuracyQuizzes = scores.filter(score => (parseFloat(score.accuracy) || 0) >= 80);
       const goalAchievement = Math.round((highAccuracyQuizzes.length / scores.length) * 100);
       
       // é€£ç¶šæ­£è§£æ•°ã‚’è¨ˆç®—
       let currentStreak = 0;
       let maxStreak = 0;
       for (let i = scores.length - 1; i >= 0; i--) {
         if ((parseFloat(scores[i].accuracy) || 0) >= 60) {
           currentStreak++;
           maxStreak = Math.max(maxStreak, currentStreak);
         } else {
           currentStreak = 0;
         }
       }
       
                // ãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®—
         let level = "åˆå¿ƒè€…";
         let levelProgress = 0;
         const avgAccuracy = scores.reduce((sum, score) => sum + (parseFloat(score.accuracy) || 0), 0) / scores.length;
         if (scores.length >= 10 && avgAccuracy >= 80) {
           level = "ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ";
           levelProgress = 100;
         } else if (scores.length >= 5 && avgAccuracy >= 60) {
           level = "ä¸­ç´šè€…";
           levelProgress = Math.min(100, (scores.length / 10) * 100);
         } else {
           level = "åˆå¿ƒè€…";
           levelProgress = Math.min(100, (scores.length / 5) * 100);
         }
       
       // é€²æ—ãƒãƒ¼ã‚’æ›´æ–°
       updateProgressBar('learning-days', learningDays, 30, 'æ—¥');
       updateProgressBar('goal-achievement', goalAchievement, 100, '%');
       updateProgressBar('streak', maxStreak, 20, 'å•');
       updateProgressBar('level', levelProgress, 100, '%');
       
       // ãƒ¬ãƒ™ãƒ«è¡¨ç¤ºã‚’æ›´æ–°
       document.getElementById('level').textContent = level;
     }
     
     // é€²æ—ãƒãƒ¼ã‚’æ›´æ–°
     function updateProgressBar(elementId, current, max, unit) {
       const element = document.getElementById(elementId);
       const bar = document.getElementById(elementId + '-bar');
       
       if (element && bar) {
         element.textContent = current + unit;
         const percentage = Math.min(100, (current / max) * 100);
         bar.style.width = percentage + '%';
         
         // è‰²ã‚’å‹•çš„ã«å¤‰æ›´
         if (percentage >= 80) {
           bar.style.backgroundColor = '#4CAF50';
         } else if (percentage >= 60) {
           bar.style.backgroundColor = '#FF9800';
         } else {
           bar.style.backgroundColor = '#F44336';
         }
       }
     }

         // ã‚¯ã‚¤ã‚ºã‚¹ã‚³ã‚¢ã‚«ãƒ¼ãƒ‰æç”»
     function renderMovieScores(scores) {
       console.log("renderMovieScoresé–‹å§‹ - scores:", scores);
       const scoresContainer = document.getElementById('scores-container');
       
       if (!scoresContainer) {
         console.error("scores-containerè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
         return;
       }
       
       if (!scores || scores.length === 0) {
         console.log("ã‚¹ã‚³ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“ - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º");
         scoresContainer.innerHTML = `
           <div class="no-scores-message">
             <div class="no-scores-icon">ğŸ“š</div>
             <h3>ã¾ã ã‚¯ã‚¤ã‚ºã®çµæœãŒã‚ã‚Šã¾ã›ã‚“</h3>
             <p>æ–°ã—ã„ã‚¯ã‚¤ã‚ºã«æŒ‘æˆ¦ã—ã¦ã€å­¦ç¿’ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼</p>
           </div>
         `;
         return;
       }
       
       console.log(`${scores.length}ä»¶ã®ã‚¹ã‚³ã‚¢ã‚«ãƒ¼ãƒ‰ã‚’æç”»ä¸­...`);
       scoresContainer.innerHTML = '';
       
       // ãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢ã‚’æ¢ã™
       const bestScore = scores.reduce((best, current) =>
         (parseFloat(current.accuracy) || 0) > (parseFloat(best.accuracy) || 0) ? current : best
       );
       
       console.log("ãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢:", bestScore);
       
       scores.forEach((score, index) => {
         console.log(`ã‚¹ã‚³ã‚¢ã‚«ãƒ¼ãƒ‰${index + 1}ã‚’å‡¦ç†ä¸­:`, score);
         
         const scoreCard = document.createElement('div');
         scoreCard.className = 'score-card';
         
         let dateObj;
         if (score.timestamp && typeof score.timestamp.toDate === 'function') {
           dateObj = score.timestamp.toDate();
         } else {
           dateObj = new Date(score.timestamp);
         }
         const formattedDate = dateObj.toLocaleString('ja-JP');
         const rank = getRank(parseFloat(score.accuracy) || 0);
         
         if (score === bestScore) {
           scoreCard.classList.add('best-score');
         }
         
         scoreCard.innerHTML = `
           <div class="score-card-header">
             <div class="score-card-date">
               <span class="date-icon">ğŸ“…</span>
               ${formattedDate}
             </div>
             <div class="score-card-rank">
               <span class="rank-badge ${rank.class}">${rank.label}ãƒ©ãƒ³ã‚¯</span>
             </div>
           </div>
           
           <div class="score-card-body">
             <div class="score-card-main">
               <div class="score-accuracy">
                 <span class="accuracy-label">æ­£ç­”ç‡</span>
                 <span class="accuracy-value">${(parseFloat(score.accuracy) || 0).toFixed(1)}%</span>
               </div>
               <div class="score-correct">
                 <span class="correct-label">æ­£è§£æ•°</span>
                 <span class="correct-value">${score.correct || 0} / ${score.total || 0}</span>
               </div>
             </div>
             
             <div class="score-card-details">
               <div class="detail-item">
                 <span class="detail-icon">ğŸ¯</span>
                 <span class="detail-label">ã‚«ãƒ†ã‚´ãƒª:</span>
                 <span class="detail-value">${score.category || 'ä¸æ˜'}</span>
               </div>
               <div class="detail-item">
                 <span class="detail-icon">ğŸ¤–</span>
                 <span class="detail-label">ã‚¯ã‚¤ã‚ºç¨®åˆ¥:</span>
                 <span class="detail-value">AIã‚¯ã‚¤ã‚º</span>
               </div>
             </div>
           </div>
           
           ${score === bestScore ? '<div class="best-score-badge">ğŸ† ãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢</div>' : ''}
         `;
         scoresContainer.appendChild(scoreCard);
         console.log(`ã‚¹ã‚³ã‚¢ã‚«ãƒ¼ãƒ‰${index + 1}ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
       });
       
       console.log("å…¨ã¦ã®ã‚¹ã‚³ã‚¢ã‚«ãƒ¼ãƒ‰ã®æç”»ãŒå®Œäº†ã—ã¾ã—ãŸ");
     }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªã—ã€ã‚¹ã‚³ã‚¢ã‚’åæ˜ 
    firebase.auth().onAuthStateChanged(user => {
      console.log("èªè¨¼çŠ¶æ…‹å¤‰æ›´:", user ? `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${user.uid}` : "æœªãƒ­ã‚°ã‚¤ãƒ³");
      if (user) {
        console.log("ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:", user.uid);
        loadAIQuizScoresOnly(user.uid);
      } else {
        console.log("ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ");
        window.location.href = 'login.html';
      }
    });
  </script>
</body>
</html>

