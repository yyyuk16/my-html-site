<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-translate="quiz_results">ã‚¯ã‚¤ã‚ºçµæœ</title>

  <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
  <script>
    // Plotly.jsã®èª­ã¿è¾¼ã¿ç¢ºèª
    window.addEventListener('load', function() {
      if (typeof Plotly === 'undefined') {
        console.error('Plotly.js ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚CDNã‹ã‚‰èª­ã¿è¾¼ã‚ãªã‹ã£ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
      } else {
        console.log('Plotly.js ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸã€‚');
      }
    });
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- å…±é€šCSSï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼/ã‚¿ãƒ–/ãƒ•ãƒƒã‚¿ãƒ¼ã¯ã“ã“ã§çµ±ä¸€ï¼‰ -->
  <link rel="stylesheet" href="hetter.css">
  <link rel="stylesheet" href="footer.css">

  <style>
    /* ===========================================
      âœ… æ³¨æ„ï¼šã“ã®<style>ã«ã¯
      ãƒ˜ãƒƒãƒ€ãƒ¼(.top-bar / .logo / .tab-menu)ã¨
      ãƒ•ãƒƒã‚¿ãƒ¼(.footer)ã®ä¸Šæ›¸ãã¯å…¥ã‚Œã¦ã„ã¾ã›ã‚“
      â†’ maintab.css / footer.css ã«çµ±ä¸€
    ============================================ */

    html, body {
      margin: 0;
      padding: 0;
    }
    body {
      background: #fff !important;
      min-height: 100vh;
      font-family: 'Noto Sans JP', 'Segoe UI', 'Hiragino Sans', 'Meiryo', sans-serif;
      color: #222;
    }

    /* ====== ã“ã“ã‹ã‚‰ä¸‹ã¯ â€œã‚³ãƒ³ãƒ†ãƒ³ãƒ„å°‚ç”¨â€ ã®ã‚¹ã‚¿ã‚¤ãƒ« ====== */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px 16px 24px 16px;
    }

    /* ã‚¯ã‚¤ã‚ºç”Ÿæˆã¨ã‚¹ã‚³ã‚¢è¡¨ç¤ºã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .quiz-score-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin: 20px 0;
    }

    .chat-quiz-section {
      padding: 20px 16px;
      background: #E8F5E9;
      border-radius: 18px;
      box-shadow: 0 4px 16px rgba(46, 125, 50, 0.2);
      border: 2px solid #fff;
    }
    
    .chat-quiz-section h2 {
      color: #2E7D32;
    }

    @media (max-width: 1024px) {
      .quiz-score-layout {
        grid-template-columns: 1fr;
        gap: 20px;
      }
    }

    .stats-container {
      margin-bottom: 20px;
    }
    .stats-card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 24px rgba(60, 72, 88, 0.08);
      padding: 32px 24px 24px 24px;
      border: 1px solid #e3e8ee;
    }
    .stats-card h2 {
      text-align: center;
      font-size: 1.5em;
      font-weight: 600;
      color: #4f4f4f;
      margin-bottom: 16px;
      letter-spacing: 0.05em;
    }
    .chart-container {
      background: #f7fafd;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 12px rgba(60, 72, 88, 0.06);
      border: 1px solid #e3e8ee;
      margin: 16px 0;
      min-height: 340px;
    }
    .stats-summary {
      margin-top: 18px;
    }
    .stats-summary > div {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
    }
    .stats-summary .stat-box {
      background: #f8fafc;
      border-radius: 12px;
      border: 2px solid #e3e8ee;
      padding: 20px 12px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(60, 72, 88, 0.1);
      transition: all 0.3s ease;
    }
    .stats-summary .stat-box:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(60, 72, 88, 0.15);
      border-color: #6c63ff;
    }
    .stats-summary .stat-title {
      color: #6c63ff;
      font-size: 1em;
      margin-bottom: 8px;
      font-weight: 600;
    }
    .stats-summary .stat-value {
      font-size: 2em;
      font-weight: bold;
      color: #6c63ff;
    }

    .quiz-btn {
      background: #4CAF50;
      color: #fff;
      border: none;
      padding: 15px 36px;
      font-size: 1.15em;
      border-radius: 28px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
      font-weight: bold;
      transition: all 0.3s ease;
    }
    .quiz-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(46, 125, 50, 0.4);
      background: #2E7D32;
    }
    .quiz-btn:active {
      transform: translateY(0);
    }

    /* Progress Section */
    .progress-section {
      margin: 24px 0;
      padding: 20px 16px;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 24px rgba(60, 72, 88, 0.08);
      color: #333;
      border: 1px solid #e3e8ee;
    }
    .progress-section h2 {
      text-align: center;
      margin-bottom: 16px;
      font-size: 1.3em;
      font-weight: 600;
      color: #4f4f4f;
      letter-spacing: 0.04em;
    }
    .progress-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 18px;
      margin-top: 10px;
    }
    .progress-card {
      background: #f8fafc;
      border-radius: 16px;
      padding: 20px 12px;
      text-align: center;
      border: 2px solid #e3e8ee;
      box-shadow: 0 4px 12px rgba(60, 72, 88, 0.1);
      transition: all 0.3s ease;
    }
    .progress-card:hover {
      box-shadow: 0 6px 20px rgba(60, 72, 88, 0.15);
      transform: translateY(-3px);
      border-color: #6c63ff;
    }
    .progress-icon {
      font-size: 2.5em;
      margin-bottom: 12px;
      display: block;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
      animation: bounce 2s infinite;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    .progress-card h3 {
      margin: 0 0 10px 0;
      font-size: 1em;
      font-weight: 500;
      color: #6c63ff;
      opacity: 0.95;
    }
    .progress-value {
      font-size: 2em;
      font-weight: bold;
      margin-bottom: 12px;
      color: #6c63ff;
    }
    .progress-bar {
      width: 100%;
      height: 7px;
      background: #e3e8ee;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: #6c63ff;
      border-radius: 4px;
      transition: width 1s cubic-bezier(.4,2,.6,1), background-color 0.5s;
      width: 0%;
    }

    /* Scores Section */
    .scores-section {
      margin: 0;
      padding: 20px 16px;
      background: #FFEBEE;
      border-radius: 18px;
      box-shadow: 0 4px 16px rgba(255, 107, 53, 0.2);
      border: 2px solid #fff;
    }
    .scores-section h2 {
      text-align: center;
      margin-bottom: 16px;
      color: #D84315;
      font-size: 1.3em;
      font-weight: 600;
      letter-spacing: 0.04em;
    }

    /* Score Card */
    .score-card {
      background: #f8fafc;
      border-radius: 12px;
      padding: 18px 10px;
      margin-bottom: 18px;
      box-shadow: 0 2px 10px rgba(60, 72, 88, 0.06);
      border: 1px solid #e3e8ee;
      transition: box-shadow 0.2s, transform 0.2s;
      position: relative;
      overflow: hidden;
    }
    .score-card:hover {
      box-shadow: 0 6px 18px rgba(76, 110, 245, 0.10);
      transform: translateY(-2px) scale(1.02);
    }
    .score-card.best-score {
      border: 2px solid #ffd700;
      background: linear-gradient(135deg, #fffbe7 0%, #f8fafc 100%);
      box-shadow: 0 8px 25px rgba(255, 215, 0, 0.13);
    }
    .score-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e3e8ee;
    }
    .score-card-date {
      display: flex;
      align-items: center;
      color: #888;
      font-size: 0.95em;
    }
    .date-icon {
      margin-right: 7px;
      font-size: 1.1em;
    }
    .score-card-rank {
      display: flex;
      gap: 8px;
    }
    .rank-badge {
      padding: 5px 10px;
      border-radius: 16px;
      font-size: 0.85em;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: #e3e8ee;
      color: #6c63ff;
    }
    .rank-s { background: #ffd700; color: #b8860b; }
    .rank-a { background: #c0c0c0; color: #666; }
    .rank-b { background: #cd7f32; color: #8b4513; }
    .rank-c { background: #ff6b6b; color: #c41e3a; }
    .rank-d { background: #6c757d; color: #495057; }
    
    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ©ãƒ³ã‚¯è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #user-rank-display.rank-s { 
      background: #FFD700; 
      color: #8B6914; 
      border: 4px solid #FFA500;
      box-shadow: 0 4px 16px rgba(255, 215, 0, 0.4);
    }
    #user-rank-display.rank-a { 
      background: #C0C0C0; 
      color: #4A4A4A; 
      border: 4px solid #A0A0A0;
      box-shadow: 0 4px 16px rgba(192, 192, 192, 0.3);
    }
    #user-rank-display.rank-b { 
      background: #CD7F32; 
      color: #5C3A1A; 
      border: 4px solid #B8860B;
      box-shadow: 0 4px 16px rgba(205, 127, 50, 0.3);
    }
    #user-rank-display.rank-c { 
      background: #FF6B6B; 
      color: #8B1A1A; 
      border: 4px solid #FF8E8E;
      box-shadow: 0 4px 16px rgba(255, 107, 107, 0.3);
    }
    #user-rank-display.rank-d { 
      background: #6c757d; 
      color: #2C2C2C; 
      border: 4px solid #868e96;
      box-shadow: 0 4px 16px rgba(108, 117, 125, 0.2);
    }
    .score-card-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      align-items: center;
    }
    .score-card-main {
      text-align: center;
    }
    .score-accuracy, .score-correct {
      margin-bottom: 12px;
    }
    .accuracy-label, .correct-label {
      display: block;
      font-size: 0.9em;
      color: #888;
      margin-bottom: 3px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .accuracy-value {
      display: block;
      font-size: 2em;
      font-weight: bold;
      color: #6c63ff;
    }
    .correct-value {
      display: block;
      font-size: 1.3em;
      font-weight: bold;
      color: #48c6ef;
    }
    .score-card-details {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .detail-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 0;
      background: #fff;
      border-radius: 6px;
    }
    .detail-icon {
      font-size: 1.1em;
    }
    .detail-label {
      font-weight: 500;
      color: #888;
      min-width: 70px;
    }
    .detail-value {
      font-weight: 600;
      color: #333;
    }
    .best-score-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      background: linear-gradient(135deg, #ffd700, #ffed4e);
      color: #b8860b;
      padding: 7px 13px;
      border-radius: 16px;
      font-size: 0.85em;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(255, 215, 0, 0.13);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .no-scores-message {
      text-align: center;
      padding: 50px 10px;
      color: #888;
    }
    .no-scores-icon {
      font-size: 3em;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    .no-scores-message h3 {
      margin: 0 0 10px 0;
      color: #4f4f4f;
      font-size: 1.2em;
      font-weight: 500;
    }
    .no-scores-message p {
      margin: 0;
      font-size: 1em;
      line-height: 1.6;
    }

    /* ãƒ•ãƒƒã‚¿ãƒ¼ã®è‰²ã‚’setting.htmlã¨çµ±ä¸€ */
    .footer {
      background: #2E7D32;
      color: #fff;
    }
    .footer small a {
      color: #fff;
    }

    /* ãƒ¢ãƒã‚¤ãƒ«ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆPCã§ã¯éè¡¨ç¤ºï¼‰ */
    .mobile-nav {
      display: none;
    }

    @media (max-width: 1024px) {
      .quiz-score-layout {
        grid-template-columns: 1fr;
        gap: 20px;
      }
    }

    @media (max-width: 768px) {
      /* PCç”¨ãƒŠãƒ“ã‚’éš ã™ */
      .tab-menu {
        display: none;
      }
      .header-right {
        display: none;
      }

      .container {
        padding: 12px 10px 20px 10px;
      }
      .quiz-score-layout {
        grid-template-columns: 1fr;
        gap: 12px;
        margin: 12px 0;
      }
      .progress-grid, .stats-summary > div {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      .score-card-body {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      .score-card-header {
        flex-direction: column;
        gap: 6px;
        align-items: flex-start;
        padding-bottom: 8px;
        margin-bottom: 10px;
      }
      .progress-section, .scores-section, .stats-card {
        padding: 16px 12px;
        margin: 12px 0;
        border-radius: 16px;
      }
      .chat-quiz-section {
        padding: 16px 12px;
        border-radius: 16px;
        margin: 0;
      }
      .scores-section {
        padding: 16px 12px;
        border-radius: 16px;
        margin: 16px 0;
      }
      .scores-section h2 {
        font-size: 1.1em;
        margin-bottom: 12px;
      }
      .chat-quiz-section h2 {
        font-size: 1.1em;
        margin-bottom: 12px;
      }
      .stats-bar {
        padding: 8px 0;
        margin: 0;
      }
      .stats-bar .container {
        padding: 0 8px !important;
      }
      .stats-bar-content {
        flex-direction: row;
        gap: 4px;
        padding: 0;
        flex-wrap: nowrap;
        justify-content: space-between;
      }
      .stat-pill {
        justify-content: center;
        flex: 1;
        min-width: 0;
        padding: 6px 4px !important;
        border-radius: 14px;
        font-size: 0.75em;
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 2px;
      }
      .stat-pill span {
        font-size: 0.8em !important;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        letter-spacing: -0.02em;
        line-height: 1.2;
      }
      .stat-pill span[style*="font-size: 1.2em"] {
        font-size: 1em !important;
        margin-right: 0 !important;
        margin-bottom: 1px;
      }
      .stat-pill span[style*="font-size: 0.9em"] {
        font-size: 0.65em !important;
        display: block;
        width: 100%;
        letter-spacing: -0.01em;
      }
      .stat-pill span[style*="font-size: 1.1em"] {
        font-size: 0.85em !important;
        font-weight: bold;
      }
      .stat-pill:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15) !important;
      }
      .chart-container {
        padding: 12px 10px;
        min-height: 260px;
        border-radius: 14px;
        margin: 10px 0;
      }
      .score-card {
        padding: 12px 10px;
        margin-bottom: 10px;
        border-radius: 12px;
      }
      .quiz-btn {
        padding: 12px 20px;
        font-size: 0.95em;
        border-radius: 22px;
        width: 100%;
        max-width: 100%;
      }
      .accuracy-value {
        font-size: 1.6em;
      }
      .correct-value {
        font-size: 1.1em;
      }
      .detail-item {
        padding: 6px 0;
        font-size: 0.9em;
      }

      .mobile-nav {
        display: flex;
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 70px;
        background: #f8f9fa;
        border-top: 1px solid #eee;
        justify-content: space-around;
        align-items: center;
        z-index: 1000;
        padding-bottom: env(safe-area-inset-bottom); /* iPhoneã®ãƒãƒ¼å¯¾ç­– */
      }

      .nav-item {
        text-decoration: none;
        color: #888;
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 0.7rem;
        gap: 4px;
      }

      .nav-item i {
        font-size: 1.4rem;
      }

      .nav-item.active {
        color: #333; /* é¸æŠä¸­ã®è‰² */
      }

      /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸‹éƒ¨ã«ä½™ç™½ã‚’è¿½åŠ ï¼ˆãƒŠãƒ“ã«è¢«ã‚‰ãªã„ã‚ˆã†ã«ï¼‰ */
      body {
        padding-bottom: 80px;
      }
      
      .container {
        padding-top: 1.5rem !important; /* ã‚¹ãƒãƒ›ã§ã¯ä½™ç™½ã‚’è©°ã‚ã‚‹ */
      }

      /* PCç‰ˆã®ãƒ•ãƒƒã‚¿ãƒ¼ã‚’ã‚¹ãƒãƒ›ã§ã¯éš ã™ï¼ˆãƒŠãƒ“ãŒã‚ã‚‹ãŸã‚ï¼‰ */
      .footer {
        display: none;
      }

      /* ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ãƒœã‚¿ãƒ³ï¼ˆãƒ¢ãƒã‚¤ãƒ«ç‰ˆã®ã¿ï¼‰ */
      .scroll-to-top {
        display: flex;
        position: fixed;
        bottom: 90px;
        right: 16px;
        width: 50px;
        height: 50px;
        background: #2E7D32;
        color: #fff;
        border: none;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
        cursor: pointer;
        align-items: center;
        justify-content: center;
        z-index: 999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
        font-size: 1.2rem;
      }
      .scroll-to-top.visible {
        opacity: 1;
        visibility: visible;
      }
      .scroll-to-top:hover {
        background: #1B5E20;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(46, 125, 50, 0.4);
      }
      .scroll-to-top:active {
        transform: translateY(0);
      }
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <!-- å¤šè¨€èªå¯¾å¿œ -->
  <script src="multilang.js"></script>
</head>

<body>
  <!-- ğŸ’š ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒ‡ã‚¶ã‚¤ãƒ³ã¯ maintab.css ã«çµ±ä¸€ï¼‰ -->
  <header class="top-bar">
    <div class="header-inner">
      <div class="logo">
        <div class="logo-icon"></div>
        <span data-translate="site_title">çµæ ¸å¯¾ç­–ã‚¢ãƒ—ãƒª</span>
      </div>
      <button class="user-name-btn" id="userNameBtn">
        <span id="userNameDisplay" data-translate="guest">ã‚²ã‚¹ãƒˆ</span><span id="userNameSuffix" data-translate="honorific_suffix"> ã•ã‚“</span>
      </button>
      <div class="header-right">
        <nav>
          <ul class="tab-menu">
            <li><a href="ai.html"><span data-translate="chat">ãƒãƒ£ãƒƒãƒˆ</span></a></li>
            <li><a href="score.html" class="active"><span data-translate="quiz">Q&A</span></a></li>
            <li><a href="movie.html"><span data-translate="video_watching">å‹•ç”»</span></a></li>
            <li><a href="setting.html"><span data-translate="settings">è¨­å®š</span></a></li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <!-- çµ±è¨ˆæƒ…å ±ãƒãƒ¼ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã®ä¸‹ï¼‰ -->
  <div class="stats-bar" style="background: #fff; padding: 12px 0; border-bottom: 1px solid #e3e8ee;">
    <div class="container" style="max-width: 1400px; margin: 0 auto; padding: 0 16px;">
      <div class="stats-bar-content" style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
        <div class="stat-pill" style="background: #E3F2FD; border-radius: 24px; padding: 12px 24px; display: flex; align-items: center; gap: 8px; border: 2px solid #BBDEFB; box-shadow: 0 2px 8px rgba(33, 150, 243, 0.15); transition: all 0.3s ease;">
          <span style="font-size: 1.2em; margin-right: 4px;">ğŸ“…</span>
          <span style="color: #1976D2; font-size: 0.9em; white-space: nowrap; font-weight: 600;" data-translate="learning_days">å­¦ç¿’ç¶™ç¶šæ—¥æ•°</span>
          <span id="header-learning-days" style="color: #2196F3; font-weight: bold; font-size: 1.1em;">0æ—¥</span>
        </div>
        <div class="stat-pill" style="background: #FFEBEE; border-radius: 24px; padding: 12px 24px; display: flex; align-items: center; gap: 8px; border: 2px solid #FFCDD2; box-shadow: 0 2px 8px rgba(244, 67, 54, 0.15); transition: all 0.3s ease;">
          <span style="font-size: 1.2em; margin-right: 4px;">ğŸ”¥</span>
          <span style="color: #C62828; font-size: 0.9em; white-space: nowrap; font-weight: 600;" data-translate="streak">é€£ç¶šæ­£è§£è¨˜éŒ²</span>
          <span id="header-streak" style="color: #F44336; font-weight: bold; font-size: 1.1em;">0å•</span>
        </div>
        <div class="stat-pill" style="background: #E8F5E9; border-radius: 24px; padding: 12px 24px; display: flex; align-items: center; gap: 8px; border: 2px solid #C8E6C9; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.15); transition: all 0.3s ease;">
          <span style="font-size: 1.2em; margin-right: 4px;">ğŸ“Š</span>
          <span style="color: #2E7D32; font-size: 0.9em; white-space: nowrap; font-weight: 600;" data-translate="weekly_quizzes">ä»Šé€±ã®ã‚¯ã‚¤ã‚ºæ•°</span>
          <span id="header-weekly-quizzes" style="color: #4CAF50; font-weight: bold; font-size: 1.1em;">0å›</span>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- ã‚¯ã‚¤ã‚ºç”Ÿæˆã¨ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’æ¨ªä¸¦ã³ã«ï¼ˆä¸€ç•ªä¸Šã«é…ç½®ï¼‰ -->
    <div class="quiz-score-layout">
      <!-- å·¦ï¼šãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«åŸºã¥ãã‚¯ã‚¤ã‚ºç”Ÿæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="chat-quiz-section">
        <h2 style="text-align: center; margin-bottom: 16px; color: #2E7D32; font-size: 1.3em; font-weight: 600; letter-spacing: 0.04em;" data-translate="personalized_quiz">ğŸ¯ ã‚ãªãŸã«åˆã‚ã›ãŸã‚¯ã‚¤ã‚º</h2>
        
        <div style="text-align: center; margin-bottom: 20px;">
          <p style="color: #558B2F; margin-bottom: 15px; font-size: 0.95em;" data-translate="chat_quiz_description">
            ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’åˆ†æã—ã¦ã€ã‚ãªãŸã®ç†è§£åº¦ã«åˆã‚ã›ãŸã‚¯ã‚¤ã‚ºã‚’ç”Ÿæˆã—ã¾ã™
          </p>
          <button onclick="generatePersonalizedQuiz()" class="quiz-btn" style="font-size: 1em; padding: 12px 24px;" data-translate="generate_quiz">ã‚¯ã‚¤ã‚ºã‚’ç”Ÿæˆã™ã‚‹</button>
        </div>
        
        <div id="quiz-generation-status" style="text-align: center; color: #888; margin-bottom: 20px; font-size: 0.9em; min-height: 24px;"></div>
        
        <!-- ãƒ©ãƒ³ã‚¯è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="user-rank-section" style="margin-top: 16px; padding: 16px; background: rgba(255, 255, 255, 0.6); border-radius: 12px; text-align: center; display: none;">
          <div style="color: #558B2F; font-size: 0.9em; margin-bottom: 12px; font-weight: 500;" data-translate="your_current_rank">ã‚ãªãŸã®ä»Šã®ãƒ©ãƒ³ã‚¯</div>
          <div id="user-rank-display" style="display: inline-block; padding: 16px 32px; border-radius: 16px; font-size: 2.5em; font-weight: bold; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">
            <span id="rank-label" style="display: block; margin-bottom: 4px;">-</span>
            <span id="rank-accuracy" style="display: block; font-size: 0.4em; font-weight: 500; opacity: 0.9; margin-top: 4px;">-</span>
          </div>
        </div>
        
        <div id="personalized-quiz-container" style="max-height: 600px; overflow-y: auto;"></div>
      </div>

      <!-- å³ï¼šã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆã‚°ãƒ©ãƒ•ã®ã¿è¡¨ç¤ºï¼‰ -->
      <div class="scores-section">
        <div class="chart-container" style="margin-bottom: 0;">
          <div id="movieScoreChart" style="width: 100%; height: 400px;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Firebaseã®è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyB7TuGhOKbB4w7DDYt7KTejy-TrcxVZmpU",
      authDomain: "web01-2484d.firebaseapp.com",
      databaseURL: "https://web01-2484d-default-rtdb.firebaseio.com",
      projectId: "web01-2484d",
      storageBucket: "web01-2484d.firebasestorage.app",
      messagingSenderId: "90159472898",
      appId: "1:90159472898:web:261ec71f9919611011e21b",
      measurementId: "G-9TGR07ZSY9"
    };
    firebase.initializeApp(firebaseConfig);

    // Plotly.jsç”¨ã®å¤‰æ•°ï¼ˆãƒãƒ£ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ä¸è¦ï¼‰

    // ç¿»è¨³ãƒ˜ãƒ«ãƒ‘ãƒ¼
    function t(key, fallback){
      try{
        const lang = (window.multiLang && window.multiLang.currentLanguage) || 'ja';
        const dict = (window.multiLang && window.multiLang.translations && window.multiLang.translations[lang]) || {};
        return (dict && dict[key]) || fallback;
      }catch(_){ return fallback; }
    }

    // å‹•ç”»ã‚¯ã‚¤ã‚ºã‚¹ã‚³ã‚¢ã‚’å–å¾—
    async function loadMovieScores(userId) {
      try {
        const db = firebase.firestore();
        const snapshot = await db.collection('movie_quiz_scores')
          .where('userId', '==', userId)
          .orderBy('timestamp', 'desc')
          .get();

        const scores = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          scores.push({
            ...data,
            id: doc.id,
            quizType: 'movie'
          });
        });

        return scores;
      } catch (e) {
        console.error("å‹•ç”»ã‚¯ã‚¤ã‚ºã‚¹ã‚³ã‚¢ã®å–å¾—ã«å¤±æ•—:", e);
        return [];
      }
    }

    // AIã‚¯ã‚¤ã‚ºï¼ˆãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºãƒ‰ã‚¯ã‚¤ã‚ºï¼‰ã‚¹ã‚³ã‚¢ã‚’å–å¾—
    async function loadAIQuizScores(userId) {
      try {
        console.log('=== loadAIQuizScores é–‹å§‹ ===');
        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:', userId);
        console.log('Firebase Firestoreã«æ¥ç¶šä¸­...');
        
        const db = firebase.firestore();
        console.log('Firestoreã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å–å¾—å®Œäº†');
        
        console.log('personalized_quiz_scoresã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');
        const snapshot = await db.collection('personalized_quiz_scores')
          .where('userId', '==', userId)
          .get();
        
        console.log('å–å¾—ã—ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°:', snapshot.size);
        console.log('å–å¾—ã—ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:', snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() })));
        
        const scores = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          console.log('ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿:', { id: doc.id, data: data });
          // personalized_quiz_scoresã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›
          const score = {
            id: doc.id,
            quizType: 'ai',
            score: data.score || 0,
            total: data.total || 10,
            correct: data.score || 0, // æ­£è§£æ•°ã¯scoreã¨åŒã˜
            // accuracyã¯ä¿å­˜ã•ã‚ŒãŸå€¤ã‚’ä½¿ã†ï¼ˆãªã‘ã‚Œã°è¨ˆç®—ï¼‰
            accuracy: data.accuracy !== undefined ? parseFloat(data.accuracy) : (data.total ? ((data.score / data.total) * 100).toFixed(1) : 0),
            // timestampãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å„ªå…ˆï¼ˆä¿å­˜æ™‚ã«timestampã¨ã—ã¦ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ï¼‰
            timestamp: data.timestamp || data.createdAt,
            userName: data.userName || t('anonymous', 'åŒ¿å'),
            userEmail: data.userEmail || '',
            category: 'tuberculosis_quiz'
          };
          scores.push(score);
          console.log('å¤‰æ›å¾Œã®ã‚¹ã‚³ã‚¢:', score);
        });
        
        console.log('å¤‰æ›å‰ã®ã‚¹ã‚³ã‚¢æ•°:', scores.length);
        
        // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã‚½ãƒ¼ãƒˆï¼ˆtimestampã§é™é †ï¼‰
        scores.sort((a, b) => {
          let ta, tb;
          // timestampãŒFirestore Timestampã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ
          if (a.timestamp && typeof a.timestamp.toDate === "function") {
            ta = a.timestamp.toDate();
          } else if (a.timestamp) {
            ta = new Date(a.timestamp);
          } else {
            ta = new Date(0); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
          }
          
          if (b.timestamp && typeof b.timestamp.toDate === "function") {
            tb = b.timestamp.toDate();
          } else if (b.timestamp) {
            tb = new Date(b.timestamp);
          } else {
            tb = new Date(0); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
          }
          
          return tb - ta; // é™é †ï¼ˆæ–°ã—ã„é †ï¼‰
        });
        
        console.log('personalized_quiz_scoresã‹ã‚‰å–å¾—ã—ãŸã‚¹ã‚³ã‚¢:', scores.length, 'ä»¶');
        console.log('ã‚½ãƒ¼ãƒˆå¾Œã®ã‚¹ã‚³ã‚¢:', scores);
        console.log('=== loadAIQuizScores å®Œäº† ===');
        return scores;
      } catch (e) {
        console.error("AIã‚¯ã‚¤ã‚ºã‚¹ã‚³ã‚¢ã®å–å¾—ã«å¤±æ•—:", e);
        console.error("ã‚¨ãƒ©ãƒ¼è©³ç´°:", e.message, e.stack);
        return [];
      }
    }

    // AIã‚¯ã‚¤ã‚ºã‚¹ã‚³ã‚¢ã®ã¿ã‚’å–å¾—ã—ã€ã‚°ãƒ©ãƒ•ã¨ã‚«ãƒ¼ãƒ‰ã«åæ˜ 
    async function loadAIQuizScoresOnly(userId) {
      try {
        console.log('=== loadAIQuizScoresOnly é–‹å§‹ ===');
        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:', userId);
        const aiScores = await loadAIQuizScores(userId);
        console.log('å–å¾—ã—ãŸã‚¹ã‚³ã‚¢æ•°:', aiScores.length);
        console.log('å–å¾—ã—ãŸã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿:', aiScores);
        currentScores = aiScores; // ã‚¹ã‚³ã‚¢ã‚’ä¿å­˜
        if (aiScores.length === 0) {
          console.log('ã‚¹ã‚³ã‚¢ãŒ0ä»¶ã®ãŸã‚ã€ç©ºã®ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºã—ã¾ã™');
          updateMovieScoreChart([]);
          renderMovieScores([]);
          return;
        }
        console.log('ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°ã—ã¾ã™ã€‚ã‚¹ã‚³ã‚¢æ•°:', aiScores.length);
        updateMovieScoreChart(aiScores);
        renderMovieScores(aiScores);
        updateStatistics(aiScores);
        console.log('=== loadAIQuizScoresOnly å®Œäº† ===');
      } catch (e) {
        const scoresContainer = document.getElementById('scores-container');
        if (scoresContainer) {
          scoresContainer.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #888;">
              <p data-translate="ai_quiz_load_error">AIã‚¯ã‚¤ã‚ºã®çµæœã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚</p>
              <p data-translate="error">ã‚¨ãƒ©ãƒ¼: ${e.message}</p>
              <p data-translate="please_retry">ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
          `;
        }
        updateMovieScoreChart([]);
        renderMovieScores([]);
      }
    }

    // æ­£ç­”ç‡ã‹ã‚‰ãƒ©ãƒ³ã‚¯ã‚’åˆ¤å®šï¼ˆå€‹åˆ¥ã‚¯ã‚¤ã‚ºã®ãƒ©ãƒ³ã‚¯è¡¨ç¤ºç”¨ï¼‰
    function getRank(accuracy) {
      if (accuracy === null || accuracy === undefined) return { label: 'N/A', class: 'rank-d' };
      if (accuracy >= 90) return { label: 'S', class: 'rank-s' };
      if (accuracy >= 80) return { label: 'A', class: 'rank-a' };
      if (accuracy >= 60) return { label: 'B', class: 'rank-b' };
      if (accuracy >= 40) return { label: 'C', class: 'rank-c' };
      return { label: 'D', class: 'rank-d' };
    }

    // ã‚¯ã‚¤ã‚ºæˆç¸¾æ¨ç§»ã‚°ãƒ©ãƒ•ï¼ˆPlotly.jsä½¿ç”¨ï¼‰
    function updateMovieScoreChart(scores) {
      try {
        console.log('=== updateMovieScoreChart é–‹å§‹ (Plotly.js) ===');
        console.log('Plotly.js ãŒåˆ©ç”¨å¯èƒ½ã‹:', typeof Plotly !== 'undefined');
        console.log('ã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿:', scores);
        console.log('ã‚¹ã‚³ã‚¢æ•°:', scores ? scores.length : 0);
        
        const chartElement = document.getElementById('movieScoreChart');
        if (!chartElement) {
          console.error('ã‚°ãƒ©ãƒ•è¦ç´  movieScoreChart ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºã§ãã¾ã›ã‚“ã€‚');
          return;
        }
        console.log('ã‚°ãƒ©ãƒ•è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:', chartElement);

        // Plotly.jsãŒåˆ©ç”¨å¯èƒ½ã‹ç¢ºèª
        if (typeof Plotly === 'undefined') {
          console.error('Plotly.js ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
          if (chartElement) {
            chartElement.innerHTML = '<p style="text-align: center; padding: 20px; color: #888;">Plotly.js ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</p>';
          }
          return;
        }
        
        // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
        if (!scores || scores.length === 0) {
          console.log('ã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç©ºã®ãƒãƒ£ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ã¾ã™ã€‚');
          try {
            Plotly.newPlot(chartElement, [], {
              title: {
                text: t('chart_title','ğŸ“ˆ ã‚¯ã‚¤ã‚ºæˆç¸¾æ¨ç§»'),
                font: { size: 18, family: "'Noto Sans JP', sans-serif" }
              },
              xaxis: { title: { text: t('period_axis','ğŸ“… æœŸé–“') } },
              yaxis: { title: { text: t('accuracy_label','ğŸ“Š æ­£ç­”ç‡ (%)') }, range: [0, 100] },
              yaxis2: { title: { text: t('correct_label','ğŸ¯ æ­£è§£æ•°') }, overlaying: 'y', side: 'right', range: [0, 10] }
            }, { responsive: true });
            console.log('ç©ºã®ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ');
          } catch (emptyChartError) {
            console.error('ç©ºã®ãƒãƒ£ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', emptyChartError);
          }
          return;
        }

        // æ—¥ä»˜ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function getDate(score) {
          if (score.timestamp && typeof score.timestamp.toDate === "function") {
            return score.timestamp.toDate();
          } else if (score.timestamp && score.timestamp.seconds) {
            return new Date(score.timestamp.seconds * 1000);
          } else if (score.timestamp) {
            return new Date(score.timestamp);
          } else {
            return new Date();
          }
        }

        // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
        const sortedScores = scores.slice().sort((a, b) => {
          let ta, tb;
          
          // timestampã®å‡¦ç†
          if (a.timestamp && typeof a.timestamp.toDate === "function") {
            ta = a.timestamp.toDate();
          } else if (a.timestamp && a.timestamp.seconds) {
            ta = new Date(a.timestamp.seconds * 1000);
          } else if (a.timestamp) {
            ta = new Date(a.timestamp);
          } else {
            ta = new Date(0);
          }
          
          if (b.timestamp && typeof b.timestamp.toDate === "function") {
            tb = b.timestamp.toDate();
          } else if (b.timestamp && b.timestamp.seconds) {
            tb = new Date(b.timestamp.seconds * 1000);
          } else if (b.timestamp) {
            tb = new Date(b.timestamp);
          } else {
            tb = new Date(0);
          }
          
          return tb.getTime() - ta.getTime(); // æ–°ã—ã„é †ï¼ˆé™é †ï¼‰
        });

        console.log('ã‚½ãƒ¼ãƒˆå¾Œã®ã‚¹ã‚³ã‚¢:', sortedScores);
        console.log('ã‚½ãƒ¼ãƒˆå¾Œã®ã‚¹ã‚³ã‚¢æ•°:', sortedScores.length);

        // æœ€æ–°5ä»¶ã‚’å–å¾—ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒ5ä»¶æœªæº€ã®å ´åˆã¯å…¨ã¦ä½¿ç”¨ï¼‰
        const latestScores = sortedScores.slice(0, Math.min(5, sortedScores.length));
        console.log('æœ€æ–°5ä»¶ã®ã‚¹ã‚³ã‚¢:', latestScores);
        console.log('å–å¾—ã—ãŸã‚¹ã‚³ã‚¢æ•°:', latestScores.length);
        
        // ãƒ©ãƒ™ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
        let labels = [];
        let accuracyData = [];
        let correctData = [];
        
        if (latestScores.length === 0) {
          console.warn('âš ï¸ æœ€æ–°5ä»¶ã®ã‚¹ã‚³ã‚¢ãŒ0ä»¶ã§ã™ã€‚ã‚°ãƒ©ãƒ•ã«è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
        } else {
          // å¤ã„é †ã«ä¸¦ã³æ›¿ãˆï¼ˆã‚°ãƒ©ãƒ•è¡¨ç¤ºç”¨ï¼‰
          latestScores.reverse();
          console.log('å¤ã„é †ã«ä¸¦ã³æ›¿ãˆå¾Œ:', latestScores);

          latestScores.forEach((score, index) => {
            const date = getDate(score);
            const dateStr = date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
            labels.push(dateStr);
            const accuracy = parseFloat(score.accuracy) || 0;
            const correct = parseInt(score.correct) || parseInt(score.score) || 0;
            accuracyData.push(accuracy);
            correctData.push(correct);
            console.log(`ã‚¹ã‚³ã‚¢ ${index + 1}:`, { dateStr, accuracy, correct, score });
          });
        }

        console.log('ãƒ©ãƒ™ãƒ«:', labels);
        console.log('æ­£ç­”ç‡ãƒ‡ãƒ¼ã‚¿:', accuracyData);
        console.log('æ­£è§£æ•°ãƒ‡ãƒ¼ã‚¿:', correctData);
        console.log('ãƒ‡ãƒ¼ã‚¿æ•°:', labels.length, accuracyData.length, correctData.length);
      
        // æ­£è§£æ•°ã®Yè»¸ã®æœ€å¤§å€¤ã‚’è¨ˆç®—
        let y1Max = 10; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        if (latestScores.length > 0) {
          try {
            const totals = latestScores.map(score => parseInt(score.total) || 10).filter(t => !isNaN(t) && t > 0);
            const maxTotal = totals.length > 0 ? Math.max(...totals) : 10;
            const validCorrectData = correctData.filter(c => !isNaN(c) && c >= 0);
            const maxCorrect = validCorrectData.length > 0 ? Math.max(...validCorrectData) : 0;
            y1Max = Math.max(maxTotal, maxCorrect, 5) + 1;
            console.log('Yè»¸æœ€å¤§å€¤:', y1Max, 'maxTotal:', maxTotal, 'maxCorrect:', maxCorrect);
          } catch (e) {
            console.warn('Yè»¸æœ€å¤§å€¤ã®è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', e);
            y1Max = 10;
          }
        }

        console.log('ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™...');
        console.log('ãƒ©ãƒ™ãƒ«æ•°:', labels.length);
        console.log('æ­£ç­”ç‡ãƒ‡ãƒ¼ã‚¿æ•°:', accuracyData.length);
        console.log('æ­£è§£æ•°ãƒ‡ãƒ¼ã‚¿æ•°:', correctData.length);
        
        // Plotly.jsã§ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆ
        const trace1 = {
          x: labels,
          y: accuracyData,
          name: t('accuracy_label','æ­£ç­”ç‡ (%)'),
          type: 'scatter',
          mode: 'lines+markers',
          line: {
            color: '#6c63ff',
            width: 3,
            shape: 'spline'
          },
          marker: {
            color: '#6c63ff',
            size: 8,
            line: {
              color: '#fff',
              width: 2
            }
          },
          fill: 'tozeroy',
          fillcolor: 'rgba(108, 99, 255, 0.1)',
          yaxis: 'y'
        };
        
        const trace2 = {
          x: labels,
          y: correctData,
          name: t('correct_label','æ­£è§£æ•°'),
          type: 'scatter',
          mode: 'lines+markers',
          line: {
            color: '#48c6ef',
            width: 3,
            shape: 'spline'
          },
          marker: {
            color: '#48c6ef',
            size: 8,
            line: {
              color: '#fff',
              width: 2
            }
          },
          yaxis: 'y2'
        };
        
        const layout = {
          title: {
            text: t('chart_title','ğŸ“ˆ ã‚¯ã‚¤ã‚ºæˆç¸¾æ¨ç§»'),
            font: { 
              size: 18, 
              family: "'Noto Sans JP', sans-serif" 
            },
            x: 0.5
          },
          xaxis: {
            title: {
              text: t('period_axis','ğŸ“… æœŸé–“'),
              font: { size: 13, family: "'Noto Sans JP', sans-serif" }
            },
            showgrid: true,
            gridcolor: 'rgba(227, 232, 238, 0.5)'
          },
          yaxis: {
            title: {
              text: t('accuracy_label','ğŸ“Š æ­£ç­”ç‡ (%)'),
              font: { size: 13, family: "'Noto Sans JP', sans-serif" }
            },
            range: [0, 100],
            showgrid: true,
            gridcolor: 'rgba(227, 232, 238, 0.5)',
            tickformat: '.0f',
            ticksuffix: '%'
          },
          yaxis2: {
            title: {
              text: t('correct_label','ğŸ¯ æ­£è§£æ•°'),
              font: { size: 13, family: "'Noto Sans JP', sans-serif" }
            },
            overlaying: 'y',
            side: 'right',
            range: [0, y1Max],
            showgrid: false,
            tickformat: 'd'
          },
          legend: {
            x: 0,
            y: 1,
            font: { 
              size: 13, 
              family: "'Noto Sans JP', sans-serif" 
            }
          },
          hovermode: 'x unified',
          margin: { l: 60, r: 60, t: 60, b: 60 },
          plot_bgcolor: 'rgba(0,0,0,0)',
          paper_bgcolor: 'rgba(0,0,0,0)'
        };
        
        const config = {
          responsive: true,
          displayModeBar: false
        };
        
        Plotly.newPlot(chartElement, [trace1, trace2], layout, config);
        
        console.log('ãƒãƒ£ãƒ¼ãƒˆä½œæˆå®Œäº† (Plotly.js)');
        console.log('=== updateMovieScoreChart çµ‚äº† ===');
      } catch (error) {
        console.error('ãƒãƒ£ãƒ¼ãƒˆæç”»ã‚¨ãƒ©ãƒ¼:', error);
        console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.stack);
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã§ã‚‚ã€ç©ºã®ãƒãƒ£ãƒ¼ãƒˆã‚’è¡¨ç¤º
        try {
          const chartElement = document.getElementById('movieScoreChart');
          if (chartElement) {
            Plotly.newPlot(chartElement, [], {
              title: {
                text: t('chart_title','ğŸ“ˆ ã‚¯ã‚¤ã‚ºæˆç¸¾æ¨ç§»'),
                font: { size: 18, family: "'Noto Sans JP', sans-serif" }
              }
            }, { responsive: true });
          }
        } catch (fallbackError) {
          console.error('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒãƒ£ãƒ¼ãƒˆä½œæˆã‚‚å¤±æ•—:', fallbackError);
        }
      }
    }

    // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
    function updateStatistics(scores) {
      if (!scores || scores.length === 0) {
        // ã‚¹ã‚³ã‚¢ãŒãªã„å ´åˆã¯ãƒ©ãƒ³ã‚¯è¡¨ç¤ºã‚’éè¡¨ç¤º
        const rankSection = document.getElementById('user-rank-section');
        if (rankSection) rankSection.style.display = 'none';
        return;
      }
      const totalQuizzes = scores.length;
      const totalCorrect = scores.reduce((sum, score) => sum + (score.correct || 0), 0);
      const totalQuestions = scores.reduce((sum, score) => sum + (score.total || 0), 0);
      const averageAccuracy = scores.reduce((sum, score) => sum + (parseFloat(score.accuracy) || 0), 0) / totalQuizzes;
      
      // ãƒ©ãƒ³ã‚¯ã‚’æ›´æ–°
      updateUserRank(averageAccuracy);

      const statsContainer = document.querySelector('.stats-container');
      if (statsContainer) {
        const existingStats = statsContainer.querySelector('.stats-summary');
        if (existingStats) existingStats.remove();

        const statsSummary = document.createElement('div');
        statsSummary.className = 'stats-summary';
        statsSummary.innerHTML = `
          <div>
            <div class="stat-box">
              <div class="stat-title" data-translate="total_quizzes">ç·ã‚¯ã‚¤ã‚ºæ•°</div>
              <div class="stat-value">${totalQuizzes}</div>
            </div>
            <div class="stat-box">
              <div class="stat-title" data-translate="total_correct">ç·æ­£è§£æ•°</div>
              <div class="stat-value">${totalCorrect}</div>
            </div>
            <div class="stat-box">
              <div class="stat-title" data-translate="total_questions">ç·å•é¡Œæ•°</div>
              <div class="stat-value">${totalQuestions}</div>
            </div>
            <div class="stat-box">
              <div class="stat-title" data-translate="average_accuracy">å¹³å‡æ­£ç­”ç‡</div>
              <div class="stat-value">${averageAccuracy.toFixed(1)}%</div>
            </div>
          </div>
        `;
        statsContainer.appendChild(statsSummary);

        setTimeout(() => {
          if (window.multiLang && typeof window.multiLang.updateUI === 'function') {
            try { window.multiLang.updateUI(); } catch (_) {}
          }
        }, 100);
      }

      updateLearningProgress(scores);
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ©ãƒ³ã‚¯ã‚’æ›´æ–°
    function updateUserRank(averageAccuracy) {
      const rankSection = document.getElementById('user-rank-section');
      const rankLabel = document.getElementById('rank-label');
      const rankAccuracy = document.getElementById('rank-accuracy');
      const rankDisplay = document.getElementById('user-rank-display');
      
      if (!rankSection || !rankLabel || !rankAccuracy || !rankDisplay) return;
      
      const rank = getRank(averageAccuracy);
      
      // ãƒ©ãƒ³ã‚¯è¡¨ç¤ºã‚’æ›´æ–°
      rankLabel.textContent = rank.label;
      rankAccuracy.textContent = `${averageAccuracy.toFixed(1)}%`;
      
      // ãƒ©ãƒ³ã‚¯ã«å¿œã˜ãŸã‚¯ãƒ©ã‚¹ã‚’é©ç”¨ï¼ˆæ—¢å­˜ã®ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰è¿½åŠ ï¼‰
      rankDisplay.className = '';
      rankDisplay.classList.add('rank-badge', rank.class);
      
      // åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
      rankDisplay.style.cssText = `
        display: inline-block;
        padding: 16px 32px;
        border-radius: 16px;
        font-size: 2.5em;
        font-weight: bold;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
        min-width: 120px;
      `;
      
      // ãƒ©ãƒ³ã‚¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
      rankSection.style.display = 'block';
    }

    function updateLearningProgress(scores) {
      if (!scores || scores.length === 0) {
        // ã‚¹ã‚³ã‚¢ãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¡¨ç¤º
        updateHeaderStats(0, 0, 0);
        return;
      }

      const uniqueDates = [...new Set(scores.map(score => {
        let date;
        if (score.timestamp && typeof score.timestamp.toDate === "function") {
          date = score.timestamp.toDate();
        } else if (score.timestamp) {
          date = new Date(score.timestamp);
        } else {
          date = new Date();
        }
        return date.toDateString();
      }))];
      const learningDays = uniqueDates.length;

      // é€£ç¶šæ­£è§£è¨˜éŒ²ã‚’è¨ˆç®—ï¼ˆæ­£ç­”ç‡60%ä»¥ä¸Šã‚’æ­£è§£ã¨ã¿ãªã™ï¼‰
      let currentStreak = 0;
      let maxStreak = 0;
      for (let i = scores.length - 1; i >= 0; i--) {
        if ((parseFloat(scores[i].accuracy) || 0) >= 60) {
          currentStreak++;
          maxStreak = Math.max(maxStreak, currentStreak);
        } else {
          currentStreak = 0;
        }
      }

      // ä»Šé€±ã®ã‚¯ã‚¤ã‚ºæ•°ã‚’è¨ˆç®—ï¼ˆæ—¥æ›œæ—¥ã‚’é€±ã®é–‹å§‹ã¨ã™ã‚‹ï¼‰
      const now = new Date();
      const dayOfWeek = now.getDay();
      const startOfWeek = new Date(now);
      startOfWeek.setDate(now.getDate() - dayOfWeek);
      startOfWeek.setHours(0, 0, 0, 0);
      const weeklyQuizzes = scores.filter(score => {
        let date;
        if (score.timestamp && typeof score.timestamp.toDate === "function") {
          date = score.timestamp.toDate();
        } else if (score.timestamp) {
          date = new Date(score.timestamp);
        } else {
          return false;
        }
        return date >= startOfWeek;
      }).length;

      let level = t('beginner_level', 'åˆå¿ƒè€…');
      let levelProgress = 0;
      const avgAccuracy = scores.reduce((sum, score) => sum + (parseFloat(score.accuracy) || 0), 0) / scores.length;
      if (scores.length >= 10 && avgAccuracy >= 80) {
        level = t('expert_level', 'ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ');
        levelProgress = 100;
      } else if (scores.length >= 5 && avgAccuracy >= 60) {
        level = t('intermediate_level', 'ä¸­ç´šè€…');
        levelProgress = Math.min(100, (scores.length / 10) * 100);
      } else {
        level = t('beginner_level', 'åˆå¿ƒè€…');
        levelProgress = Math.min(100, (scores.length / 5) * 100);
      }

      // ãƒ˜ãƒƒãƒ€ãƒ¼ã®çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
      updateHeaderStats(learningDays, maxStreak, weeklyQuizzes);

      updateProgressBar('learning-days', learningDays, 30, 'æ—¥');
      updateProgressBar('goal-achievement', goalAchievement, 100, '%');
      updateProgressBar('streak', maxStreak, 20, 'å•');
      updateProgressBar('level', levelProgress, 100, '%');

      document.getElementById('level').textContent = level;
    }

    // ãƒ˜ãƒƒãƒ€ãƒ¼ã®çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
    function updateHeaderStats(learningDays, streak, weeklyQuizzes) {
      const headerLearningDays = document.getElementById('header-learning-days');
      const headerStreak = document.getElementById('header-streak');
      const headerWeeklyQuizzes = document.getElementById('header-weekly-quizzes');
      
      if (headerLearningDays) {
        headerLearningDays.textContent = learningDays + t('days_unit', 'æ—¥');
      }
      if (headerStreak) {
        headerStreak.textContent = streak + t('questions_unit', 'å•');
      }
      if (headerWeeklyQuizzes) {
        headerWeeklyQuizzes.textContent = weeklyQuizzes + t('times_unit', 'å›');
      }
    }

    function updateProgressBar(elementId, current, max, unit) {
      const element = document.getElementById(elementId);
      const bar = document.getElementById(elementId + '-bar');
      if (element && bar) {
        let translatedUnit = unit;
        if (unit === 'æ—¥') translatedUnit = t('days_unit', 'æ—¥');
        else if (unit === 'å•') translatedUnit = t('questions_unit', 'å•');
        else if (unit === '%') translatedUnit = '%';

        element.textContent = current + translatedUnit;
        const percentage = Math.min(100, (current / max) * 100);
        bar.style.width = percentage + '%';

        if (percentage >= 80) {
          bar.style.background = 'linear-gradient(90deg, #4CAF50, #8BC34A)';
        } else if (percentage >= 60) {
          bar.style.background = 'linear-gradient(90deg, #FF9800, #FFD54F)';
        } else {
          bar.style.background = 'linear-gradient(90deg, #F44336, #FF8A65)';
        }
      }
    }

    function renderMovieScores(scores) {
      const scoresContainer = document.getElementById('scores-container');
      if (!scoresContainer) return;

      if (!scores || scores.length === 0) {
        // ã‚¹ã‚³ã‚¢ãŒãªã„å ´åˆã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„
        scoresContainer.innerHTML = '';
        return;
      }

      scoresContainer.innerHTML = '';

      const bestScore = scores.reduce((best, current) =>
        (parseFloat(current.accuracy) || 0) > (parseFloat(best.accuracy) || 0) ? current : best
      );

      scores.forEach((score) => {
        const scoreCard = document.createElement('div');
        scoreCard.className = 'score-card';

        let dateObj;
        if (score.timestamp && typeof score.timestamp.toDate === 'function') {
          dateObj = score.timestamp.toDate();
        } else if (score.timestamp) {
          dateObj = new Date(score.timestamp);
        } else {
          dateObj = new Date();
        }
        const formattedDate = dateObj.toLocaleString('ja-JP');
        const rank = getRank(parseFloat(score.accuracy) || 0);

        if (score === bestScore) scoreCard.classList.add('best-score');

        scoreCard.innerHTML = `
          <div class="score-card-header">
            <div class="score-card-date">
              <span class="date-icon">ğŸ“…</span>
              ${formattedDate}
            </div>
            <div class="score-card-rank">
              <span class="rank-badge ${rank.class}">${rank.label}${t('rank', 'ãƒ©ãƒ³ã‚¯')}</span>
            </div>
          </div>
          <div class="score-card-body">
            <div class="score-card-main">
              <div class="score-accuracy">
                <span class="accuracy-label" data-translate="accuracy_rate">æ­£ç­”ç‡</span>
                <span class="accuracy-value">${(parseFloat(score.accuracy) || 0).toFixed(1)}%</span>
              </div>
              <div class="score-correct">
                <span class="correct-label" data-translate="correct_answers">æ­£è§£æ•°</span>
                <span class="correct-value">${score.correct || 0} / ${score.total || 0}</span>
              </div>
            </div>
            <div class="score-card-details">
              <div class="detail-item">
                <span class="detail-icon">ğŸ¯</span>
                <span class="detail-label" data-translate="category">ã‚«ãƒ†ã‚´ãƒª:</span>
                <span class="detail-value">${score.category ? t(score.category, score.category) : t('unknown', 'ä¸æ˜')}</span>
              </div>
              <div class="detail-item">
                <span class="detail-icon">ğŸ¤–</span>
                <span class="detail-label" data-translate="quiz_type">ã‚¯ã‚¤ã‚ºç¨®åˆ¥:</span>
                <span class="detail-value" data-translate="ai_quiz">AIã‚¯ã‚¤ã‚º</span>
              </div>
            </div>
          </div>
          ${score === bestScore ? `<div class="best-score-badge" data-translate="best_score">ğŸ† ãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢</div>` : ''}
        `;

        scoresContainer.appendChild(scoreCard);
      });

      if (window.multiLang && typeof window.multiLang.updateUI === 'function') {
        try { window.multiLang.updateUI(); } catch (_) {}
      }
    }

    // è¨€èªå¤‰æ›´æ™‚ã«ã‚°ãƒ©ãƒ•ã¨çµ±è¨ˆæƒ…å ±ã‚’å†æç”»
    let currentScores = [];
    function refreshChartOnLanguageChange() {
      if (currentScores.length > 0) {
        updateMovieScoreChart(currentScores);
        updateStatistics(currentScores);
      }
    }

    // multiLangã®è¨€èªå¤‰æ›´ã‚’ç›£è¦–
    if (window.multiLang) {
      const originalSwitchLanguage = window.multiLang.switchLanguage.bind(window.multiLang);
      window.multiLang.switchLanguage = async function(language) {
        await originalSwitchLanguage(language);
        refreshChartOnLanguageChange();
        if (window.multiLang && typeof window.multiLang.updateUI === 'function') {
          try { window.multiLang.updateUI(); } catch (_) {}
        }
      };
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—ã—ã¦è¡¨ç¤ºï¼ˆFirestoreã‹ã‚‰å–å¾—ï¼‰
    async function updateUserName() {
      const userNameDisplay = document.getElementById('userNameDisplay');
      if (!userNameDisplay) return;
      
      let auth = null;
      if (window.multiLang && window.multiLang.auth) {
        auth = window.multiLang.auth;
      } else if (typeof firebase !== 'undefined' && firebase.auth) {
        auth = firebase.auth();
      }
      
      if (!auth) {
        const guestText = t('guest', 'ã‚²ã‚¹ãƒˆ');
        const suffix = t('honorific_suffix', 'ã•ã‚“');
        userNameDisplay.textContent = guestText;
        const suffixEl = document.getElementById('userNameSuffix');
        if (suffixEl) suffixEl.textContent = suffix ? ' ' + suffix : '';
        return;
      }
      
      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          const guestText = t('guest', 'ã‚²ã‚¹ãƒˆ');
          const suffix = t('honorific_suffix', 'ã•ã‚“');
          userNameDisplay.textContent = guestText;
          const suffixEl = document.getElementById('userNameSuffix');
          if (suffixEl) suffixEl.textContent = suffix ? ' ' + suffix : '';
          return;
        }
        
        try {
          // Firestoreã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
          const db = firebase.firestore();
          const userDoc = await db.collection('users').doc(user.uid).get();
          
          if (userDoc.exists) {
            const userData = userDoc.data();
            // nameã®ã¿ã‚’ä½¿ç”¨
            const displayName = userData.name || t('user', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼');
            const suffix = t('honorific_suffix', 'ã•ã‚“');
            userNameDisplay.textContent = displayName;
            const suffixEl = document.getElementById('userNameSuffix');
            if (suffixEl) suffixEl.textContent = suffix ? ' ' + suffix : '';
          } else {
            // Firestoreã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
            const userText = t('user', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼');
            const suffix = t('honorific_suffix', 'ã•ã‚“');
            userNameDisplay.textContent = userText;
            const suffixEl = document.getElementById('userNameSuffix');
            if (suffixEl) suffixEl.textContent = suffix ? ' ' + suffix : '';
          }
        } catch (error) {
          console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
          const userText = t('user', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼');
          const suffix = t('honorific_suffix', 'ã•ã‚“');
          userNameDisplay.textContent = userText;
          const suffixEl = document.getElementById('userNameSuffix');
          if (suffixEl) suffixEl.textContent = suffix ? ' ' + suffix : '';
        }
      });
    }

    // èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªã—ã€ã‚¹ã‚³ã‚¢ã‚’åæ˜ 
    firebase.auth().onAuthStateChanged(user => {
      updateUserName();
      if (user) {
        loadAIQuizScoresOnly(user.uid);
        setTimeout(() => {
          if (window.multiLang && typeof window.multiLang.updateUI === 'function') {
            try { window.multiLang.updateUI(); } catch (_) {}
          }
        }, 500);
      } else {
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¡¨ç¤º
        updateHeaderStats(0, 0, 0);
        const scoresContainer = document.getElementById('scores-container');
        if (scoresContainer) {
          scoresContainer.innerHTML = `
            <div class="no-scores-message">
              <div class="no-scores-icon">ğŸ”’</div>
              <h3 data-translate="login_required">ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</h3>
              <p data-translate="login_required_message">ã‚¯ã‚¤ã‚ºã®çµæœã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
              <button onclick="location.href='index.html'" class="quiz-btn" style="margin-top: 15px; font-size:1em;" data-translate="login">ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹</button>
            </div>
          `;
        }
        if (window.multiLang && typeof window.multiLang.updateUI === 'function') {
          try { window.multiLang.updateUI(); } catch (_) {}
        }
      }
    });

    // ========================================
    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«åŸºã¥ããƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºãƒ‰ã‚¯ã‚¤ã‚ºç”Ÿæˆ
    // ========================================
    let currentPersonalizedQuiz = null;
    let currentQuizIndex = 0;
    let personalizedQuizScore = 0;
    let quizAnswers = []; // å„å•é¡Œã®å›ç­”çŠ¶æ…‹ã‚’ä¿æŒ

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function generatePersonalizedQuiz() {
      const statusDiv = document.getElementById('quiz-generation-status');
      const quizContainer = document.getElementById('personalized-quiz-container');
      
      if (!statusDiv || !quizContainer) return;
      
      statusDiv.innerHTML = '<p>ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’åˆ†æä¸­...</p>';
      quizContainer.innerHTML = '';
      
      try {
        const currentUser = firebase.auth().currentUser;
        if (!currentUser) {
          statusDiv.innerHTML = '<p style="color:#f44336;">ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</p>';
          return;
        }
        
        const db = firebase.firestore();
        
        // æœ€æ–°ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å–å¾—
        // ã¾ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‚åŠ ã—ã¦ã„ã‚‹ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã‚’æ¤œç´¢
        const allChatsSnapshot = await db.collection('chats').get();
        let latestMessagesSnapshot = null;
        let chatRoomId = null;
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‚åŠ ã—ã¦ã„ã‚‹æœ€æ–°ã®ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã‚’è¦‹ã¤ã‘ã‚‹
        for (const chatDoc of allChatsSnapshot.docs) {
          const roomId = chatDoc.id;
          // chatRoomIdãŒ2ã¤ã®UIDã‚’_ã§çµåˆã—ãŸå½¢å¼ã®å ´åˆ
          if (roomId.includes(currentUser.uid)) {
            const messagesSnapshot = await db.collection('chats').doc(roomId)
              .collection('messages')
              .orderBy('timestamp', 'desc')
              .limit(1)
              .get();
            
            if (!messagesSnapshot.empty) {
              chatRoomId = roomId;
              latestMessagesSnapshot = await db.collection('chats').doc(roomId)
                .collection('messages')
                .orderBy('timestamp', 'desc')
                .limit(50)
                .get();
              break;
            }
          }
        }
        
        let patientText = '';
        
        if (latestMessagesSnapshot && !latestMessagesSnapshot.empty) {
          const userMessages = [];
          latestMessagesSnapshot.forEach(doc => {
            const msg = doc.data();
            if (msg.senderId === currentUser.uid && msg.text) {
              userMessages.push(msg.text);
            }
          });
          
          patientText = userMessages.reverse().join('\n');
        }
        
        // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒãªã„å ´åˆã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¬ãƒ™ãƒ«ã§ã‚¯ã‚¤ã‚ºç”Ÿæˆ
        if (!patientText || patientText.trim().length < 10) {
          statusDiv.innerHTML = `<p style="color:#888;">${t('insufficient_chat_history', 'ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒå°‘ãªã„ãŸã‚ã€åŸºç¤ãƒ¬ãƒ™ãƒ«ã®ã‚¯ã‚¤ã‚ºã‚’ç”Ÿæˆã—ã¾ã™')}</p>`;
          await generateQuizByLevel(3, quizContainer, statusDiv);
          return;
        }
        
        // æ‚£è€…ã®ç™ºè¨€ã‚’è©•ä¾¡
        statusDiv.innerHTML = `<p>${t('evaluating_understanding', 'ã‚ãªãŸã®ç†è§£åº¦ã‚’è©•ä¾¡ä¸­...')}</p>`;
        const evaluation = await evaluatePatientChat(patientText);
        
        if (!evaluation) {
          statusDiv.innerHTML = `<p style="color:#888;">${t('evaluation_failed', 'è©•ä¾¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¯ã‚¤ã‚ºã‚’ç”Ÿæˆã—ã¾ã™')}</p>`;
          await generateQuizByLevel(3, quizContainer, statusDiv);
          return;
        }
        
        const knowledgeScore = evaluation.knowledge_score;
        const evalCompleteMsg = t('evaluation_complete', `è©•ä¾¡å®Œäº†ï¼šãƒ¬ãƒ™ãƒ« ${knowledgeScore} â†’ é©åˆ‡ãªé›£æ˜“åº¦ã®ã‚¯ã‚¤ã‚ºã‚’ç”Ÿæˆä¸­...`)
          .replace('{level}', knowledgeScore);
        statusDiv.innerHTML = `<p>${evalCompleteMsg}</p>`;
        
        // è©•ä¾¡ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸã‚¯ã‚¤ã‚ºã‚’ç”Ÿæˆ
        await generateQuizByLevel(knowledgeScore, quizContainer, statusDiv, evaluation);
        
      } catch (error) {
        console.error('ã‚¯ã‚¤ã‚ºç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          name: error.name
        });
        
        const statusDiv = document.getElementById('quiz-generation-status');
        if (statusDiv) {
          const errorLabel = t('error', 'ã‚¨ãƒ©ãƒ¼:');
          // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚ˆã‚Šè©³ç´°ã«è¡¨ç¤º
          let errorMsg = error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
          
          // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
          if (error.message && error.message.includes('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼')) {
            errorMsg = t('network_error', 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: APIã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          }
          // APIã‚¨ãƒ©ãƒ¼ã®å ´åˆ
          else if (error.message && (error.message.includes('500') || error.message.includes('HTTP'))) {
            errorMsg = t('api_error', 'APIã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
          }
          
          statusDiv.innerHTML = `<p style="color:#f44336;">${errorLabel} ${errorMsg}</p>`;
        }
      }
    }

    // æ‚£è€…ã®ç™ºè¨€ã‚’è©•ä¾¡
    async function evaluatePatientChat(patientText) {
      const evalPrompt = `
ä¿å¥å¸«ã®è¦–ç‚¹ã§ã€æ‚£è€…ã®ç™ºè¨€ã‹ã‚‰ã€ŒåŒ»å­¦çš„çŸ¥è­˜ã€ã¨ã€Œæ²»ç™‚ã¸ã®æ„æ€ã€ã‚’æŸ»å®šã—ã¦ãã ã•ã„ã€‚

ã€è©•ä¾¡åŸºæº–ã€‘
1: ä¼šè©±æ‹’å¦ï¼ˆå¯¾è©±ãŒæˆç«‹ã›ãšã€æ‹’çµ¶ã—ã¦ã„ã‚‹ï¼‰
2: çŸ¥è­˜ãªã—ãƒ»æ„æ€ãªã—ï¼ˆçµæ ¸ã‚’è»½è¦–ã—ã€æ²»ãã†ã¨ã™ã‚‹æ„æ€ã‚‚è¦‹ã‚‰ã‚Œãªã„ï¼‰
3: çŸ¥è­˜ãªã—ãƒ»æ„æ€ã‚ã‚Šï¼ˆæ²»ã—ãŸã„æ„æ¬²ã¯ã‚ã‚‹ãŒã€çŸ¥è­˜ä¸è¶³ã§èª¤è§£ã‚„ä¸å®‰ãŒå…ˆè¡Œã—ã¦ã„ã‚‹ï¼‰
4: çŸ¥è­˜ã‚ã‚Šãƒ»æ„æ€ãªã—ï¼ˆãƒ«ãƒ¼ãƒ«ã¯çŸ¥ã£ã¦ã„ã‚‹ãŒã€ç”Ÿæ´»ã®ä¸ä¾¿ã•ç­‰ã‚’ç†ç”±ã«æ„æ€ãŒä½ã„ï¼‰
5: çŸ¥è­˜ã‚ã‚Šãƒ»æ„æ€ã‚ã‚Šï¼ˆæ­£ç¢ºãªçŸ¥è­˜ã‚’æŒã¡ã€å®Œé‚ã«å‘ã‘ã¦éå¸¸ã«å‰å‘ãï¼‰

ã€å‡ºåŠ›å½¢å¼ï¼šJSONã€‘
{
  "knowledge_score": æ•°å€¤ï¼ˆ1-5ï¼‰,
  "analysis": {
    "knowledge_status": "çŸ¥è­˜ã®åˆ†æ",
    "intent_status": "æ„æ€ã®åˆ†æ"
  },
  "reason": "åˆ¤æ–­æ ¹æ‹ ï¼ˆ100æ–‡å­—ä»¥å†…ï¼‰"
}

ã€åˆ†æå¯¾è±¡ï¼šæ‚£è€…ã®ç™ºè¨€ã€‘
${patientText}
`;
      
      try {
        const response = await fetch('/api/evaluate-chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: evalPrompt, temperature: 0.0 })
        });
        
        if (!response.ok) throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${response.status}`);
        
        const data = await response.json();
        const result = JSON.parse(data.result || '{}');
        
        return {
          knowledge_score: result.knowledge_score || 3,
          reason: result.reason || '',
          knowledge_analysis: result.analysis?.knowledge_status || '',
          intent_analysis: result.analysis?.intent_status || ''
        };
      } catch (error) {
        console.error('è©•ä¾¡ã‚¨ãƒ©ãƒ¼:', error);
        return null;
      }
    }

    // è©•ä¾¡ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸã‚¯ã‚¤ã‚ºã‚’ç”Ÿæˆ
    async function generateQuizByLevel(level, container, statusDiv, evaluation = null) {
      try {
        // ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸé›£æ˜“åº¦ã¨ãƒˆãƒ”ãƒƒã‚¯ã‚’è¨­å®š
        let difficulty = 'easy';
        let topic = 'çµæ ¸ã®åŸºç¤çŸ¥è­˜';
        let count = 5;
        
        if (level <= 2) {
          difficulty = 'easy';
          topic = 'çµæ ¸ã¨ã¯ä½•ã‹ã€åŸºæœ¬çš„ãªç—‡çŠ¶ã¨æ„ŸæŸ“çµŒè·¯';
        } else if (level === 3) {
          difficulty = 'medium';
          topic = 'çµæ ¸ã®æ²»ç™‚æ–¹æ³•ã€æœè–¬ã®é‡è¦æ€§ã€å‰¯ä½œç”¨ã¸ã®å¯¾å‡¦';
        } else if (level === 4) {
          difficulty = 'medium';
          topic = 'DOTSï¼ˆç›´æ¥æœè–¬ç¢ºèªç™‚æ³•ï¼‰ã€æ²»ç™‚ç¶™ç¶šã®é‡è¦æ€§ã€å¤šå‰¤è€æ€§çµæ ¸';
        } else {
          difficulty = 'hard';
          topic = 'çµæ ¸ã®è©³ç´°ãªæ²»ç™‚ãƒ—ãƒ­ã‚»ã‚¹ã€æ¥è§¦è€…å¥è¨ºã€æ½œåœ¨æ€§çµæ ¸æ„ŸæŸ“ç—‡ã®æ²»ç™‚';
        }
        
        // ç¾åœ¨ã®è¨€èªè¨­å®šã‚’å–å¾—
        const currentLang = (window.multiLang && window.multiLang.currentLanguage) || 'ja';
        
        // æ—¥æœ¬èªä»¥å¤–ã®å ´åˆã¯ãƒˆãƒ”ãƒƒã‚¯ã‚’ç¿»è¨³
        let translatedTopic = topic;
        if (currentLang !== 'ja') {
          try {
            const translateResponse = await fetch('/api/translate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ text: topic, targetLang: currentLang })
            });
            if (translateResponse.ok) {
              const translateData = await translateResponse.json();
              if (translateData.translated) {
                translatedTopic = translateData.translated;
              }
            }
          } catch (translateError) {
            console.warn('ãƒˆãƒ”ãƒƒã‚¯ã®ç¿»è¨³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å…ƒã®ãƒˆãƒ”ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¾ã™:', translateError);
            // ç¿»è¨³ã«å¤±æ•—ã—ãŸå ´åˆã¯å…ƒã®ãƒˆãƒ”ãƒƒã‚¯ã‚’ä½¿ç”¨
          }
        }
        
        // ã‚¯ã‚¤ã‚ºç”ŸæˆAPIã‚’å‘¼ã³å‡ºã—
        let response;
        try {
          response = await fetch('/api/quiz', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              topic: translatedTopic,
              count: count,
              difficulty: difficulty,
              language: currentLang
            })
          });
        } catch (fetchError) {
          throw new Error(`ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${fetchError.message || 'APIã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ'}`);
        }
        
        if (!response.ok) {
          let errorData = { message: `HTTP ${response.status} ã‚¨ãƒ©ãƒ¼` };
          let errorText = '';
          
          try {
            // ã¾ãšãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦å–å¾—
            errorText = await response.text();
            console.error('API Error Response:', {
              status: response.status,
              statusText: response.statusText,
              body: errorText
            });
            
            // JSONã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹ã‚’è©¦ã¿ã‚‹
            if (errorText) {
              try {
                errorData = JSON.parse(errorText);
              } catch (parseError) {
                // JSONã§ãªã„å ´åˆã¯ãƒ†ã‚­ã‚¹ãƒˆã‚’ãã®ã¾ã¾ä½¿ç”¨
                errorData = { 
                  message: errorText.substring(0, 200) || `HTTP ${response.status} ã‚¨ãƒ©ãƒ¼`,
                  detail: errorText
                };
              }
            }
          } catch (textError) {
            console.error('Error reading response:', textError);
            errorData = { 
              message: `HTTP ${response.status} ã‚¨ãƒ©ãƒ¼: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®èª­ã¿å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸ`,
              detail: String(textError)
            };
          }
          
          const errorMessage = errorData.message || errorData.error || `ã‚¯ã‚¤ã‚ºç”ŸæˆAPIã‚¨ãƒ©ãƒ¼: ${response.status}`;
          console.error('Throwing error:', errorMessage);
          throw new Error(errorMessage);
        }
        
        const data = await response.json();
        
        if (!data || !data.questions) {
          throw new Error('APIã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒä¸æ­£ã§ã™');
        }
        
        const questions = data.questions || [];
        
        if (questions.length === 0) {
          throw new Error('ã‚¯ã‚¤ã‚ºãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
        }
        
        // ã‚¯ã‚¤ã‚ºã‚’è¡¨ç¤º
        currentPersonalizedQuiz = questions;
        currentQuizIndex = 0;
        personalizedQuizScore = 0;
        quizAnswers = []; // å›ç­”çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        
        if (statusDiv) {
          const message = t('level_quiz_generated', `ãƒ¬ãƒ™ãƒ« ${level} ã«åˆã‚ã›ãŸã‚¯ã‚¤ã‚ºã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼ˆ${questions.length}å•ï¼‰`)
            .replace('{level}', level)
            .replace('{count}', questions.length);
          statusDiv.innerHTML = `<p style="color:#2E7D32;">âœ… ${message}</p>`;
        }
        
        container.innerHTML = ''; // ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
        displayPersonalizedQuiz(questions[0], container, questions.length);
        
      } catch (error) {
        console.error('ã‚¯ã‚¤ã‚ºç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          name: error.name
        });
        
        if (statusDiv) {
          const errorLabel = t('error', 'ã‚¨ãƒ©ãƒ¼:');
          // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚ˆã‚Šè©³ç´°ã«è¡¨ç¤º
          let errorMsg = error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
          
          // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
          if (error.message && error.message.includes('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼')) {
            errorMsg = t('network_error', 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: APIã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          }
          // APIã‚¨ãƒ©ãƒ¼ã®å ´åˆ
          else if (error.message && (error.message.includes('500') || error.message.includes('HTTP'))) {
            errorMsg = t('api_error', 'APIã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
          }
          
          statusDiv.innerHTML = `<p style="color:#f44336;">${errorLabel} ${errorMsg}</p>`;
        }
      }
    }

    // ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºãƒ‰ã‚¯ã‚¤ã‚ºã‚’è¡¨ç¤ºï¼ˆ1å•ãšã¤è¡¨ç¤ºï¼‰
    function displayPersonalizedQuiz(question, container, totalQuestions) {
      const questionIndex = currentQuizIndex;
      const existingAnswer = quizAnswers[questionIndex];
      const isAnswered = existingAnswer && existingAnswer.answered;
      
      // ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢ã—ã¦ã€ç¾åœ¨ã®å•é¡Œã®ã¿ã‚’è¡¨ç¤º
      container.innerHTML = '';
      
      // æ–°ã—ã„å•é¡Œã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
      const quizCard = document.createElement('div');
      quizCard.className = 'quiz-card';
      quizCard.setAttribute('data-question-index', questionIndex);
      quizCard.style.cssText = 'background: #fff; border-radius: 12px; padding: 24px; border: 2px solid #fff; margin-bottom: 16px; box-shadow: 0 2px 12px rgba(46, 125, 50, 0.1);';
      container.appendChild(quizCard);
      
      // å•é¡Œã‚«ãƒ¼ãƒ‰ã®å†…å®¹ã‚’è¨­å®š
      quizCard.innerHTML = `
        <div style="text-align: center; margin-bottom: 16px; color: #2E7D32; font-weight: 600;">
          ${t('question_number', 'å•é¡Œ')} ${questionIndex + 1} / ${totalQuestions}
        </div>
        <h3 style="font-size: 1.2em; margin-bottom: 20px; color: #1B5E20; line-height: 1.6;">
          ${escapeHtml(question.question)}
        </h3>
        <div class="quiz-choices" style="display: grid; gap: 12px; margin-bottom: 20px;">
          ${question.choices.map((choice, index) => {
            const isCorrect = choice === question.answer;
            const isSelected = isAnswered && existingAnswer.selectedChoice === choice;
            const isWrongSelected = isAnswered && isSelected && !existingAnswer.isCorrect;
            
            let buttonStyle = 'padding: 14px 20px; background: #fff; border: 2px solid #C8E6C9; border-radius: 10px; text-align: left; font-size: 1em; transition: all 0.2s; color: #2E7D32;';
            let hoverStyle = '';
            
            if (isAnswered) {
              // å›ç­”æ¸ˆã¿ã®å ´åˆ
              if (isCorrect) {
                // æ­£è§£ã¯èµ¤è‰²
                buttonStyle = 'padding: 14px 20px; background: #f44336; border: 2px solid #d32f2f; border-radius: 10px; text-align: left; font-size: 1em; color: #fff; cursor: default;';
              } else if (isWrongSelected) {
                // é¸æŠã—ãŸä¸æ­£è§£ã¯é’è‰²
                buttonStyle = 'padding: 14px 20px; background: #2196F3; border: 2px solid #1976D2; border-radius: 10px; text-align: left; font-size: 1em; color: #fff; cursor: default;';
              } else {
                // ãã®ä»–ã®é¸æŠè‚¢ã¯ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ
                buttonStyle = 'padding: 14px 20px; background: #f5f5f5; border: 2px solid #e0e0e0; border-radius: 10px; text-align: left; font-size: 1em; color: #999; cursor: default;';
              }
            } else {
              // æœªå›ç­”ã®å ´åˆã¯ãƒ›ãƒãƒ¼åŠ¹æœã‚’è¿½åŠ 
              hoverStyle = `onmouseover="this.style.borderColor='#4CAF50'; this.style.background='#E8F5E9';" onmouseout="this.style.borderColor='#C8E6C9'; this.style.background='#fff';"`;
            }
            
            return `
              <button class="choice-btn" data-choice="${escapeHtml(choice)}" 
                      data-is-correct="${isCorrect}"
                      style="${buttonStyle}"
                      ${hoverStyle}
                      ${isAnswered ? 'disabled' : ''}>
                ${String.fromCharCode(65 + index)}. ${escapeHtml(choice)}
                ${isCorrect && isAnswered ? ' âœ“' : ''}
              </button>
            `;
          }).join('')}
        </div>
        <div class="quiz-explanation" style="display: ${isAnswered ? 'block' : 'none'}; padding: 16px; background: #E8F5E9; border-radius: 8px; 
                                            border-left: 4px solid #4CAF50; margin-top: 16px;">
          <strong style="color: #2E7D32;">${t('explanation', 'è§£èª¬ï¼š')}</strong>
          <p style="margin-top: 8px; color: #1B5E20; line-height: 1.6;">${escapeHtml(question.explanation)}</p>
        </div>
        <div class="quiz-navigation" style="display: ${isAnswered ? 'block' : 'none'}; text-align: center; margin-top: 20px;">
          <button class="quiz-btn" onclick="nextPersonalizedQuestion(${totalQuestions})" 
                  style="font-size: 1em; padding: 12px 24px;">
            ${questionIndex + 1 === totalQuestions ? t('view_results', 'çµæœã‚’è¦‹ã‚‹') : t('next_question', 'æ¬¡ã¸')}
          </button>
        </div>
      `;
      
      // æœªå›ç­”ã®å ´åˆã®ã¿ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      if (!isAnswered) {
        quizCard.querySelectorAll('.choice-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            if (this.disabled) return;
            
            const selectedChoice = this.dataset.choice;
            const isCorrect = selectedChoice === question.answer;
            
            // å›ç­”çŠ¶æ…‹ã‚’ä¿å­˜
            quizAnswers[questionIndex] = {
              questionIndex: questionIndex,
              selectedChoice: selectedChoice,
              isCorrect: isCorrect,
              answered: true
            };
            
            if (isCorrect) {
              personalizedQuizScore++;
            }
            
            // å•é¡Œã‚’å†è¡¨ç¤ºã—ã¦å›ç­”çŠ¶æ…‹ã‚’åæ˜ 
            displayPersonalizedQuiz(question, container, totalQuestions);
          });
        });
      }
    }

    // æ¬¡ã®å•é¡Œã¸
    function nextPersonalizedQuestion(totalQuestions) {
      currentQuizIndex++;
      const container = document.getElementById('personalized-quiz-container');
      
      if (currentQuizIndex >= totalQuestions) {
        // ã‚¯ã‚¤ã‚ºçµ‚äº†
        showPersonalizedQuizResult(totalQuestions);
      } else {
        displayPersonalizedQuiz(currentPersonalizedQuiz[currentQuizIndex], container, totalQuestions);
      }
    }

    // ã‚¯ã‚¤ã‚ºçµæœã‚’è¡¨ç¤º
    function showPersonalizedQuizResult(totalQuestions) {
      const container = document.getElementById('personalized-quiz-container');
      const accuracy = Math.round((personalizedQuizScore / totalQuestions) * 100);
      
      container.innerHTML = `
        <div class="quiz-result-card" style="background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%); 
                                           border-radius: 18px; padding: 40px; text-align: center; color: #fff; box-shadow: 0 4px 24px rgba(46, 125, 50, 0.3);">
          <h2 style="font-size: 2em; margin-bottom: 20px; color: #fff;">ğŸ‰ ã‚¯ã‚¤ã‚ºå®Œäº†ï¼</h2>
          <div style="font-size: 3em; margin: 20px 0; font-weight: bold;">
            ${personalizedQuizScore} / ${totalQuestions}
          </div>
          <div style="font-size: 1.5em; margin-bottom: 30px;">
            ${t('accuracy_rate_label', 'æ­£ç­”ç‡:')} ${accuracy}%
          </div>
          <button class="quiz-btn" onclick="generatePersonalizedQuiz()" 
                  style="background: #fff; color: #2E7D32; font-size: 1.1em; padding: 14px 32px; box-shadow: 0 2px 12px rgba(255,255,255,0.3);">
            ${t('retry_quiz', 'ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦')}
          </button>
          <button class="quiz-btn" onclick="location.reload()" 
                  style="background: rgba(255,255,255,0.2); color: #fff; font-size: 1.1em; padding: 14px 32px; margin-left: 10px; border: 2px solid rgba(255,255,255,0.3);">
            ${t('back_to_results', 'çµæœãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹')}
          </button>
        </div>
      `;
      
      // ã‚¹ã‚³ã‚¢ã‚’Firebaseã«ä¿å­˜
      savePersonalizedQuizScore(personalizedQuizScore, totalQuestions, accuracy);
    }

    // ã‚¹ã‚³ã‚¢ã‚’Firebaseã«ä¿å­˜
    async function savePersonalizedQuizScore(score, total, accuracy) {
      try {
        const currentUser = firebase.auth().currentUser;
        if (!currentUser) return;
        
        const db = firebase.firestore();
        await db.collection('personalized_quiz_scores').add({
          userId: currentUser.uid,
          score: score,
          total: total,
          accuracy: accuracy,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (error) {
        console.error('ã‚¹ã‚³ã‚¢ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ¶å¾¡ï¼ˆãƒ¢ãƒã‚¤ãƒ«ç‰ˆã®ã¿ï¼‰
    const scrollToTopBtn = document.getElementById('scrollToTop');
    if (scrollToTopBtn) {
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º/éè¡¨ç¤º
      function toggleScrollToTop() {
        if (window.innerWidth <= 768) {
          if (window.pageYOffset > 300) {
            scrollToTopBtn.classList.add('visible');
          } else {
            scrollToTopBtn.classList.remove('visible');
          }
        } else {
          scrollToTopBtn.classList.remove('visible');
        }
      }

      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
      window.addEventListener('scroll', toggleScrollToTop);
      // ãƒªã‚µã‚¤ã‚ºã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç”»é¢ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ï¼‰
      window.addEventListener('resize', toggleScrollToTop);
      // åˆæœŸãƒã‚§ãƒƒã‚¯
      toggleScrollToTop();

      // ã‚¯ãƒªãƒƒã‚¯ã§ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      scrollToTopBtn.addEventListener('click', () => {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });
    }
  </script>


  <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <nav class="mobile-nav">
    <a href="ai.html" class="nav-item">
      <i class="fa-solid fa-house"></i>
      <span data-translate="chat">ãƒãƒ£ãƒƒãƒˆ</span>
    </a>
    <a href="score.html" class="nav-item active">
      <i class="fa-solid fa-magnifying-glass"></i>
      <span data-translate="quiz">Q&A</span>
    </a>
    <a href="movie.html" class="nav-item">
      <i class="fa-regular fa-clock"></i>
      <span data-translate="video_watching">å‹•ç”»</span>
    </a>
    <a href="setting.html" class="nav-item">
      <i class="fa-regular fa-user"></i>
      <span data-translate="settings">è¨­å®š</span>
    </a>
  </nav>

  <!-- âœ… ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆfooter.css ã®è¨­è¨ˆé€šã‚Šï¼šfooterã®ä¸­ã« .container ã‚’å…¥ã‚Œã‚‹ï¼‰ -->
  <footer class="footer">
    <div class="container">
      <small>
        <a href="#" data-translate="terms">åˆ©ç”¨è¦ç´„</a>
        <a href="#" data-translate="privacy">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a><br>
        &copy; <span data-translate="copyright_name">ã‚¹ãƒãƒ¼ãƒˆåŒ»ç™‚ãƒãƒ¼ã‚¿ãƒ«</span>
      </small>
    </div>
  </footer>
</body>
</html>