<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="„ÇØ„Ç§„Ç∫ÁµêÊûú">„ÇØ„Ç§„Ç∫ÁµêÊûú</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
         <link rel="stylesheet" href="maintab.css">
     <style>
       /* Â≠¶ÁøíÈÄ≤Êçó„Çª„ÇØ„Ç∑„Éß„É≥ */
       .progress-section {
         margin: 40px 0;
         padding: 30px;
         background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
         border-radius: 20px;
         color: white;
         box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
       }
       
       .progress-section h2 {
         text-align: center;
         margin-bottom: 30px;
         font-size: 2em;
         font-weight: 300;
         text-shadow: 0 2px 4px rgba(0,0,0,0.3);
       }
       
       .progress-grid {
         display: grid;
         grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
         gap: 25px;
         margin-top: 30px;
       }
       
       .progress-card {
         background: rgba(255, 255, 255, 0.1);
         backdrop-filter: blur(10px);
         border-radius: 15px;
         padding: 25px;
         text-align: center;
         border: 1px solid rgba(255, 255, 255, 0.2);
         transition: all 0.3s ease;
       }
       
       .progress-card:hover {
         transform: translateY(-5px);
         background: rgba(255, 255, 255, 0.15);
         box-shadow: 0 15px 35px rgba(0,0,0,0.2);
       }
       
       .progress-icon {
         font-size: 3em;
         margin-bottom: 15px;
         display: block;
       }
       
       .progress-card h3 {
         margin: 0 0 15px 0;
         font-size: 1.1em;
         font-weight: 500;
         opacity: 0.9;
       }
       
       .progress-value {
         font-size: 2.5em;
         font-weight: bold;
         margin-bottom: 20px;
         text-shadow: 0 2px 4px rgba(0,0,0,0.3);
       }
       
       .progress-bar {
         width: 100%;
         height: 8px;
         background: rgba(255, 255, 255, 0.2);
         border-radius: 4px;
         overflow: hidden;
       }
       
       .progress-fill {
         height: 100%;
         background: linear-gradient(90deg, #4CAF50, #8BC34A);
         border-radius: 4px;
         transition: width 1s ease, background-color 0.5s ease;
         width: 0%;
       }
       
       /* „Çπ„Ç≥„Ç¢„Çª„ÇØ„Ç∑„Éß„É≥ */
       .scores-section {
         margin: 40px 0;
         padding: 30px;
         background: #f8f9fa;
         border-radius: 20px;
         box-shadow: 0 5px 20px rgba(0,0,0,0.08);
       }
       
       .scores-section h2 {
         text-align: center;
         margin-bottom: 30px;
         color: #333;
         font-size: 2em;
         font-weight: 300;
       }
       
       /* „Çπ„Ç≥„Ç¢„Ç´„Éº„Éâ */
       .score-card {
         background: white;
         border-radius: 15px;
         padding: 25px;
         margin-bottom: 20px;
         box-shadow: 0 5px 20px rgba(0,0,0,0.08);
         border: 1px solid #e9ecef;
         transition: all 0.3s ease;
         position: relative;
         overflow: hidden;
       }
       
       .score-card:hover {
         transform: translateY(-3px);
         box-shadow: 0 10px 30px rgba(0,0,0,0.15);
       }
       
       .score-card.best-score {
         border: 2px solid #ffd700;
         background: linear-gradient(135deg, #fff9c4 0%, #ffffff 100%);
         box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
       }
       
       .score-card-header {
         display: flex;
         justify-content: space-between;
         align-items: center;
         margin-bottom: 20px;
         padding-bottom: 15px;
         border-bottom: 2px solid #f0f0f0;
       }
       
       .score-card-date {
         display: flex;
         align-items: center;
         color: #666;
         font-size: 0.9em;
       }
       
       .date-icon {
         margin-right: 8px;
         font-size: 1.2em;
       }
       
       .score-card-rank {
         display: flex;
         gap: 10px;
       }
       
       .rank-badge {
         padding: 6px 12px;
         border-radius: 20px;
         font-size: 0.8em;
         font-weight: bold;
         text-transform: uppercase;
         letter-spacing: 0.5px;
       }
       
       .rank-s { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #b8860b; }
       .rank-a { background: linear-gradient(135deg, #c0c0c0, #e5e5e5); color: #666; }
       .rank-b { background: linear-gradient(135deg, #cd7f32, #daa520); color: #8b4513; }
       .rank-c { background: linear-gradient(135deg, #ff6b6b, #ff8e8e); color: #c41e3a; }
       .rank-d { background: linear-gradient(135deg, #6c757d, #868e96); color: #495057; }
       
       .score-card-body {
         display: grid;
         grid-template-columns: 1fr 1fr;
         gap: 25px;
         align-items: center;
       }
       
       .score-card-main {
         text-align: center;
       }
       
       .score-accuracy, .score-correct {
         margin-bottom: 20px;
       }
       
       .accuracy-label, .correct-label {
         display: block;
         font-size: 0.9em;
         color: #666;
         margin-bottom: 5px;
         text-transform: uppercase;
         letter-spacing: 0.5px;
       }
       
       .accuracy-value {
         display: block;
         font-size: 2.5em;
         font-weight: bold;
         color: #1976d2;
       }
       
       .correct-value {
         display: block;
         font-size: 1.8em;
         font-weight: bold;
         color: #4caf50;
       }
       
       .score-card-details {
         display: flex;
         flex-direction: column;
         gap: 15px;
       }
       
       .detail-item {
         display: flex;
         align-items: center;
         gap: 10px;
         padding: 10px;
         background: #f8f9fa;
         border-radius: 8px;
       }
       
       .detail-icon {
         font-size: 1.2em;
       }
       
       .detail-label {
         font-weight: 500;
         color: #666;
         min-width: 80px;
       }
       
       .detail-value {
         font-weight: 600;
         color: #333;
       }
       
       .best-score-badge {
         position: absolute;
         top: 15px;
         right: 15px;
         background: linear-gradient(135deg, #ffd700, #ffed4e);
         color: #b8860b;
         padding: 8px 15px;
         border-radius: 20px;
         font-size: 0.8em;
         font-weight: bold;
         box-shadow: 0 3px 10px rgba(255, 215, 0, 0.3);
         animation: pulse 2s infinite;
       }
       
       @keyframes pulse {
         0% { transform: scale(1); }
         50% { transform: scale(1.05); }
         100% { transform: scale(1); }
       }
       
       /* „Çπ„Ç≥„Ç¢„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏ */
       .no-scores-message {
         text-align: center;
         padding: 60px 20px;
         color: #666;
       }
       
       .no-scores-icon {
         font-size: 4em;
         margin-bottom: 20px;
         opacity: 0.5;
       }
       
       .no-scores-message h3 {
         margin: 0 0 15px 0;
         color: #333;
         font-size: 1.5em;
         font-weight: 300;
       }
       
       .no-scores-message p {
         margin: 0;
         font-size: 1.1em;
         line-height: 1.6;
       }
       
       /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ„Éá„Ç∂„Ç§„É≥ */
       @media (max-width: 768px) {
         .progress-grid {
           grid-template-columns: 1fr;
           gap: 20px;
         }
         
         .score-card-body {
           grid-template-columns: 1fr;
           gap: 20px;
         }
         
         .score-card-header {
           flex-direction: column;
           gap: 15px;
           align-items: flex-start;
         }
         
         .progress-section, .scores-section {
           padding: 20px;
           margin: 20px 0;
         }
       }
     </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- ÁøªË®≥Ê©üËÉΩ -->
    <script src="translation.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 data-translate="ÂåªÁôÇÊÉÖÂ†±ÁÆ°ÁêÜ„Ç¢„Éó„É™">ÂåªÁôÇÊÉÖÂ†±ÁÆ°ÁêÜ„Ç¢„Éó„É™</h1>
    </div>
      
    <div class="tab-container">
        <div class="tab-header">
         
          <button class="tab-button" onclick="location.href='ai.html'">
            <span class="tab-icon">üí¨</span>
            <span class="tab-text" data-translate="„ÉÅ„É£„ÉÉ„Éà">„ÉÅ„É£„ÉÉ„Éà</span>
          </button>
          <button class="tab-button active" onclick="location.href='score.html'">
            <span class="tab-icon">‚ùì</span>
            <span class="tab-text" data-translate="Q&A">Q&A</span>
          </button>
          <button class="tab-button" onclick="location.href='movie.html'">
            <span class="tab-icon">üé¨</span>
            <span class="tab-text" data-translate="ÂãïÁîªË¶ñËÅ¥">ÂãïÁîªË¶ñËÅ¥</span>
          </button>
          <button class="tab-button" onclick="location.href='profile.html'">
            <span class="tab-icon">üë§</span>
            <span class="tab-text" data-translate="„Éó„É≠„Éï„Ç£„Éº„É´">„Éó„É≠„Éï„Ç£„Éº„É´</span>
          </button>
        </div>
    </div>
    <!-- „ÇØ„Ç§„Ç∫„ÅÆ„Çπ„Ç≥„Ç¢Ë°®Á§∫„Å®„É©„É≥„ÇØË°®Á§∫„ÅÆÁîªÈù¢ -->
    <!-- „ÇØ„Ç§„Ç∫„ÅÆ„Çπ„Ç≥„Ç¢„Å®„É©„É≥„ÇØ„Çífirebase„ÅÆmovie_quiz_scores„Åã„ÇâÂèçÊò†„Åô„ÇãÁîªÈù¢ -->

         <div class="stats-container">
         <div class="stats-card">
             <h2 data-translate="„ÇØ„Ç§„Ç∫ÊàêÁ∏æÊé®Áßª">üìä „ÇØ„Ç§„Ç∫ÊàêÁ∏æÊé®Áßª</h2>
             <div class="chart-container" style="
                 background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
                 border-radius: 20px;
                 padding: 30px;
                 box-shadow: 0 8px 32px rgba(0,0,0,0.1);
                 border: 1px solid #e9ecef;
                 margin: 20px 0;
                 min-height: 400px;
             ">
                 <canvas id="movieScoreChart"></canvas>
             </div>
         </div>
     </div>

     <!-- „ÇØ„Ç§„Ç∫ÈñãÂßã„Éú„Çø„É≥ -->
     <div style="text-align: center; margin: 30px 0;">
                   <button onclick="location.href='allq&a.html'" class="quiz-btn" style="
             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
             color: white;
             border: none;
             padding: 15px 30px;
             font-size: 1.2em;
             border-radius: 25px;
             cursor: pointer;
             box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
             transition: all 0.3s ease;
             font-weight: bold;
         " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.6)'" 
         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)'">
             üéØ „ÇØ„Ç§„Ç∫„ÇíÈñãÂßã„Åô„Çã
         </button>
         <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
             Êñ∞„Åó„ÅÑ„ÇØ„Ç§„Ç∫„Å´ÊåëÊà¶„Åó„Å¶„ÄÅÊàêÁ∏æ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Çá„ÅÜÔºÅ
         </p>
     </div>

           <!-- Â≠¶ÁøíÈÄ≤Êçó„Çª„ÇØ„Ç∑„Éß„É≥ -->
      <div class="progress-section">
        <h2 data-translate="Â≠¶ÁøíÈÄ≤Êçó">Â≠¶ÁøíÈÄ≤Êçó</h2>
        <div class="progress-grid">
          <div class="progress-card">
            <div class="progress-icon">üìö</div>
            <h3>Â≠¶ÁøíÁ∂ôÁ∂öÊó•Êï∞</h3>
            <div class="progress-value" id="learning-days">0Êó•</div>
            <div class="progress-bar">
              <div class="progress-fill" id="learning-days-bar"></div>
            </div>
          </div>
          
          <div class="progress-card">
            <div class="progress-icon">üéØ</div>
            <h3>ÁõÆÊ®ôÈÅîÊàêÁéá</h3>
            <div class="progress-value" id="goal-achievement">0%</div>
            <div class="progress-bar">
              <div class="progress-fill" id="goal-achievement-bar"></div>
            </div>
          </div>
          
          <div class="progress-card">
            <div class="progress-icon">üî•</div>
            <h3>ÈÄ£Á∂öÊ≠£Ëß£</h3>
            <div class="progress-value" id="streak">0Âïè</div>
            <div class="progress-bar">
              <div class="progress-fill" id="streak-bar"></div>
            </div>
          </div>
          
          <div class="progress-card">
            <div class="progress-icon">‚≠ê</div>
            <h3>„É¨„Éô„É´</h3>
            <div class="progress-value" id="level">ÂàùÂøÉËÄÖ</div>
            <div class="progress-bar">
              <div class="progress-fill" id="level-bar"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- „Çπ„Ç≥„Ç¢Ë°®Á§∫„Ç®„É™„Ç¢ -->
      <div class="scores-section">
        <h2 data-translate="„ÇØ„Ç§„Ç∫Â±•Ê≠¥">„ÇØ„Ç§„Ç∫Â±•Ê≠¥</h2>
        <div id="scores-container"></div>
      </div>
  </div>
  <script>
    // Firebase„ÅÆË®≠ÂÆö
    const firebaseConfig = {
        apiKey: "AIzaSyC31W-TEE7mIBGFwrRxJAuPugjnEFfWe_k",
        authDomain: "web01-2484d.firebaseapp.com",
        projectId: "web01-2484d",
        storageBucket: "web01-2484d.appspot.com",
        messagingSenderId: "90159472898",
        appId: "1:90159472898:web:261ec71f9919611011e21b"
    };
    firebase.initializeApp(firebaseConfig);

    let movieScoreChart = null;

    // ÂãïÁîª„ÇØ„Ç§„Ç∫„Çπ„Ç≥„Ç¢„ÇíÂèñÂæó
    async function loadMovieScores(userId) {
      try {
        const db = firebase.firestore();
        const snapshot = await db.collection('movie_quiz_scores')
          .where('userId', '==', userId)
          .orderBy('timestamp', 'desc')
          .get();
        
        const scores = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          scores.push({
            ...data,
            id: doc.id,
            quizType: 'movie'
          });
        });
        
        return scores;
      } catch (e) {
        console.error("ÂãïÁîª„ÇØ„Ç§„Ç∫„Çπ„Ç≥„Ç¢„ÅÆÂèñÂæó„Å´Â§±Êïó:", e);
        return [];
      }
    }

    // AI„ÇØ„Ç§„Ç∫„Çπ„Ç≥„Ç¢„ÇíÂèñÂæó
    async function loadAIQuizScores(userId) {
      try {
        console.log("loadAIQuizScoresÈñãÂßã - userId:", userId);
        const db = firebase.firestore();
        
        // „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Ç®„É©„Éº„ÇíÈÅø„Åë„Çã„Åü„ÇÅ„ÄÅorderBy„Çí‰∏ÄÊôÇÁöÑ„Å´ÂâäÈô§
        console.log("ai_quiz_scores„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Åã„Çâ„ÇØ„Ç®„É™ÂÆüË°å‰∏≠...");
        const snapshot = await db.collection('ai_quiz_scores')
          .where('userId', '==', userId)
          .get();
        
        console.log("„ÇØ„Ç®„É™ÁµêÊûú - „Éâ„Ç≠„É•„É°„É≥„ÉàÊï∞:", snapshot.size);
        
        const scores = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          console.log("„Éâ„Ç≠„É•„É°„É≥„Éà„Éá„Éº„Çø:", doc.id, data);
          scores.push({
            ...data,
            id: doc.id,
            quizType: 'ai'
          });
        });
        
        console.log("Âá¶ÁêÜÂâç„ÅÆ„Çπ„Ç≥„Ç¢ÈÖçÂàó:", scores);
        
        // „ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂÅ¥„Åß„ÇΩ„Éº„Éà
        scores.sort((a, b) => {
          const ta = a.timestamp && typeof a.timestamp.toDate === "function" 
            ? a.timestamp.toDate() 
            : new Date(a.timestamp);
          const tb = b.timestamp && typeof b.timestamp.toDate === "function" 
            ? b.timestamp.toDate() 
            : new Date(b.timestamp);
          return tb - ta; // ÈôçÈ†Ü
        });
        
        console.log("„ÇΩ„Éº„ÉàÂæå„ÅÆ„Çπ„Ç≥„Ç¢ÈÖçÂàó:", scores);
        return scores;
      } catch (e) {
        console.error("AI„ÇØ„Ç§„Ç∫„Çπ„Ç≥„Ç¢„ÅÆÂèñÂæó„Å´Â§±Êïó:", e);
        return [];
      }
    }

    // AI„ÇØ„Ç§„Ç∫„Çπ„Ç≥„Ç¢„ÅÆ„Åø„ÇíÂèñÂæó„Åó„ÄÅ„Ç∞„É©„Éï„Å®„Ç´„Éº„Éâ„Å´ÂèçÊò†
    async function loadAIQuizScoresOnly(userId) {
      try {
        console.log("AI„ÇØ„Ç§„Ç∫„Çπ„Ç≥„Ç¢„ÇíÂèñÂæó‰∏≠...");
        const aiScores = await loadAIQuizScores(userId);
        console.log("ÂèñÂæó„Åï„Çå„ÅüAI„ÇØ„Ç§„Ç∫„Çπ„Ç≥„Ç¢:", aiScores);
        
        if (aiScores.length === 0) {
          console.log("AI„ÇØ„Ç§„Ç∫„Çπ„Ç≥„Ç¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì");
          updateMovieScoreChart([]);
          renderMovieScores([]);
          return;
        }
        
        console.log(`${aiScores.length}‰ª∂„ÅÆAI„ÇØ„Ç§„Ç∫„Çπ„Ç≥„Ç¢„ÇíÂá¶ÁêÜ‰∏≠...`);
        updateMovieScoreChart(aiScores);
        renderMovieScores(aiScores);
        updateStatistics(aiScores);
        
      } catch (e) {
        console.error("AI„ÇØ„Ç§„Ç∫„Çπ„Ç≥„Ç¢„ÅÆÂèñÂæó„Å´Â§±Êïó:", e);
        // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„Çí„É¶„Éº„Ç∂„Éº„Å´Ë°®Á§∫
        const scoresContainer = document.getElementById('scores-container');
        if (scoresContainer) {
          scoresContainer.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #666;">
              <p>AI„ÇØ„Ç§„Ç∫„ÅÆÁµêÊûú„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</p>
              <p>„Ç®„É©„Éº: ${e.message}</p>
              <p>„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
            </div>
          `;
        }
        updateMovieScoreChart([]);
        renderMovieScores([]);
      }
    }

    // Ê≠£Á≠îÁéá„Åã„Çâ„É©„É≥„ÇØ„ÇíÂà§ÂÆöÔºàÂÄãÂà•„ÇØ„Ç§„Ç∫„ÅÆ„É©„É≥„ÇØË°®Á§∫Áî®Ôºâ
    function getRank(accuracy) {
      if (accuracy === null || accuracy === undefined) return { label: 'N/A', class: 'rank-d' };
      if (accuracy >= 90) return { label: 'S', class: 'rank-s' };
      if (accuracy >= 80) return { label: 'A', class: 'rank-a' };
      if (accuracy >= 60) return { label: 'B', class: 'rank-b' };
      if (accuracy >= 40) return { label: 'C', class: 'rank-c' };
      return { label: 'D', class: 'rank-d' };
    }

    // „ÇØ„Ç§„Ç∫ÊàêÁ∏æÊé®Áßª„Ç∞„É©„Éï
    function updateMovieScoreChart(scores) {
      const ctx = document.getElementById('movieScoreChart').getContext('2d');
      if (movieScoreChart) movieScoreChart.destroy();
      
      if (!scores || scores.length === 0) {
        movieScoreChart = new Chart(ctx, {
          type: 'line',
          data: { 
            labels: [], 
            datasets: [
              { label: 'Ê≠£Á≠îÁéá', data: [] },
              { label: 'Ê≠£Ëß£Êï∞', data: [] }
            ] 
          },
          options: { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: '„ÇØ„Ç§„Ç∫ÊàêÁ∏æÊé®Áßª'
              }
            }
          }
        });
        return;
      }
      
      // Êó•‰ªòÈ†Ü„Å´„ÇΩ„Éº„Éà
      const sortedScores = scores.slice().sort((a, b) => {
        const ta = a.timestamp && typeof a.timestamp.toDate === "function" 
          ? a.timestamp.toDate() 
          : new Date(a.timestamp);
        const tb = b.timestamp && typeof b.timestamp.toDate === "function" 
          ? b.timestamp.toDate() 
          : new Date(b.timestamp);
        return ta - tb;
      });
      
      const labels = sortedScores.map(score => {
        let d = score.timestamp && typeof score.timestamp.toDate === "function"
          ? score.timestamp.toDate()
          : new Date(score.timestamp);
        return d.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
      });
      
      const accuracyData = sortedScores.map(score => parseFloat(score.accuracy) || 0);
      const correctData = sortedScores.map(score => score.correct || 0);

      movieScoreChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Ê≠£Á≠îÁéá (%)',
              data: accuracyData,
              borderColor: '#667eea',
              backgroundColor: 'rgba(102, 126, 234, 0.15)',
              borderWidth: 3,
              tension: 0.4,
              fill: true,
              yAxisID: 'y',
              pointBackgroundColor: '#667eea',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 6,
              pointHoverRadius: 8,
              pointHoverBorderWidth: 3
            },
            {
              label: 'Ê≠£Ëß£Êï∞',
              data: correctData,
              borderColor: '#f093fb',
              backgroundColor: 'rgba(240, 147, 251, 0.15)',
              borderWidth: 3,
              tension: 0.4,
              fill: false,
              yAxisID: 'y1',
              pointBackgroundColor: '#f093fb',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 6,
              pointHoverRadius: 8,
              pointHoverBorderWidth: 3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            title: {
              display: true,
              text: 'üìà „ÇØ„Ç§„Ç∫ÊàêÁ∏æÊé®Áßª',
              font: {
                size: 20,
                weight: 'bold',
                family: "'Noto Sans JP', sans-serif"
              },
              color: '#2c3e50',
              padding: {
                top: 10,
                bottom: 20
              }
            },
            legend: {
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 20,
                font: {
                  size: 14,
                  family: "'Noto Sans JP', sans-serif"
                },
                color: '#34495e'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(255, 255, 255, 0.95)',
              titleColor: '#2c3e50',
              bodyColor: '#34495e',
              borderColor: '#bdc3c7',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  if (context.dataset.label === 'Ê≠£Á≠îÁéá (%)') {
                    return `üìä Ê≠£Á≠îÁéá: ${context.parsed.y}%`;
                  } else {
                    return `üéØ Ê≠£Ëß£Êï∞: ${context.parsed.y}Âïè`;
                  }
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'üìÖ Êó•‰ªò',
                font: {
                  size: 14,
                  weight: 'bold'
                },
                color: '#34495e'
              },
              grid: {
                color: 'rgba(189, 195, 199, 0.3)',
                lineWidth: 1
              },
              ticks: {
                color: '#7f8c8d',
                font: {
                  size: 12
                }
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: 'üìä Ê≠£Á≠îÁéá (%)',
                font: {
                  size: 14,
                  weight: 'bold'
                },
                color: '#34495e'
              },
              grid: {
                color: 'rgba(189, 195, 199, 0.3)',
                lineWidth: 1
              },
              ticks: {
                color: '#7f8c8d',
                font: {
                  size: 12
                },
                callback: function(value) {
                  return value + '%';
                }
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              beginAtZero: true,
              title: {
                display: true,
                text: 'üéØ Ê≠£Ëß£Êï∞',
                font: {
                  size: 14,
                  weight: 'bold'
                },
                color: '#34495e'
              },
              grid: {
                drawOnChartArea: false,
                color: 'rgba(189, 195, 199, 0.3)',
                lineWidth: 1
              },
              ticks: {
                color: '#7f8c8d',
                font: {
                  size: 12
                }
              }
            }
          },
          elements: {
            line: {
              borderWidth: 3
            }
          },
          animation: {
            duration: 2000,
            easing: 'easeInOutQuart'
          }
        }
      });
    }

         // Áµ±Ë®àÊÉÖÂ†±„ÇíÊõ¥Êñ∞
     function updateStatistics(scores) {
       console.log("updateStatisticsÈñãÂßã - scores:", scores);
       if (!scores || scores.length === 0) {
         console.log("Áµ±Ë®àÊÉÖÂ†±Êõ¥Êñ∞: „Çπ„Ç≥„Ç¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì");
         return;
       }
       
       const totalQuizzes = scores.length;
       const totalCorrect = scores.reduce((sum, score) => sum + (score.correct || 0), 0);
       const totalQuestions = scores.reduce((sum, score) => sum + (score.total || 0), 0);
       const averageAccuracy = scores.reduce((sum, score) => sum + (parseFloat(score.accuracy) || 0), 0) / totalQuizzes;
       
       console.log("Áµ±Ë®àË®àÁÆóÁµêÊûú:", {
         totalQuizzes,
         totalCorrect,
         totalQuestions,
         averageAccuracy
       });
       
       // Áµ±Ë®à„Ç´„Éº„Éâ„ÇíÊõ¥Êñ∞
       const statsContainer = document.querySelector('.stats-container');
       if (statsContainer) {
         const existingStats = statsContainer.querySelector('.stats-summary');
         if (existingStats) {
           existingStats.remove();
         }
         
         const statsSummary = document.createElement('div');
         statsSummary.className = 'stats-summary';
         statsSummary.innerHTML = `
           <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
             <div style="background: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 20px; text-align: center;">
               <h3 style="margin: 0 0 10px 0; color: #1976d2;">Á∑è„ÇØ„Ç§„Ç∫Êï∞</h3>
               <p style="font-size: 2em; font-weight: bold; margin: 0; color: #1976d2;">${totalQuizzes}</p>
             </div>
             <div style="background: #e8f5e8; border: 1px solid #4caf50; border-radius: 8px; padding: 20px; text-align: center;">
               <h3 style="margin: 0 0 10px 0; color: #388e3c;">Á∑èÊ≠£Ëß£Êï∞</h3>
               <p style="font-size: 2em; font-weight: bold; margin: 0; color: #388e3c;">${totalCorrect}</p>
             </div>
             <div style="background: #fff3e0; border: 1px solid #ff9800; border-radius: 8px; padding: 20px; text-align: center;">
               <h3 style="margin: 0 0 10px 0; color: #f57c00;">Á∑èÂïèÈ°åÊï∞</h3>
               <p style="font-size: 2em; font-weight: bold; margin: 0; color: #f57c00;">${totalQuestions}</p>
             </div>
             <div style="background: #fce4ec; border: 1px solid #e91e63; border-radius: 8px; padding: 20px; text-align: center;">
               <h3 style="margin: 0 0 10px 0; color: #c2185b;">Âπ≥ÂùáÊ≠£Á≠îÁéá</h3>
               <p style="font-size: 2em; font-weight: bold; margin: 0; color: #c2185b;">${averageAccuracy.toFixed(1)}%</p>
             </div>
           </div>
         `;
         
         statsContainer.appendChild(statsSummary);
         console.log("Áµ±Ë®àÊÉÖÂ†±„Ç´„Éº„Éâ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü");
       } else {
         console.log("statsContainer„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
       }
       
       // Â≠¶ÁøíÈÄ≤Êçó„ÇíÊõ¥Êñ∞
       updateLearningProgress(scores);
     }
     
     // Â≠¶ÁøíÈÄ≤Êçó„ÇíÊõ¥Êñ∞
     function updateLearningProgress(scores) {
       if (!scores || scores.length === 0) return;
       
       // Â≠¶ÁøíÁ∂ôÁ∂öÊó•Êï∞„ÇíË®àÁÆó
       const uniqueDates = [...new Set(scores.map(score => {
         const date = score.timestamp && typeof score.timestamp.toDate === "function" 
           ? score.timestamp.toDate() 
           : new Date(score.timestamp);
         return date.toDateString();
       }))];
       const learningDays = uniqueDates.length;
       
       // ÁõÆÊ®ôÈÅîÊàêÁéá„ÇíË®àÁÆóÔºà80%‰ª•‰∏ä„ÇíÁõÆÊ®ô„Å®„Åô„ÇãÔºâ
       const highAccuracyQuizzes = scores.filter(score => (parseFloat(score.accuracy) || 0) >= 80);
       const goalAchievement = Math.round((highAccuracyQuizzes.length / scores.length) * 100);
       
       // ÈÄ£Á∂öÊ≠£Ëß£Êï∞„ÇíË®àÁÆó
       let currentStreak = 0;
       let maxStreak = 0;
       for (let i = scores.length - 1; i >= 0; i--) {
         if ((parseFloat(scores[i].accuracy) || 0) >= 60) {
           currentStreak++;
           maxStreak = Math.max(maxStreak, currentStreak);
         } else {
           currentStreak = 0;
         }
       }
       
                // „É¨„Éô„É´„ÇíË®àÁÆó
         let level = "ÂàùÂøÉËÄÖ";
         let levelProgress = 0;
         const avgAccuracy = scores.reduce((sum, score) => sum + (parseFloat(score.accuracy) || 0), 0) / scores.length;
         if (scores.length >= 10 && avgAccuracy >= 80) {
           level = "„Ç®„Ç≠„Çπ„Éë„Éº„Éà";
           levelProgress = 100;
         } else if (scores.length >= 5 && avgAccuracy >= 60) {
           level = "‰∏≠Á¥öËÄÖ";
           levelProgress = Math.min(100, (scores.length / 10) * 100);
         } else {
           level = "ÂàùÂøÉËÄÖ";
           levelProgress = Math.min(100, (scores.length / 5) * 100);
         }
       
       // ÈÄ≤Êçó„Éê„Éº„ÇíÊõ¥Êñ∞
       updateProgressBar('learning-days', learningDays, 30, 'Êó•');
       updateProgressBar('goal-achievement', goalAchievement, 100, '%');
       updateProgressBar('streak', maxStreak, 20, 'Âïè');
       updateProgressBar('level', levelProgress, 100, '%');
       
       // „É¨„Éô„É´Ë°®Á§∫„ÇíÊõ¥Êñ∞
       document.getElementById('level').textContent = level;
     }
     
     // ÈÄ≤Êçó„Éê„Éº„ÇíÊõ¥Êñ∞
     function updateProgressBar(elementId, current, max, unit) {
       const element = document.getElementById(elementId);
       const bar = document.getElementById(elementId + '-bar');
       
       if (element && bar) {
         element.textContent = current + unit;
         const percentage = Math.min(100, (current / max) * 100);
         bar.style.width = percentage + '%';
         
         // Ëâ≤„ÇíÂãïÁöÑ„Å´Â§âÊõ¥
         if (percentage >= 80) {
           bar.style.backgroundColor = '#4CAF50';
         } else if (percentage >= 60) {
           bar.style.backgroundColor = '#FF9800';
         } else {
           bar.style.backgroundColor = '#F44336';
         }
       }
     }

         // „ÇØ„Ç§„Ç∫„Çπ„Ç≥„Ç¢„Ç´„Éº„ÉâÊèèÁîª
     function renderMovieScores(scores) {
       console.log("renderMovieScoresÈñãÂßã - scores:", scores);
       const scoresContainer = document.getElementById('scores-container');
       
       if (!scoresContainer) {
         console.error("scores-containerË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
         return;
       }
       
       if (!scores || scores.length === 0) {
         console.log("„Çπ„Ç≥„Ç¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì - „É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫");
         scoresContainer.innerHTML = `
           <div class="no-scores-message">
             <div class="no-scores-icon">üìö</div>
             <h3>„Åæ„Å†„ÇØ„Ç§„Ç∫„ÅÆÁµêÊûú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</h3>
             <p>Êñ∞„Åó„ÅÑ„ÇØ„Ç§„Ç∫„Å´ÊåëÊà¶„Åó„Å¶„ÄÅÂ≠¶Áøí„ÇíÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜÔºÅ</p>
           </div>
         `;
         return;
       }
       
       console.log(`${scores.length}‰ª∂„ÅÆ„Çπ„Ç≥„Ç¢„Ç´„Éº„Éâ„ÇíÊèèÁîª‰∏≠...`);
       scoresContainer.innerHTML = '';
       
       // „Éô„Çπ„Éà„Çπ„Ç≥„Ç¢„ÇíÊé¢„Åô
       const bestScore = scores.reduce((best, current) =>
         (parseFloat(current.accuracy) || 0) > (parseFloat(best.accuracy) || 0) ? current : best
       );
       
       console.log("„Éô„Çπ„Éà„Çπ„Ç≥„Ç¢:", bestScore);
       
       scores.forEach((score, index) => {
         console.log(`„Çπ„Ç≥„Ç¢„Ç´„Éº„Éâ${index + 1}„ÇíÂá¶ÁêÜ‰∏≠:`, score);
         
         const scoreCard = document.createElement('div');
         scoreCard.className = 'score-card';
         
         let dateObj;
         if (score.timestamp && typeof score.timestamp.toDate === 'function') {
           dateObj = score.timestamp.toDate();
         } else {
           dateObj = new Date(score.timestamp);
         }
         const formattedDate = dateObj.toLocaleString('ja-JP');
         const rank = getRank(parseFloat(score.accuracy) || 0);
         
         if (score === bestScore) {
           scoreCard.classList.add('best-score');
         }
         
         scoreCard.innerHTML = `
           <div class="score-card-header">
             <div class="score-card-date">
               <span class="date-icon">üìÖ</span>
               ${formattedDate}
             </div>
             <div class="score-card-rank">
               <span class="rank-badge ${rank.class}">${rank.label}„É©„É≥„ÇØ</span>
             </div>
           </div>
           
           <div class="score-card-body">
             <div class="score-card-main">
               <div class="score-accuracy">
                 <span class="accuracy-label">Ê≠£Á≠îÁéá</span>
                 <span class="accuracy-value">${(parseFloat(score.accuracy) || 0).toFixed(1)}%</span>
               </div>
               <div class="score-correct">
                 <span class="correct-label">Ê≠£Ëß£Êï∞</span>
                 <span class="correct-value">${score.correct || 0} / ${score.total || 0}</span>
               </div>
             </div>
             
             <div class="score-card-details">
               <div class="detail-item">
                 <span class="detail-icon">üéØ</span>
                 <span class="detail-label">„Ç´„ÉÜ„Ç¥„É™:</span>
                 <span class="detail-value">${score.category || '‰∏çÊòé'}</span>
               </div>
               <div class="detail-item">
                 <span class="detail-icon">ü§ñ</span>
                 <span class="detail-label">„ÇØ„Ç§„Ç∫Á®ÆÂà•:</span>
                 <span class="detail-value">AI„ÇØ„Ç§„Ç∫</span>
               </div>
             </div>
           </div>
           
           ${score === bestScore ? '<div class="best-score-badge">üèÜ „Éô„Çπ„Éà„Çπ„Ç≥„Ç¢</div>' : ''}
         `;
         scoresContainer.appendChild(scoreCard);
         console.log(`„Çπ„Ç≥„Ç¢„Ç´„Éº„Éâ${index + 1}„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü`);
       });
       
       console.log("ÂÖ®„Å¶„ÅÆ„Çπ„Ç≥„Ç¢„Ç´„Éº„Éâ„ÅÆÊèèÁîª„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü");
     }

    // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´Ë™çË®ºÁä∂ÊÖã„ÇíÁ¢∫Ë™ç„Åó„ÄÅ„Çπ„Ç≥„Ç¢„ÇíÂèçÊò†ÔºàËá™Âãï„É™„ÉÄ„Ç§„É¨„ÇØ„Éà„ÇíÁÑ°ÂäπÂåñÔºâ
    firebase.auth().onAuthStateChanged(user => {
      console.log("Ë™çË®ºÁä∂ÊÖãÂ§âÊõ¥:", user ? `„É≠„Ç∞„Ç§„É≥‰∏≠: ${user.uid}` : "Êú™„É≠„Ç∞„Ç§„É≥");
      if (user) {
        console.log("„É¶„Éº„Ç∂„ÉºID:", user.uid);
        loadAIQuizScoresOnly(user.uid);
      } else {
        console.log("Êú™„É≠„Ç∞„Ç§„É≥Áä∂ÊÖã - Ëá™Âãï„É™„ÉÄ„Ç§„É¨„ÇØ„Éà„ÇíÁÑ°ÂäπÂåñ");
        // Ëá™Âãï„É™„ÉÄ„Ç§„É¨„ÇØ„Éà„ÇíÁÑ°ÂäπÂåñ - „É¶„Éº„Ç∂„Éº„ÅåÊâãÂãï„Åß„É≠„Ç∞„Ç§„É≥„Åô„Çã„Åæ„ÅßÂæÖÊ©ü
        // window.location.href = 'login.html';
        
        // Êú™„É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
        const scoresContainer = document.getElementById('scores-container');
        if (scoresContainer) {
          scoresContainer.innerHTML = `
            <div class="no-scores-message">
              <div class="no-scores-icon">üîí</div>
              <h3>„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô</h3>
              <p>„ÇØ„Ç§„Ç∫„ÅÆÁµêÊûú„ÇíË°®Á§∫„Åô„Çã„Å´„ÅØ„ÄÅ„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
              <button onclick="location.href='index.html'" style="
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 20px;
                cursor: pointer;
                margin-top: 15px;
                font-weight: bold;
              ">„É≠„Ç∞„Ç§„É≥„Åô„Çã</button>
            </div>
          `;
        }
      }
    });
  </script>
</body>
</html>

