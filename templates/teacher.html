<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-translate="ai_chat">AIå…ˆç”Ÿãƒãƒ£ãƒƒãƒˆ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="chat.css">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <!-- å¤šè¨€èªå¯¾å¿œ -->
  <script src="multilang.js"></script>
</head>

<body>
  <div class="chat-container">
    <div class="chat-header">
      <div id="aiTeacherContainer">
        <span data-translate="ai_teacher" class="doctor-label">AIå…ˆç”Ÿ</span>
      </div>
    </div>

    <div id="chatContainer" class="chat-messages"></div>

    <div class="input-container">
      <button id="voiceBtn" title="éŸ³å£°å…¥åŠ›">
        <img src="8549.png" alt="éŸ³å£°å…¥åŠ›" id="voiceIcon" />
      </button>
      <input type="text" id="userInput" placeholder="å¥åº·ã«ã¤ã„ã¦ä½•ã§ã‚‚ãŠèããã ã•ã„..." autocomplete="off" data-translate="health_consultation" />
      <button id="sendButton" data-translate="send">é€ä¿¡</button>
      <button onclick="history.back()" class="back-btn" data-translate="back">æˆ»ã‚‹</button>
    </div>
  </div>

  <script>
    const OPENAI_ENDPOINT = "/api/chat"; // Vercelã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

    const chatContainer = document.getElementById("chatContainer");
    const userInput = document.getElementById("userInput");
    const sendButton = document.getElementById("sendButton");
    const voiceBtn = document.getElementById("voiceBtn");

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[m]));
    }

    function t(key, fallback){
      try{
        const lang = (window.multiLang && window.multiLang.currentLanguage) || 'ja';
        const dict = (window.multiLang && window.multiLang.translations && window.multiLang.translations[lang]) || {};
        return (dict && dict[key]) || fallback;
      }catch(_){
        return fallback;
      }
    }

    // who: 'user' | 'ai'
    function appendMessage(who, text){
      const messageDiv = document.createElement("div");
      messageDiv.className = "message";

      if(who === 'user'){
        messageDiv.className += " user-message";
        messageDiv.innerHTML = `<div class="message-content">${escapeHtml(text)}</div>`;
      } else {
        messageDiv.className += " ai-message";
        messageDiv.innerHTML = `
          <div class="message-content">
            <div class="ai-header">
              <span class="ai-icon">ğŸ‘¨â€âš•ï¸</span>
              <span class="ai-name" data-translate="ai_teacher">${escapeHtml(t('ai_teacher','AIå…ˆç”Ÿ'))}</span>
            </div>
            <div class="ai-text">${escapeHtml(text)}</div>
          </div>
        `;
      }

      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function loading(){
      const id = "loading-" + Date.now();
      const messageDiv = document.createElement("div");
      messageDiv.id = id;
      messageDiv.className = "message ai-message";
      messageDiv.innerHTML = `
        <div class="message-content">
          <div class="ai-header">
            <span class="ai-icon">ğŸ‘¨â€âš•ï¸</span>
            <span class="ai-name" data-translate="ai_teacher">${escapeHtml(t('ai_teacher','AIå…ˆç”Ÿ'))}</span>
          </div>
          <div class="loading-indicator">
            <div class="spinner"></div>
            <span>${escapeHtml(t('thinking','è€ƒãˆä¸­...'))}</span>
          </div>
        </div>
      `;
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      return id;
    }

    function stopLoading(id){
      const el = document.getElementById(id);
      if(el) el.remove();
    }

    // ---- é€ä¿¡åˆ¶å¾¡ ----
    let isSending = false;        // äºŒé‡é€ä¿¡é˜²æ­¢
    let lastSendTime = 0;         // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ç°¡æ˜“ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆé€£æ‰“é˜²æ­¢ï¼‰
    let cooldownUntil = 0;        // 429ç­‰ã®å¾Œã«ã—ã°ã‚‰ãå¾…ãŸã›ã‚‹

    function setSendingState(sending){
      isSending = sending;
      sendButton.disabled = sending;
      userInput.disabled = false; // å…¥åŠ›è‡ªä½“ã¯è¨±å¯ã—ã¦OKï¼ˆå¥½ã¿ã§trueã§ã‚‚ï¼‰
      if(sending){
        sendButton.textContent = t('sending', 'é€ä¿¡ä¸­â€¦');
      }else{
        sendButton.textContent = t('send', 'é€ä¿¡');
      }
    }

    async function send(){
      const msg = (userInput.value || "").trim();
      if(!msg) return;

      const now = Date.now();

      // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ã¯é€ã‚‰ãªã„ï¼ˆ429å¾Œã®ç„¡é§„æ’ƒã¡ã‚’æ­¢ã‚ã‚‹ï¼‰
      if(now < cooldownUntil){
        // ä½™è¨ˆãªAIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å¢—ã‚„ã•ãšã€è»½ããƒã‚¤ãƒ–çš„ã«ä¼ãˆã‚‹ãªã‚‰ã“ã“ã§
        appendMessage('ai', t('please_wait', 'å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'));
        return;
      }

      // é€ä¿¡ä¸­ã¯ç„¡è¦–ï¼ˆé€£æ‰“ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå¢—ãˆã‚‹ã®ã‚’æ­¢ã‚ã‚‹ï¼‰
      if(isSending) return;

      // 1ç§’æœªæº€ã®é€£æ‰“ã‚’å¼¾ã
      if(now - lastSendTime < 1000){
        appendMessage('ai', t('please_wait', 'å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'));
        return;
      }

      lastSendTime = now;

      // UIåæ˜ 
      appendMessage('user', msg);
      userInput.value = "";
      const id = loading();
      setSendingState(true);

      try{
        const r = await fetch(OPENAI_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ message: msg })
        });

        let data = null;
        try { data = await r.json(); } catch(e){ /* ignore */ }

        stopLoading(id);

        if(!r.ok){
          // 429ã¯ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆ3ç§’ï¼‰ã—ã¦ã‹ã‚‰å†é€å¯èƒ½ã«ã™ã‚‹
          if(r.status === 429){
            cooldownUntil = Date.now() + 3000;
            appendMessage('ai', t('rate_limited', 'æ··ã¿åˆã£ã¦ã„ã¾ã™ã€‚3ç§’ã»ã©å¾…ã£ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦é€ã£ã¦ãã ã•ã„ã€‚'));
          } else {
            const errMsg =
              (data && typeof data.error === 'string' && data.error) ||
              (data && data.error && (data.error.message || data.error.error)) ||
              (data && data.detail) ||
              `é€šä¿¡ã‚¨ãƒ©ãƒ¼ (${r.status})`;
            appendMessage('ai', t('ai_sorry', 'ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚') + errMsg);
          }
          setSendingState(false);
          return;
        }

        const aiReply = data?.reply ?? t('ai_error', "ã†ã¾ãå¿œç­”ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
        appendMessage('ai', aiReply);
        setSendingState(false);

      }catch(e){
        stopLoading(id);
        appendMessage('ai', t('network_error', "é€šä¿¡ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"));
        setSendingState(false);
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      const showInitialMessage = () => {
        const greeting = t('greeting','ã“ã‚“ã«ã¡ã¯ã€‚è¨ºæ–­ã¯ã§ãã¾ã›ã‚“ãŒã€å®‰å¿ƒã«ã¤ãªãŒã‚‹æƒ…å ±ã‚’100å­—ä»¥å†…ã§ãŠä¼ãˆã—ã¾ã™ã€‚');
        appendMessage('ai', greeting);
      };

      // ç¿»è¨³æº–å‚™ã‚’å°‘ã—å¾…ã¤
      const waitForTranslation = () => {
        if (window.multiLang && window.multiLang.currentLanguage && window.multiLang.translations && window.multiLang.translations[window.multiLang.currentLanguage]) {
          showInitialMessage();
        } else {
          setTimeout(() => {
            if (window.multiLang && window.multiLang.currentLanguage && window.multiLang.translations && window.multiLang.translations[window.multiLang.currentLanguage]) {
              showInitialMessage();
            } else {
              appendMessage('ai', 'ã“ã‚“ã«ã¡ã¯ã€‚è¨ºæ–­ã¯ã§ãã¾ã›ã‚“ãŒã€å®‰å¿ƒã«ã¤ãªãŒã‚‹æƒ…å ±ã‚’100å­—ä»¥å†…ã§ãŠä¼ãˆã—ã¾ã™ã€‚');
            }
          }, 800);
        }
      };
      waitForTranslation();

      // Enteré€ä¿¡
      userInput.addEventListener("keypress", (e) => {
        if(e.key === "Enter") send();
      });

      // ãƒœã‚¿ãƒ³é€ä¿¡
      sendButton.addEventListener("click", send);

      userInput.focus();

      // ===== éŸ³å£°å…¥åŠ›æ©Ÿèƒ½ =====
      let recognition = null;
      let isListening = false;

      // SpeechRecognition APIã®åˆæœŸåŒ–
      function initSpeechRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          voiceBtn.style.display = 'none';
          console.warn('éŸ³å£°èªè­˜APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
          return;
        }

        recognition = new SpeechRecognition();
        recognition.lang = 'ja-JP';
        recognition.continuous = false;
        recognition.interimResults = true;

        recognition.onstart = () => {
          isListening = true;
          voiceBtn.classList.add('active');
          const voiceIcon = document.getElementById('voiceIcon');
          if (voiceIcon) {
            voiceIcon.style.opacity = '0.6';
          }
        };

        recognition.onresult = (event) => {
          let interimTranscript = '';
          let finalTranscript = '';

          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
              finalTranscript += transcript;
            } else {
              interimTranscript += transcript;
            }
          }

          if (finalTranscript) {
            userInput.value = (userInput.value + ' ' + finalTranscript).trim();
          } else if (interimTranscript) {
            const currentValue = userInput.value.trim();
            userInput.value = currentValue ? currentValue + ' ' + interimTranscript : interimTranscript;
          }
        };

        recognition.onerror = (event) => {
          console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event.error);
          if (event.error === 'no-speech') {
            // éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œãªã‹ã£ãŸå ´åˆã¯è‡ªå‹•çš„ã«å†é–‹ã—ãªã„
          } else if (event.error === 'not-allowed') {
            alert('ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          }
          stopListening();
        };

        recognition.onend = () => {
          stopListening();
        };
      }

      function startListening() {
        if (!recognition) {
          initSpeechRecognition();
        }
        if (recognition && !isListening) {
          try {
            recognition.start();
          } catch (e) {
            console.error('éŸ³å£°èªè­˜ã®é–‹å§‹ã«å¤±æ•—:', e);
            stopListening();
          }
        }
      }

      function stopListening() {
        if (recognition && isListening) {
          try {
            recognition.stop();
          } catch (e) {
            console.error('éŸ³å£°èªè­˜ã®åœæ­¢ã«å¤±æ•—:', e);
          }
        }
        isListening = false;
        voiceBtn.classList.remove('active');
        const voiceIcon = document.getElementById('voiceIcon');
        if (voiceIcon) {
          voiceIcon.style.opacity = '1';
        }
      }

      voiceBtn.addEventListener('click', () => {
        if (isListening) {
          stopListening();
        } else {
          startListening();
        }
      });

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
      initSpeechRecognition();

      // ç¿»è¨³UIæ›´æ–°
      const updateUIWhenReady = () => {
        if (window.multiLang && typeof window.multiLang.updateUI === 'function') {
          try {
            window.multiLang.updateUI();
            const input = document.getElementById('userInput');
            if (input && window.multiLang.translations && window.multiLang.translations[window.multiLang.currentLanguage]) {
              const translation = window.multiLang.translations[window.multiLang.currentLanguage]['health_consultation'];
              if (translation) input.placeholder = translation;
            }
          } catch (_) {}
        } else {
          setTimeout(updateUIWhenReady, 300);
        }
      };
      updateUIWhenReady();
    });
  </script>
</body>
</html>
