<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title data-translate="ai_chat">AIå…ˆç”Ÿãƒãƒ£ãƒƒãƒˆ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="chat.css">
    
  <style>
    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ–ãƒ«ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ */
    .bubble {
      display: inline-flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
    }
    
    .msg-text[style*="opacity: 0.6"] {
      font-style: italic;
      opacity: 0.6;
    }
    
    /* å¹ãå‡ºã—ã‚¹ã‚¿ã‚¤ãƒ« */
    .message {
      max-width: 75%;
      display: flex;
      margin: 8px 0;
    }
    
    .message.user-message {
      align-self: flex-end;
      justify-content: flex-end;
    }
    
    .message.ai-message {
      align-self: flex-start;
      justify-content: flex-start;
    }
    
    .message-content {
      position: relative;
      padding: 12px 16px;
      border-radius: 18px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      word-wrap: break-word;
      max-width: 100%;
    }
    
    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå³å´ã®å¹ãå‡ºã—ï¼‰ */
    .message.user-message .message-content {
      background: #8bc34a;
      color: #ffffff;
      border-bottom-right-radius: 4px;
    }
    
    /* AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå·¦å´ã®å¹ãå‡ºã—ï¼‰ */
    .message.ai-message .message-content {
      background: #ffffff;
      color: #222;
      border: 1px solid #e0e0e0;
      border-bottom-left-radius: 4px;
    }
    
    /* å¹ãå‡ºã—ã®ä¸‰è§’å½¢ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼šå³å´ï¼‰ */
    .message.user-message .message-content::after {
      content: "";
      position: absolute;
      bottom: 8px;
      right: -6px;
      width: 12px;
      height: 12px;
      background: #8bc34a;
      transform: rotate(45deg);
      border-radius: 0 0 4px 0;
    }
    
    /* å¹ãå‡ºã—ã®ä¸‰è§’å½¢ï¼ˆAIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼šå·¦å´ï¼‰ */
    .message.ai-message .message-content::before {
      content: "";
      position: absolute;
      bottom: 8px;
      left: -6px;
      width: 12px;
      height: 12px;
      background: #ffffff;
      border-left: 1px solid #e0e0e0;
      border-bottom: 1px solid #e0e0e0;
      transform: rotate(45deg);
      border-radius: 0 0 0 4px;
    }
    
    .ai-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .ai-icon {
      font-size: 1.2em;
    }
    
    .ai-name {
      font-weight: 600;
      font-size: 0.9em;
      color: #555;
    }
    
    .ai-text {
      line-height: 1.6;
      white-space: pre-wrap;
    }
    
    .loading-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #888;
    }
    
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #e0e0e0;
      border-top-color: #8bc34a;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ç·‘è‰²ã«å¤‰æ›´ */
    :root {
      --primary: #8bc34a;
      --primary-hover: #8bc34a;
      --primary-light: #d1fae5;
    }
    
    .message.self .bubble {
      background: #8bc34a !important;
    }
    
    #sendBtn {
      background: #8bc34a !important;
    }
    
    #sendBtn:hover {
      background: #8bc34a !important;
    }
    
    #voiceBtn.active {
      background: #8bc34a !important;
      border-color: #8bc34a !important;
    }
    
    #voiceBtn:hover {
      border-color: #8bc34a !important;
      color: #8bc34a !important;
    }
    
    #messageInput:focus {
      border-color: #8bc34a !important;
      box-shadow: 0 0 0 3px #d1fae5 !important;
    }
    
    #voiceBtn.active {
      animation: pulse-green 2s infinite;
    }
    
    @keyframes pulse-green {
      0%, 100% {
        box-shadow: var(--shadow-md);
      }
      50% {
        box-shadow: 0 0 0 4px #d1fae5;
      }
    }
  </style>
    
  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  
  <!-- å¤šè¨€èªå¯¾å¿œ -->
  <script src="multilang.js"></script>
  

</head>

<body>
  <div class="chat-container">
    <div class="chat-header">
      <div id="aiTeacherContainer">
        <span data-translate="ai_teacher" class="doctor-label" style="font-weight: bold;">AIå…ˆç”Ÿ</span>
      </div>
    </div>

    <div id="chat" class="chat-messages"></div>

    <div class="input-container">
      <button id="voiceBtn" title="éŸ³å£°å…¥åŠ›">
        <img src="8549.png" alt="éŸ³å£°å…¥åŠ›" id="voiceIcon" />
      </button>
      <input type="text" id="messageInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" autocomplete="off" data-translate="message_input" />
      <button id="sendBtn" data-translate="send">é€ä¿¡</button>
      <button onclick="window.location.href='ai.html'" class="back-btn" data-translate="back">æˆ»ã‚‹</button>
    </div>
  </div>

  <script>
    const OPENAI_ENDPOINT = "/api/chat"; // Vercelã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

    const chatDiv = document.getElementById("chat");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const voiceBtn = document.getElementById("voiceBtn");

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[m]));
    }

    function t(key, fallback){
      try{
        const lang = (window.multiLang && window.multiLang.currentLanguage) || 'ja';
        const dict = (window.multiLang && window.multiLang.translations && window.multiLang.translations[lang]) || {};
        return (dict && dict[key]) || fallback;
      }catch(_){
        return fallback;
      }
    }

    // who: 'user' | 'ai'
    function appendMessage(who, text){
      const messageDiv = document.createElement("div");
      messageDiv.className = "message";

      if(who === 'user'){
        messageDiv.className += " user-message";
        messageDiv.innerHTML = `<div class="message-content">${escapeHtml(text)}</div>`;
      } else {
        messageDiv.className += " ai-message";
        messageDiv.innerHTML = `
          <div class="message-content">
            <div class="ai-header">
              <span class="ai-icon">ğŸ‘¨â€âš•ï¸</span>
              <span class="ai-name" data-translate="ai_teacher">${escapeHtml(t('ai_teacher','AIå…ˆç”Ÿ'))}</span>
            </div>
            <div class="ai-text">${escapeHtml(text)}</div>
          </div>
        `;
      }

      chatDiv.appendChild(messageDiv);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    function loading(){
      const id = "loading-" + Date.now();
      const messageDiv = document.createElement("div");
      messageDiv.id = id;
      messageDiv.className = "message ai-message";
      messageDiv.innerHTML = `
        <div class="message-content">
          <div class="ai-header">
            <span class="ai-icon">ğŸ‘¨â€âš•ï¸</span>
            <span class="ai-name" data-translate="ai_teacher">${escapeHtml(t('ai_teacher','AIå…ˆç”Ÿ'))}</span>
          </div>
          <div class="loading-indicator">
            <div class="spinner"></div>
            <span>${escapeHtml(t('thinking','è€ƒãˆä¸­...'))}</span>
          </div>
        </div>
      `;
      chatDiv.appendChild(messageDiv);
      chatDiv.scrollTop = chatDiv.scrollHeight;
      return id;
    }

    function stopLoading(id){
      const el = document.getElementById(id);
      if(el) el.remove();
    }

    // ---- é€ä¿¡åˆ¶å¾¡ ----
    let isSending = false;        // äºŒé‡é€ä¿¡é˜²æ­¢
    let lastSendTime = 0;         // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ç°¡æ˜“ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆé€£æ‰“é˜²æ­¢ï¼‰
    let cooldownUntil = 0;        // 429ç­‰ã®å¾Œã«ã—ã°ã‚‰ãå¾…ãŸã›ã‚‹

    function setSendingState(sending){
      isSending = sending;
      sendBtn.disabled = sending;
      messageInput.disabled = false; // å…¥åŠ›è‡ªä½“ã¯è¨±å¯ã—ã¦OKï¼ˆå¥½ã¿ã§trueã§ã‚‚ï¼‰
      if(sending){
        sendBtn.textContent = t('sending', 'é€ä¿¡ä¸­â€¦');
      }else{
        sendBtn.textContent = t('send', 'é€ä¿¡');
      }
    }

    async function send(){
      const msg = (messageInput.value || "").trim();
      if(!msg) return;

      const now = Date.now();

      // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ã¯é€ã‚‰ãªã„ï¼ˆ429å¾Œã®ç„¡é§„æ’ƒã¡ã‚’æ­¢ã‚ã‚‹ï¼‰
      if(now < cooldownUntil){
        // ä½™è¨ˆãªAIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å¢—ã‚„ã•ãšã€è»½ããƒã‚¤ãƒ–çš„ã«ä¼ãˆã‚‹ãªã‚‰ã“ã“ã§
        appendMessage('ai', t('please_wait', 'å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'));
        return;
      }

      // é€ä¿¡ä¸­ã¯ç„¡è¦–ï¼ˆé€£æ‰“ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå¢—ãˆã‚‹ã®ã‚’æ­¢ã‚ã‚‹ï¼‰
      if(isSending) return;

      // 1ç§’æœªæº€ã®é€£æ‰“ã‚’å¼¾ã
      if(now - lastSendTime < 1000){
        appendMessage('ai', t('please_wait', 'å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'));
        return;
      }

      lastSendTime = now;

      // UIåæ˜ 
      appendMessage('user', msg);
      messageInput.value = "";
      const id = loading();
      setSendingState(true);

      try{
        const r = await fetch(OPENAI_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ message: msg })
        });

        let data = null;
        try { data = await r.json(); } catch(e){ /* ignore */ }

        stopLoading(id);

        if(!r.ok){
          // 429ã¯ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆ3ç§’ï¼‰ã—ã¦ã‹ã‚‰å†é€å¯èƒ½ã«ã™ã‚‹
          if(r.status === 429){
            cooldownUntil = Date.now() + 3000;
            appendMessage('ai', t('rate_limited', 'æ··ã¿åˆã£ã¦ã„ã¾ã™ã€‚3ç§’ã»ã©å¾…ã£ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦é€ã£ã¦ãã ã•ã„ã€‚'));
          } else {
            const errMsg =
              (data && typeof data.error === 'string' && data.error) ||
              (data && data.error && (data.error.message || data.error.error)) ||
              (data && data.detail) ||
              `é€šä¿¡ã‚¨ãƒ©ãƒ¼ (${r.status})`;
            appendMessage('ai', t('ai_sorry', 'ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚') + errMsg);
          }
          setSendingState(false);
          return;
        }

        const aiReply = data?.reply ?? t('ai_error', "ã†ã¾ãå¿œç­”ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
        appendMessage('ai', aiReply);
        setSendingState(false);

      }catch(e){
        stopLoading(id);
        appendMessage('ai', t('network_error', "é€šä¿¡ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"));
        setSendingState(false);
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      const showInitialMessage = () => {
        const greeting = t('greeting','ã“ã‚“ã«ã¡ã¯ã€‚è¨ºæ–­ã¯ã§ãã¾ã›ã‚“ãŒã€å®‰å¿ƒã«ã¤ãªãŒã‚‹æƒ…å ±ã‚’100å­—ä»¥å†…ã§ãŠä¼ãˆã—ã¾ã™ã€‚');
        appendMessage('ai', greeting);
      };

      // ç¿»è¨³æº–å‚™ã‚’å°‘ã—å¾…ã¤
      const waitForTranslation = () => {
        if (window.multiLang && window.multiLang.currentLanguage && window.multiLang.translations && window.multiLang.translations[window.multiLang.currentLanguage]) {
          showInitialMessage();
        } else {
          setTimeout(() => {
            if (window.multiLang && window.multiLang.currentLanguage && window.multiLang.translations && window.multiLang.translations[window.multiLang.currentLanguage]) {
              showInitialMessage();
            } else {
              appendMessage('ai', 'ã“ã‚“ã«ã¡ã¯ã€‚è¨ºæ–­ã¯ã§ãã¾ã›ã‚“ãŒã€å®‰å¿ƒã«ã¤ãªãŒã‚‹æƒ…å ±ã‚’100å­—ä»¥å†…ã§ãŠä¼ãˆã—ã¾ã™ã€‚');
            }
          }, 800);
        }
      };
      waitForTranslation();

      // Enteré€ä¿¡
      messageInput.addEventListener("keypress", (e) => {
        if(e.key === "Enter") {
          e.preventDefault();
          sendBtn.click();
        }
      });

      // ãƒœã‚¿ãƒ³é€ä¿¡
      sendBtn.addEventListener("click", send);

      messageInput.focus();

      // ===== éŸ³å£°å…¥åŠ›æ©Ÿèƒ½ =====
      let recognition = null;
      let isListening = false;

      // SpeechRecognition APIã®åˆæœŸåŒ–
      function initSpeechRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          voiceBtn.style.display = 'none';
          console.warn('éŸ³å£°èªè­˜APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
          return;
        }

        recognition = new SpeechRecognition();
        recognition.lang = 'ja-JP';
        recognition.continuous = false;
        recognition.interimResults = true;

        recognition.onstart = () => {
          isListening = true;
          voiceBtn.classList.add('active');
          const voiceIcon = document.getElementById('voiceIcon');
          if (voiceIcon) {
            voiceIcon.style.opacity = '0.6';
          }
        };

        recognition.onresult = (event) => {
          let interimTranscript = '';
          let finalTranscript = '';

          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
              finalTranscript += transcript;
            } else {
              interimTranscript += transcript;
            }
          }

          if (finalTranscript) {
            messageInput.value = (messageInput.value + ' ' + finalTranscript).trim();
          } else if (interimTranscript) {
            const currentValue = messageInput.value.trim();
            messageInput.value = currentValue ? currentValue + ' ' + interimTranscript : interimTranscript;
          }
        };

        recognition.onerror = (event) => {
          console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event.error);
          if (event.error === 'no-speech') {
            // éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œãªã‹ã£ãŸå ´åˆã¯è‡ªå‹•çš„ã«å†é–‹ã—ãªã„
          } else if (event.error === 'not-allowed') {
            alert('ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          }
          stopListening();
        };

        recognition.onend = () => {
          stopListening();
        };
      }

      function startListening() {
        if (!recognition) {
          initSpeechRecognition();
        }
        if (recognition && !isListening) {
          try {
            recognition.start();
          } catch (e) {
            console.error('éŸ³å£°èªè­˜ã®é–‹å§‹ã«å¤±æ•—:', e);
            stopListening();
          }
        }
      }

      function stopListening() {
        if (recognition && isListening) {
          try {
            recognition.stop();
          } catch (e) {
            console.error('éŸ³å£°èªè­˜ã®åœæ­¢ã«å¤±æ•—:', e);
          }
        }
        isListening = false;
        voiceBtn.classList.remove('active');
        const voiceIcon = document.getElementById('voiceIcon');
        if (voiceIcon) {
          voiceIcon.style.opacity = '1';
        }
      }

      // ãƒ¢ãƒã‚¤ãƒ«ã¨PCã®ä¸¡æ–¹ã«å¯¾å¿œã—ãŸã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
      const handleVoiceButtonClick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (isListening) {
          stopListening();
        } else {
          startListening();
        }
      };
      
      // clickã‚¤ãƒ™ãƒ³ãƒˆï¼ˆPCç”¨ï¼‰
      voiceBtn.addEventListener('click', handleVoiceButtonClick);
      // touchstartã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼‰
      voiceBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        handleVoiceButtonClick(e);
      }, { passive: false });

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
      initSpeechRecognition();

      // ç¿»è¨³UIæ›´æ–°
      const updateUIWhenReady = () => {
        if (window.multiLang && typeof window.multiLang.updateUI === 'function') {
          try {
            window.multiLang.updateUI();
            const input = document.getElementById('messageInput');
            if (input && window.multiLang.translations && window.multiLang.translations[window.multiLang.currentLanguage]) {
              const translation = window.multiLang.translations[window.multiLang.currentLanguage]['message_input'];
              if (translation) input.placeholder = translation;
            }
          } catch (_) {}
        } else {
          setTimeout(updateUIWhenReady, 300);
        }
      };
      updateUIWhenReady();
    });
  </script>
</body>
</html>
