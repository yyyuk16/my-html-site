<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="åŒ»å¸«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«">åŒ»å¸«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</title>
    <link rel="stylesheet" href="maintab.css">
    <link rel="stylesheet" href="d_footer.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        body {
            background: #e3f0fc;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 70px; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¹ãƒšãƒ¼ã‚¹ */
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®å›ºå®š */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .profile-container {
            max-width: 500px;
            margin: 30px auto;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 4px 16px rgba(33, 150, 243, 0.08);
            overflow: hidden;
        }

        .profile-header {
            background: #2196f3;
            color: #fff;
            padding: 24px 0 18px 0;
            text-align: center;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            background: #fff;
            color: #2196f3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2em;
            font-weight: bold;
            margin: 0 auto 12px;
            border: 2px solid #90caf9;
        }

        .profile-title {
            font-size: 1.4em;
            font-weight: 700;
            margin: 0 0 6px 0;
        }

        .profile-subtitle {
            font-size: 1em;
            opacity: 0.85;
            margin: 0;
        }

        .profile-content {
            padding: 22px 18px;
        }

        .profile-row {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e3f0fc;
        }

        .profile-row:last-child {
            border-bottom: none;
        }

        .profile-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #1976d2;
            font-weight: 600;
            min-width: 100px;
            font-size: 1em;
        }

        .profile-label i {
            font-size: 1.1em;
            width: 18px;
            text-align: center;
        }

        .profile-value {
            color: #222;
            font-size: 1em;
            flex: 1;
            text-align: right;
            font-weight: 500;
        }

        .profile-edit-form-btns {
            text-align: center;
            margin-top: 22px;
        }

        .edit-btn {
            background: #2196f3;
            color: #fff;
            border: none;
            padding: 10px 24px;
            border-radius: 20px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .edit-btn:hover {
            background: #1976d2;
        }

        .profile-edit-input {
            width: 100%;
            padding: 8px 12px;
            border: 1.5px solid #bbdefb;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.2s;
        }

        .profile-edit-input:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 0 2px #e3f2fd;
        }

        .save-btn, .cancel-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 16px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin: 0 4px;
        }

        .save-btn {
            background: #2196f3;
            color: #fff;
        }

        .save-btn:hover {
            background: #1976d2;
        }

        .cancel-btn {
            background: #e3f0fc;
            color: #1976d2;
        }

        .cancel-btn:hover {
            background: #bbdefb;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 22px;
            flex-wrap: wrap;
        }

        .logout-btn, .delete-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            min-width: 120px;
        }

        .logout-btn {
            background: #1976d2;
            color: #fff;
        }

        .logout-btn:hover {
            background: #1565c0;
        }

        .delete-btn {
            background: #e3f0fc;
            color: #d32f2f;
        }

        .delete-btn:hover {
            background: #ffcdd2;
        }

        /* 1. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆPCï¼‰ã§ã¯ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒŠãƒ“ã‚’éš ã™ */
        .mobile-nav {
            display: none;
        }

        /* 2. ãƒ¢ãƒã‚¤ãƒ«ç”»é¢ï¼ˆ768pxä»¥ä¸‹ï¼‰ã®è¨­å®š */
        @media (max-width: 768px) {
            /* PCç”¨ãƒŠãƒ“ã‚’éš ã™ */
            .tab-menu {
                display: none;
            }

            /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç”»åƒã®ã‚ˆã†ãªã‚·ãƒ³ãƒ—ãƒ«æ§‹æˆã« */
            .top-bar {
                padding: 10px 15px;
                border-bottom: 1px solid #eee;
            }
            
            .header-inner {
                justify-content: space-between;
            }

            .logo span {
                font-size: 1.1rem;
            }

            /* ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º */
            .mobile-nav {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 70px;
                background: #f8f9fa;
                border-top: 1px solid #eee;
                justify-content: space-around;
                align-items: center;
                z-index: 1000;
                padding-bottom: env(safe-area-inset-bottom); /* iPhoneã®ãƒãƒ¼å¯¾ç­– */
            }

            .nav-item {
                text-decoration: none;
                color: #888;
                display: flex;
                flex-direction: column;
                align-items: center;
                font-size: 0.7rem;
                gap: 4px;
            }

            .nav-item i {
                font-size: 1.4rem;
            }

            .nav-item.active {
                color: #333; /* é¸æŠä¸­ã®è‰² */
            }

            /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸‹éƒ¨ã«ä½™ç™½ã‚’è¿½åŠ ï¼ˆãƒŠãƒ“ã«è¢«ã‚‰ãªã„ã‚ˆã†ã«ï¼‰ */
            body {
                padding-bottom: 80px;
            }

            /* PCç‰ˆã®ãƒ•ãƒƒã‚¿ãƒ¼ã‚’ã‚¹ãƒãƒ›ã§ã¯éš ã™ï¼ˆãƒŠãƒ“ãŒã‚ã‚‹ãŸã‚ï¼‰ */
            .footer {
                display: none;
            }

            /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ¢ãƒã‚¤ãƒ«èª¿æ•´ */
            .profile-container {
                margin: 20px 2vw 80px 2vw;
                border-radius: 10px;
                max-width: 100%;
            }
            .profile-header {
                padding: 14px 0 10px 0;
            }
            .profile-content {
                padding: 12px 6px;
            }
            .profile-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
            .profile-label {
                min-width: auto;
            }
            .profile-value {
                text-align: left;
            }
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            .logout-btn, .delete-btn {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- ğŸ’š ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="top-bar">
        <div class="header-inner">
            <div class="logo" style="font-size:2rem; font-weight:700; color:#2196f3; letter-spacing:0.08em; display:flex; align-items:center;">
                <span data-translate="site_title" style="vertical-align:middle;">åŒ»ç™‚ç®¡ç†ã‚¢ãƒ—ãƒª</span>
            </div>
            <nav>
                <ul class="tab-menu">
                    <li><a href="list.html">ğŸ‘¥ <span data-translate="æ‚£è€…è¨ºç™‚è¨˜éŒ²">æ‚£è€…è¨ºç™‚è¨˜éŒ²</span></a></li>
                    <li><a href="chat.html">ğŸ“… <span data-translate="ãƒãƒ£ãƒƒãƒˆ">ãƒãƒ£ãƒƒãƒˆ</span></a></li>
                    <li><a href="docterprofile.html" class="active">ğŸ¥ <span data-translate="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</span></a></li>
                </ul>
            </nav>
        </div>
    </header>

     <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
     <div class="profile-container">
         <div class="profile-header">
             <div class="profile-avatar">
                 <span id="profileInitial">?</span>
                    </div>
             <h1 class="profile-title" data-translate="åŒ»å¸«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«">åŒ»å¸«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h1>
             <p class="profile-subtitle" data-translate="ã”ç™»éŒ²æƒ…å ±ã®ç¢ºèª">ã”ç™»éŒ²æƒ…å ±ã®ç¢ºèª</p>
                </div>
         <div class="profile-content">
             <div id="profileList"></div>
             <div class="action-buttons">
                 <button id="logoutBtn" class="logout-btn">
                     <i class="fas fa-sign-out-alt"></i>
                     <span data-translate="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
                 </button>
                 <button id="deleteAccountBtn" class="delete-btn">
                    <i class="fas fa-user-times"></i>
                    <span data-translate="é€€ä¼šï¼ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ï¼‰">é€€ä¼šï¼ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ï¼‰</span>
                </button>
             </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav class="mobile-nav">
        <a href="list.html" class="nav-item">
            <i class="fa-solid fa-clipboard-list"></i>
            <span data-translate="æ‚£è€…è¨ºç™‚è¨˜éŒ²">æ‚£è€…è¨ºç™‚è¨˜éŒ²</span>
        </a>
        <a href="chat.html" class="nav-item">
            <i class="fa-solid fa-comments"></i>
            <span data-translate="ãƒãƒ£ãƒƒãƒˆ">ãƒãƒ£ãƒƒãƒˆ</span>
        </a>
        <a href="docterprofile.html" class="nav-item active">
            <i class="fa-regular fa-user"></i>
            <span data-translate="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</span>
        </a>
    </nav>
    
    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-links">
                    <a href="#" data-translate="terms">åˆ©ç”¨è¦ç´„</a>
                    <a href="#" data-translate="privacy">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
                </div>
                <div class="footer-copyright">
                    <small data-translate="copyright_name">Â© 2024 åŒ»ç™‚ç®¡ç†ã‚¢ãƒ—ãƒª. All rights reserved.</small>
                </div>
            </div>
        </div>
    </footer>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB7TuGhOKbB4w7DDYt7KTejy-TrcxVZmpU",
            authDomain: "web01-2484d.firebaseapp.com",
            databaseURL: "https://web01-2484d-default-rtdb.firebaseio.com",
            projectId: "web01-2484d",
            storageBucket: "web01-2484d.firebasestorage.app",
            messagingSenderId: "90159472898",
            appId: "1:90159472898:web:261ec71f9919611011e21b",
            measurementId: "G-9TGR07ZSY9"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

        const listDiv = document.getElementById('profileList');
        let currentUser = null;
        let currentData = {};
        let isEditing = false;

        function setLoading(message){
            listDiv.innerHTML = `<div class='profile-row'><div class='profile-label'><i class="fas fa-circle-notch fa-spin"></i><span>èª­ã¿è¾¼ã¿ä¸­</span></div><span class='profile-value'>${message||''}</span></div>`;
        }
        function setMessage(iconHtml,label,value){
            listDiv.innerHTML = `<div class='profile-row'><div class='profile-label'>${iconHtml}<span>${label}</span></div><span class='profile-value'>${value}</span></div>`;
        }

        // åŒ»å¸«ç”¨ ç·¨é›†å¯èƒ½ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
        const editableFields = {
            name: {label:'åå‰', icon:'<i class="fas fa-user"></i>', type:'text', placeholder:'ãŠåå‰'},
            gender: {label:'æ€§åˆ¥', icon:'<i class="fas fa-venus-mars"></i>', type:'select', options:['ç”·æ€§','å¥³æ€§','ãã®ä»–']},
            age: {label:'å¹´é½¢', icon:'<i class="fas fa-birthday-cake"></i>', type:'number', min:20, max:120, placeholder:'å¹´é½¢'},
            email: {label:'ãƒ¡ãƒ¼ãƒ«', icon:'<i class="fas fa-envelope"></i>', type:'email', placeholder:'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹'},
            specialty: {label:'å°‚é–€', icon:'<i class="fas fa-stethoscope"></i>', type:'text', placeholder:'å°‚é–€åˆ†é‡'},
            hospital: {label:'ç—…é™¢', icon:'<i class="fas fa-hospital"></i>', type:'text', placeholder:'å‹¤å‹™å…ˆç—…é™¢'},
            experience: {label:'å‹¤å‹™å¹´æ•°', icon:'<i class="fas fa-clock"></i>', type:'number', min:0, max:80, placeholder:'å‹¤å‹™å¹´æ•°'}
        };

        // åŒ»å¸«ç”¨ è¡¨ç¤ºé †
        const order = ['name','gender','age','email','specialty','hospital','experience'];

        function renderProfile(data, editing = false) {
            listDiv.innerHTML = '';
            let initial = 'ï¼Ÿ';
            if (data.name && typeof data.name === 'string' && data.name.length > 0) initial = data.name[0];
                            document.getElementById('profileInitial').textContent = initial;
                            
            if (!editing) {
                // é€šå¸¸è¡¨ç¤º
                for (const key of order) {
                    let value = data[key];
                    let label = key;
                    let icon = '';
                    let skip = false;
                    let isEditable = !!editableFields[key];
                    let field = editableFields[key];

                    switch(key){
                        case 'name': label='åå‰'; icon='<i class="fas fa-user"></i>'; break;
                        case 'gender': label='æ€§åˆ¥'; icon='<i class="fas fa-venus-mars"></i>'; break;
                        case 'age': label='å¹´é½¢'; value = value ? value + 'æ­³' : ''; icon='<i class="fas fa-birthday-cake"></i>'; break;
                        case 'email': label='ãƒ¡ãƒ¼ãƒ«'; icon='<i class="fas fa-envelope"></i>'; break;
                        case 'specialty': label='å°‚é–€'; icon='<i class="fas fa-stethoscope"></i>'; break;
                        case 'hospital': label='ç—…é™¢'; icon='<i class="fas fa-hospital"></i>'; break;
                        case 'experience': label='å‹¤å‹™å¹´æ•°'; value = value ? value + 'å¹´' : ''; icon='<i class="fas fa-clock"></i>'; break;
                        default: skip = true; break;
                    }
                    if (skip) continue;

                     listDiv.innerHTML += `
                         <div class='profile-row'>
                             <div class='profile-label'>${icon}<span>${label}</span></div>
                             <span class='profile-value'>
                                 ${value !== undefined ? value : 'æœªç™»éŒ²'}
                             </span>
                         </div>
                     `;
                }
                // ä¸€æ‹¬ç·¨é›†ãƒœã‚¿ãƒ³
                listDiv.innerHTML += `
                    <div class="profile-edit-form-btns">
                        <button class="edit-btn" id="editAllBtn"><i class="fas fa-pen"></i> ã¾ã¨ã‚ã¦ç·¨é›†</button>
                    </div>
                `;
                document.getElementById('editAllBtn').onclick = function() {
                    isEditing = true;
                    renderProfile(currentData, true);
                };
            } else {
                // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ 
                listDiv.innerHTML = `<form id="profileEditForm" autocomplete="off"></form>`;
                const form = document.getElementById('profileEditForm');
                for (const key of order) {
                    let field = editableFields[key];
                    let value = data[key];
                    let label = '';
                    let icon = '';
                    let skip = false;
                    switch(key){
                        case 'name': label='åå‰'; icon='<i class="fas fa-user"></i>'; break;
                        case 'gender': label='æ€§åˆ¥'; icon='<i class="fas fa-venus-mars"></i>'; break;
                        case 'age': label='å¹´é½¢'; icon='<i class="fas fa-birthday-cake"></i>'; break;
                        case 'email': label='ãƒ¡ãƒ¼ãƒ«'; icon='<i class="fas fa-envelope"></i>'; break;
                        case 'specialty': label='å°‚é–€'; icon='<i class="fas fa-stethoscope"></i>'; break;
                        case 'hospital': label='ç—…é™¢'; icon='<i class="fas fa-hospital"></i>'; break;
                        case 'experience': label='å‹¤å‹™å¹´æ•°'; icon='<i class="fas fa-clock"></i>'; break;
                        default: skip = true; break;
                    }
                    if (skip) continue;

                    let inputHtml = '';
                    if (field) {
                        if (field.type === 'select') {
                            inputHtml = `<select class="profile-edit-input" name="${key}" id="editInput_${key}">
                                ${field.options.map(opt => `<option value="${opt}"${(value===opt)?' selected':''}>${opt}</option>`).join('')}
                            </select>`;
                                } else {
                            inputHtml = `<input class="profile-edit-input" name="${key}" id="editInput_${key}" type="${field.type}" value="${value!==undefined?value:''}" 
                                ${field.placeholder?`placeholder="${field.placeholder}"`:''}
                                ${field.min!==undefined?`min="${field.min}"`:''}
                                ${field.max!==undefined?`max="${field.max}"`:''}
                            >`;
                        }
                    }
                     form.innerHTML += `
                         <div class='profile-row'>
                             <div class='profile-label'>${icon}<span>${label}</span></div>
                             <div class='profile-value'>
                                 ${inputHtml}
                             </div>
                         </div>
                     `;
                }
                // ä¿å­˜ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
                form.innerHTML += `
                    <div class="profile-edit-form-btns">
                        <button type="submit" class="save-btn" id="saveAllBtn"><i class="fas fa-check"></i> ä¿å­˜</button>
                        <button type="button" class="cancel-btn" id="cancelAllBtn"><i class="fas fa-times"></i> ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                `;

                // ä¿å­˜å‡¦ç†
                form.onsubmit = async function(e) {
                    e.preventDefault();
                    let updateObj = {};
                    let newEmail = null;
                    for (const key of Object.keys(editableFields)) {
                        let field = editableFields[key];
                        let input = form.querySelector(`[name="${key}"]`);
                        if (!input) continue;
                        let newValue = input.value;
                        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                        if (field.type === 'number') {
                            newValue = Number(newValue);
                            if (isNaN(newValue) || (field.min!==undefined && newValue<field.min) || (field.max!==undefined && newValue>field.max)) {
                                alert(`${field.label}ã¯${field.min}ï½${field.max}ã®æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„`);
                                input.focus();
                                return;
                            }
                        }
                        if (field.type === 'email') {
                            if (!/^[^@]+@[^@]+\.[^@]+$/.test(newValue)) {
                                alert('æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                                input.focus();
                                return;
                            }
                            newEmail = newValue;
                        }
                        if (field.type === 'text' && (!newValue || newValue.trim()==='')) {
                            alert(`${field.label}ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`);
                            input.focus();
                            return;
                        }
                        updateObj[key] = newValue;
                    }
                    setLoading('ä¿å­˜ä¸­...');
                    try {
                        const db = firebase.firestore();
                        // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´ã¯authã«ã‚‚åæ˜ 
                        if (newEmail && newEmail !== currentUser.email) {
                            await currentUser.updateEmail(newEmail);
                        }
                        // ä¸Šæ›¸ãä¿å­˜ï¼ˆmerge: false ã§å®Œå…¨ä¸Šæ›¸ãã€merge: true ã§éƒ¨åˆ†ä¸Šæ›¸ãï¼‰
                        await db.collection('users').doc(currentUser.uid).set(updateObj, { merge: false });
                        // ç”»é¢ä¸Šã®currentDataã‚‚æ›´æ–°
                        Object.assign(currentData, updateObj);
                        isEditing = false;
                        alert('æ›´æ–°ã—ã¾ã—ãŸ');
                        renderProfile(currentData, false);
                    } catch (e) {
                        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
                        renderProfile(currentData, false);
                    }
                };
                // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                document.getElementById('cancelAllBtn').onclick = function() {
                    isEditing = false;
                    renderProfile(currentData, false);
                };
            }
        }

        setLoading('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å–å¾—ã—ã¦ã„ã¾ã™...');
        firebase.auth().onAuthStateChanged(async (user) => {
            if (!user) {
                setMessage('<i class="fas fa-sign-in-alt"></i>','æœªãƒ­ã‚°ã‚¤ãƒ³','ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã™');
                if (window.multiLang && typeof window.multiLang.updateUI === 'function') {
                    try { window.multiLang.updateUI(); } catch (_) {}
                }
                return;
            }
            currentUser = user;
            try {
                const db = firebase.firestore();
                const doc = await db.collection('users').doc(user.uid).get();
                if (!doc.exists) {
                    setMessage('<i class="fas fa-user"></i>','ãƒ‡ãƒ¼ã‚¿æœªç™»éŒ²','ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                let data = doc.data();
                currentData = data;
                renderProfile(data, false);
                if (window.multiLang && typeof window.multiLang.updateUI === 'function') {
                    try { window.multiLang.updateUI(); } catch (_) {}
                }
            } catch (error) {
                console.error('Error fetching user profile:', error);
                setMessage('<i class="fas fa-triangle-exclamation"></i>','ã‚¨ãƒ©ãƒ¼','ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                if (window.multiLang && typeof window.multiLang.updateUI === 'function') {
                    try { window.multiLang.updateUI(); } catch (_) {}
                }
            }
        });

        document.getElementById('deleteAccountBtn').onclick = async function(){
            if (!confirm('æœ¬å½“ã«é€€ä¼šã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) return;
            const user = firebase.auth().currentUser;
            if (!user) return alert('ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“');
            const db = firebase.firestore();
            try {
                await db.collection('users').doc(user.uid).delete();
                try {
                    await user.delete();
                        alert('é€€ä¼šãŒå®Œäº†ã—ã¾ã—ãŸ');
                        window.location.href = 'index.html';
                } catch (error) {
                        if (error.code === 'auth/requires-recent-login') {
                            const pw = prompt('å†èªè¨¼ã®ãŸã‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                            if (!pw) return alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™');
                            const cred = firebase.auth.EmailAuthProvider.credential(user.email, pw);
                        await user.reauthenticateWithCredential(cred);
                        await user.delete();
                                    alert('é€€ä¼šãŒå®Œäº†ã—ã¾ã—ãŸ');
                                    window.location.href = 'index.html';
                        } else {
                            alert('é€€ä¼šå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                        }
                }
            } catch (e) {
                alert('é€€ä¼šå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
            }
        };

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³å‡¦ç†
        document.getElementById('logoutBtn').onclick = async function() {
            try {
                await firebase.auth().signOut();
                window.location.href = 'index.html';
            } catch (e) {
                alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
            }
        };
    </script>
</body>
</html>
