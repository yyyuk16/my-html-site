<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="患者診療記録">患者診療記録</title>
    <link rel="stylesheet" href="maintab.css">

    <!-- 翻訳機能 -->
    <script src="translation.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
        body { background: #ffffff; }
        /* ===== サイドバー・チャットエリア・スタイルは省略（元のCSS流用） ===== */
        /* … あなたの元コードのCSS部分をそのままここに残してください … */
    </style>
</head>
<body>
    <!-- 💚 ヘッダー -->
    <header class="top-bar">
        <div class="header-inner">
            <div class="logo" style="font-size:2rem; font-weight:700; color:#2196f3;">
                <span data-translate="site_title">医療管理アプリ</span>
            </div>
            <nav>
                <ul class="tab-menu">
                    <li><a href="home.html">🏥 HOME</a></li>
                    <li><a href="list.html">👥 患者診療記録</a></li>
                    <li><a href="chat.html" class="active">📅 チャット</a></li>
                    <li><a href="docterprofile.html">👤 プロフィール</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="flex-container" style="margin-top:32px;">
        <!-- サイドバー：患者リスト -->
        <aside class="patient-list-panel">
            <h2><i class="fas fa-user-injured"></i> 担当患者一覧</h2>
            <div class="search-box">
                <input type="text" id="patientSearch" placeholder="患者を検索...">
                <i class="fas fa-search"></i>
            </div>
            <div class="chat-list" id="chatList"></div>
        </aside>

        <!-- メイン：チャットエリア -->
        <main class="chat-area" id="chatArea">
            <!-- 案内 -->
            <div id="chatGuide" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;">
                <i class="fas fa-comment-dots" style="font-size:3em;color:#2196F3;margin-bottom:18px;"></i>
                <p style="font-size:1.15em;color:#555;text-align:center;">
                    左の患者リストから<br>チャットしたい患者を選択してください。
                </p>
            </div>

            <!-- チャット画面 -->
            <div id="chatInterface" style="display:none;height:100%;flex-direction:column;">
                <div class="chat-header">
                    <h3 id="chatPatientName">患者名</h3>
                    <div class="patient-info" id="patientInfo"></div>
                </div>

                <div class="chat-messages" id="chatMessages"></div>

                <!-- AIクイズ結果 -->
                <div class="quiz-results-section" id="quizResultsSection" style="display:none;">
                    <h4><i class="fas fa-brain"></i> AIクイズ結果</h4>
                    <div id="quizResults" class="quiz-results"></div>
                </div>

                <!-- 入力 -->
                <div class="chat-input-container">
                    <textarea id="messageInput" placeholder="メッセージを入力..." rows="2" aria-label="メッセージ入力"></textarea>
                    <div class="chat-input-actions" style="display:flex;gap:8px;align-items:center;">
                        <button id="newlineBtn" class="send-btn" type="button" aria-label="改行を挿入" title="改行">
                            <i class="fas fa-level-down-alt" style="transform:rotate(90deg);"></i> 改行
                        </button>
                        <button id="clearBtn" class="send-btn" type="button" aria-label="入力をクリア" title="クリア">
                            <i class="fas fa-eraser"></i> クリア
                        </button>
                        <button id="sendBtn" class="send-btn" type="button" aria-label="メッセージを送信" title="送信" disabled>
                            <i class="fas fa-paper-plane"></i> 送信
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- フッター -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-links">
                    <a href="#">利用規約</a>
                    <a href="#">プライバシーポリシー</a>
                </div>
                <div class="footer-copyright">
                    <small>© 2024 医療管理アプリ. All rights reserved.</small>
                </div>
            </div>
        </div>
    </footer>

    <!-- Firebase SDK (v9 compat のみ使用) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
        // ================= Firebase 初期化 =================
        const firebaseConfig = {
            apiKey: "AIzaSyB7TuGhOKbB4w7DDYt7KTejy-TrcxVZmpU",
            authDomain: "web01-2484d.firebaseapp.com",
            projectId: "web01-2484d",
            storageBucket: "web01-2484d.appspot.com",
            messagingSenderId: "90159472898",
            appId: "1:90159472898:web:261ec71f9919611011e21b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const chatListDiv = document.getElementById('chatList');

        // ================= ユーザーログインチェック =================
        firebase.auth().onAuthStateChanged(async (user) => {
            if (!user) {
                alert('ログインしてください');
                window.location.href = 'login.html';
                return;
            }

            const userDoc = await db.collection('users').doc(user.uid).get();
            if (!userDoc.exists || userDoc.data().role !== 'staff') {
                alert('医療者以外はアクセスできません');
                window.location.href = 'patient_home.html';
                return;
            }

            // 担当患者取得
            const patientsSnapshot = await db.collection('users')
                .where('role', '==', 'patient')
                .where('assignedDoctor', '==', user.uid)
                .get();

            if (patientsSnapshot.empty) {
                chatListDiv.innerHTML = '<p style="color:#888;text-align:center;">担当患者がいません</p>';
                return;
            }

            patientsSnapshot.forEach(doc => {
                const patient = doc.data();
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.innerHTML = `
                    <div class="doctor-avatar">${patient.name ? patient.name[0] : '?'}</div>
                    <div class="chat-info">
                        <div class="doctor-name">${patient.name || '名無し'}</div>
                    </div>`;
                chatItem.onclick = () => openChat(doc.id, patient.name);
                chatListDiv.appendChild(chatItem);
            });
        });

        // ================= 患者選択 =================
        function openChat(patientId, patientName) {
            document.getElementById('chatGuide').style.display = 'none';
            document.getElementById('chatInterface').style.display = 'flex';

            document.getElementById('chatPatientName').textContent = patientName;
            document.getElementById('patientInfo').innerHTML =
                `<span style="color:#666;font-size:0.9em;"><i class="fas fa-user"></i> ID: ${patientId}</span>`;

            loadChatHistory(patientId);
            loadAIQuizResults(patientId);
            setupChatInput(patientId);
            setupRealtimeChat(patientId);
        }

        // ================= チャット履歴 =================
        async function loadChatHistory(patientId) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            chatMessages.innerHTML = '読み込み中...';

            const currentUser = firebase.auth().currentUser;
            const chatRoomId = [currentUser.uid, patientId].sort().join('_');
            const snapshot = await db.collection('chats').doc(chatRoomId).collection('messages')
                .orderBy('timestamp', 'asc').get();

            chatMessages.innerHTML = '';
            if (snapshot.empty) {
                chatMessages.innerHTML = '<p style="color:#888;text-align:center;">メッセージなし</p>';
                return;
            }
            snapshot.forEach(doc => displayMessage(doc.data(), currentUser.uid));
            // 履歴ロード後に一番下へスクロール
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function displayMessage(message, currentUserId) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;

            const div = document.createElement('div');
            div.className = `message ${message.senderId === currentUserId ? 'sent' : 'received'}`;
            const time = message.timestamp?.seconds
                ? new Date(message.timestamp.seconds * 1000).toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'})
                : '--:--';
            div.innerHTML = `<div class="message-content">
                <div class="message-text">${escapeHTML(message.text)}</div>
                <div class="message-time">${time}</div>
            </div>`;
            chatMessages.appendChild(div);
            // 新規メッセージ表示後に一番下へスクロール
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function escapeHTML(str) {
            return str ? str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : '';
        }

        // ================= 入力と送信 =================
        function setupChatInput(patientId) {
            const input = document.getElementById('messageInput');
            const btn = document.getElementById('sendBtn');
            const newlineBtn = document.getElementById('newlineBtn');
            const clearBtn = document.getElementById('clearBtn');
            if (!input || !btn) return;

            const updateSendButtonState = () => {
                const hasText = input.value.trim().length > 0;
                btn.disabled = !hasText;
            };

            btn.onclick = () => sendMessage(patientId);
            input.onkeypress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage(patientId);
                }
            };
            input.addEventListener('input', updateSendButtonState);
            updateSendButtonState();

            if (newlineBtn) {
                newlineBtn.onclick = () => {
                    const start = input.selectionStart ?? input.value.length;
                    const end = input.selectionEnd ?? input.value.length;
                    const before = input.value.substring(0, start);
                    const after = input.value.substring(end);
                    input.value = `${before}\n${after}`;
                    const newPos = start + 1;
                    input.selectionStart = input.selectionEnd = newPos;
                    input.focus();
                    updateSendButtonState();
                };
            }

            if (clearBtn) {
                clearBtn.onclick = () => {
                    input.value = '';
                    input.focus();
                    updateSendButtonState();
                };
            }
        }

        async function sendMessage(patientId) {
            const input = document.getElementById('messageInput');
            if (!input) return;
            const text = input.value.trim();
            if (!text) return;

            const currentUser = firebase.auth().currentUser;
            const chatRoomId = [currentUser.uid, patientId].sort().join('_');
            const msg = {
                text, senderId: currentUser.uid,
                senderName: currentUser.displayName || '医師',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            await db.collection('chats').doc(chatRoomId).collection('messages').add(msg);
            input.value = '';
            // 送信後はボタンを非活性に戻す
            const btn = document.getElementById('sendBtn');
            if (btn) btn.disabled = true;
            // メッセージリストを下へスクロール
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ================= AIクイズ結果 =================
        async function loadAIQuizResults(patientId) {
            const section = document.getElementById('quizResultsSection');
            const container = document.getElementById('quizResults');
            if (!section || !container) return;

            const patientDoc = await db.collection('users').doc(patientId).get();
            if (!patientDoc.exists || !patientDoc.data().email) return;

            const email = patientDoc.data().email;
            const snapshot = await db.collection('ai_quiz_scores')
                .where('userEmail', '==', email).limit(5).get();

            if (snapshot.empty) { section.style.display = 'none'; return; }
            section.style.display = 'block';
            container.innerHTML = '';

            snapshot.forEach(doc => {
                const data = doc.data();
                const accuracy = data.accuracy ? Math.round(data.accuracy*100) : 0;
                container.innerHTML += `<div>正答率: ${accuracy}%</div>`;
            });
        }

        // ================= リアルタイム =================
        function setupRealtimeChat(patientId) {
            const currentUser = firebase.auth().currentUser;
            const chatRoomId = [currentUser.uid, patientId].sort().join('_');

            if (window.chatListener) window.chatListener();
            window.chatListener = db.collection('chats').doc(chatRoomId).collection('messages')
                .orderBy('timestamp','asc')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const msg = change.doc.data();
                            if (msg.senderId !== currentUser.uid) {
                                displayMessage(msg, currentUser.uid);
                            }
                        }
                    });
                });
        }
    </script>
</body>
</html>
