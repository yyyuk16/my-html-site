<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Firebase リアルタイムチャット</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="chat.css">
  
  <style>
    /* 左右で配置を分ける簡易スタイル */
    .chat-messages { padding: 12px; overflow-y: auto; height: 60vh; background: #f8fafc; }
    /* 既存chat.cssの.messageスタイルを打ち消し */
    .message { max-width: 78%; margin: 8px 6px; display: flex; background: transparent !important; border: none !important; box-shadow: none !important; padding: 0 !important; }
    .message.self { justify-content: flex-end; margin-left: auto; }
    .bubble { position: relative; background: #fff; border: 1px solid #e3e8ef; border-radius: 14px 14px 14px 8px; padding: 8px 12px; display: inline-flex; gap: 8px; align-items: center; }
    .message.self .bubble { background: #e3f2fd; border-color: #90caf9; border-radius: 14px 14px 8px 14px; }
    .bubble:after { content: ""; position: absolute; bottom: 8px; width: 10px; height: 10px; transform: rotate(45deg); background: #fff; border-left: 1px solid #e3e8ef; border-bottom: 1px solid #e3e8ef; left: -5px; }
    .message.self .bubble:after { right: -5px; left: auto; background: #e3f2fd; border-left: none; border-bottom: 1px solid #90caf9; border-right: 1px solid #90caf9; }
    .msg-text { white-space: pre-wrap; color: #222b45; }
    .msg-time { font-size: .75rem; color: #90a4ae; }
  </style>
    
  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  
  <!-- 多言語対応 -->
  <script src="multilang.js"></script>
  

</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <h2 data-translate="realtime_chat">リアルタイムチャット（患者用）</h2>
      <div id="assignedDoctorContainer">
        <span data-translate="assigned_doctor">担当医師</span>: <span id="assignedDoctorName">読み込み中...</span>
      </div>
    </div>

    <div id="chat" class="chat-messages"></div>

    <div class="input-container">
      <input type="text" id="messageInput" placeholder="メッセージを入力" autocomplete="off" data-translate="message_input" />
      <button id="sendBtn" data-translate="send">送信</button>
      <button onclick="window.location.href='ai.html'" class="back-btn" data-translate="back">戻る</button>
    </div>
  </div>

  <script>
    // ===== Firestore で医師側 chat.html と同じコレクションを使用 =====
    const firebaseConfig = {
             apiKey: "AIzaSyB7TuGhOKbB4w7DDYt7KTejy-TrcxVZmpU",
      authDomain: "web01-2484d.firebaseapp.com",
      projectId: "web01-2484d",
      storageBucket: "web01-2484d.appspot.com",
      messagingSenderId: "90159472898",
      appId: "1:90159472898:web:261ec71f9919611011e21b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentUserUid = null;
    let assignedDoctorUid = null;
    let chatRoomId = null;
    let userLanguage = 'ja'; // Firestoreのユーザー設定から取得

    const chatDiv = document.getElementById('chat');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const assignedDoctorNameElem = document.getElementById('assignedDoctorName');

    function appendMessageBubble(text, isSelf, timestamp) {
      const el = document.createElement('div');
      el.className = `message${isSelf ? ' self' : ''}`;
      const timeStr = timestamp ? new Date(timestamp).toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'}) : '';
      el.innerHTML = `<div class="bubble"><span class="msg-text"></span><span class="msg-time">${timeStr}</span></div>`;
      // 自分のメッセージは原文を表示、相手メッセージは翻訳が入るまでプレースホルダ
      el.querySelector('.msg-text').textContent = isSelf ? text : '…';
      chatDiv.appendChild(el);
      chatDiv.scrollTop = chatDiv.scrollHeight;
      return el;
    }

    // OpenAI API（翻訳）
    async function translateTextOpenAI(text, targetLang) {
      if (!text) return '';
      try {
        const res = await fetch('/api/translate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, targetLang })
        });
        if (!res.ok) return '';
        const data = await res.json();
        return (data.translated || '').trim();
      } catch (e) {
        console.error('translate error', e);
        return '';
      }
    }

    async function loadDoctorName(uid) {
      try {
        const docSnap = await db.collection('users').doc(uid).get();
        const data = docSnap.exists ? docSnap.data() : null;
        assignedDoctorNameElem.textContent = data?.displayName || data?.userName || data?.name || '担当医師';
      } catch (e) {
        assignedDoctorNameElem.textContent = '情報取得エラー';
      }
    }

    function subscribeMessages() {
      if (!chatRoomId) return;
      return db.collection('chats').doc(chatRoomId).collection('messages')
        .orderBy('timestamp','asc')
        .onSnapshot((snapshot) => {
          chatDiv.innerHTML = '';
          snapshot.forEach(doc => {
            const m = doc.data();
            const ts = m.timestamp?.toMillis?.() ?? (typeof m.timestamp?.seconds === 'number' ? m.timestamp.seconds*1000 : m.clientTimeMs);
            const isSelf = m.senderId === currentUserUid;
            const el = appendMessageBubble(m.text || '', isSelf, ts);
            // 相手メッセージは翻訳テキストのみを表示
            if (!isSelf && userLanguage) {
              translateTextOpenAI(m.text || '', userLanguage).then(t => {
                const textSpan = el.querySelector('.msg-text');
                if (textSpan) textSpan.textContent = t || (m.text || '');
              });
            }
          });
        });
    }

    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text || !chatRoomId) return;
      const msg = {
        text,
        senderId: currentUserUid,
        senderName: '患者',
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      db.collection('chats').doc(chatRoomId).collection('messages').add(msg);
      messageInput.value = '';
    }

    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendBtn.click();
      }
    });

    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        alert('ログインしてください');
        window.location.href = 'login.html';
        return;
      }
      currentUserUid = user.uid;

      const userDoc = await db.collection('users').doc(currentUserUid).get();
      const userData = userDoc.exists ? userDoc.data() : {};
      userLanguage = userData.language || 'ja';
      assignedDoctorUid = userData.assignedDoctorUid || userData.assignedDoctor;
      if (!assignedDoctorUid) {
        assignedDoctorNameElem.textContent = '担当医師未割り当て';
        return;
      }

      await loadDoctorName(assignedDoctorUid);
      chatRoomId = [currentUserUid, assignedDoctorUid].sort().join('_');
      if (window.unsubscribeChat) window.unsubscribeChat();
      window.unsubscribeChat = subscribeMessages();
    });
  </script>
</body>
</html>