<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="æ‚£è€…è¨ºç™‚è¨˜éŒ²">æ‚£è€…è¨ºç™‚è¨˜éŒ²</title>
    <link rel="stylesheet" href="maintab.css">
    <link rel="stylesheet" href="d_footer.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- ç¿»è¨³æ©Ÿèƒ½ -->
    <script src="translation.js"></script>
    
    <style>
        /* æ‚£è€…æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .patient-info-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
        }
        
        .patient-header {
            background: linear-gradient(135deg, #2196f3, #21cbf3);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .patient-name {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .patient-details {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .info-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
            border: 1px solid #e3f2fd;
        }
        
        .section-title {
            color: #2196f3;
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .quiz-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #2196f3;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #2196f3;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        .quiz-history {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .quiz-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #4caf50;
        }
        
        .quiz-item.poor {
            border-left-color: #f44336;
        }
        
        .quiz-item.good {
            border-left-color: #ff9800;
        }
        
        .quiz-date {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .quiz-score {
            font-weight: 600;
            color: #2196f3;
        }
        
        .memo-history {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .memo-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #2196f3;
        }
        
        .memo-date {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .memo-content {
            font-size: 0.95em;
        }
        
        .no-data {
            text-align: center;
            color: #999;
            padding: 20px;
            font-style: italic;
        }
        
        /* æ‚£è€…ãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .flex-container {
            display: flex;
            gap: 20px;
            padding: 20px;
            min-height: 70vh;
        }
        
        .patient-list-panel {
            flex: 0 0 300px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
            border: 1px solid #e3f2fd;
        }
        
        .patient-list-panel h2 {
            color: #2196f3;
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 100%;
            height: 30px;
            padding: 3px 1px 3px 4px;
            border: 1px solid #cfd8dc;
            border-radius: 6px;
            font-size: 0.8em;
            outline: none;
            background: #f1f5f9;
            transition: border-color 0.2s, background-color .2s;
        }
        
        .search-box input:focus {
            border-color: #2196f3;
            background: #fff;
        }
        
        .search-box i {
            position: absolute;
            right: 2px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 0.75em;
        }
        
        .chat-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .patient-item-hidden {
            display: none;
        }

        .show-more-btn {
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            background: #f8f9fa;
            border: 1px solid #e3f2fd;
            border-radius: 8px;
            color: #2196f3;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.2s;
        }

        .show-more-btn:hover {
            background: #e3f2fd;
        }

        /* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .hamburger-menu {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #2196f3;
            cursor: pointer;
            padding: 5px;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼‰ */
        .patient-list-sidebar {
            position: fixed;
            top: 0;
            left: -100%;
            width: 280px;
            max-width: 85%;
            height: 100vh;
            background: #fff;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            transition: left 0.3s ease;
            overflow-y: auto;
            padding: 20px 16px;
        }

        .patient-list-sidebar.active {
            left: 0;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e3f2fd;
        }

        .sidebar-header h2 {
            color: #2196f3;
            font-size: 1.2em;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .close-sidebar-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }

        .close-sidebar-btn:hover {
            color: #2196f3;
        }
        
        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 1px solid transparent;
        }
        
        .chat-item:hover {
            background-color: #f8f9fa;
        }
        
        .chat-item.selected {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }

        /* ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã®æ‚£è€…ãƒªã‚¹ãƒˆè¡¨ç¤º */
        .mobile-patient-list {
            display: none;
        }

        .mobile-patient-list-header {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        
        .doctor-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2196f3, #21cbf3);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 12px;
            font-size: 0.9em;
        }
        
        .chat-info {
            flex: 1;
        }
        
        .doctor-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .last-message {
            font-size: 0.85em;
            color: #666;
        }
        
        .patient-info-container {
            flex: 1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
            border: 1px solid #e3f2fd;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 12px;
            border: none;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .modal-title {
            color: #2196f3;
            font-size: 1.3em;
            font-weight: 600;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .modal-body {
            margin-bottom: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            border-color: #2196f3;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            flex-shrink: 0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.3s;
            min-width: 100px;
        }

        .btn-primary {
            background-color: #2196f3;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1976d2;
        }

        .btn-secondary {
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background-color: #e0e0e0;
        }

        /* --- ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨ãƒ‡ã‚¶ã‚¤ãƒ³ã®èª¿æ•´ --- */

        /* 1. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆPCï¼‰ã§ã¯ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒŠãƒ“ã‚’éš ã™ */
        .mobile-nav {
            display: none;
        }

        /* 2. ãƒ¢ãƒã‚¤ãƒ«ç”»é¢ï¼ˆ768pxä»¥ä¸‹ï¼‰ã®è¨­å®š */
        @media (max-width: 768px) {
            /* PCç”¨ãƒŠãƒ“ã‚’éš ã™ */
            .tab-menu {
                display: none;
            }

            /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç”»åƒã®ã‚ˆã†ãªã‚·ãƒ³ãƒ—ãƒ«æ§‹æˆã« */
            .top-bar {
                padding: 10px 15px;
                border-bottom: 1px solid #eee;
            }
            
            .header-inner {
                justify-content: space-between;
            }

            .logo span {
                font-size: 1.1rem;
            }

            /* ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º */
            .mobile-nav {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 70px;
                background: #f8f9fa;
                border-top: 1px solid #eee;
                justify-content: space-around;
                align-items: center;
                z-index: 1000;
                padding-bottom: env(safe-area-inset-bottom); /* iPhoneã®ãƒãƒ¼å¯¾ç­– */
            }

            .nav-item {
                text-decoration: none;
                color: #888;
                display: flex;
                flex-direction: column;
                align-items: center;
                font-size: 0.7rem;
                gap: 4px;
            }

            .nav-item i {
                font-size: 1.4rem;
            }

            .nav-item.active {
                color: #333; /* é¸æŠä¸­ã®è‰² */
            }

            /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸‹éƒ¨ã«ä½™ç™½ã‚’è¿½åŠ ï¼ˆãƒŠãƒ“ã«è¢«ã‚‰ãªã„ã‚ˆã†ã«ï¼‰ */
            body {
                padding-bottom: 80px;
            }
            
            /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ç¸¦ä¸¦ã³ã« */
            .flex-container {
                flex-direction: column;
                gap: 0;
                padding: 70px 0 80px 0;
            }

            /* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’éè¡¨ç¤ºï¼ˆç”»åƒã«ã¯ãªã„ï¼‰ */
            .hamburger-menu {
                display: none;
            }

            /* PCç‰ˆã®æ‚£è€…ãƒªã‚¹ãƒˆãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤º */
            .patient-list-panel {
                display: none;
            }

            /* ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã®æ‚£è€…ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º */
            .mobile-patient-list {
                display: block;
                padding: 0 2vw;
                margin-bottom: 20px;
            }

            .mobile-patient-list-header {
                font-size: 1.1rem;
                font-weight: 600;
                margin: 20px 0 15px 0;
                color: #333;
            }

            .mobile-patient-list .search-box {
                margin-bottom: 15px;
            }

            .mobile-patient-list .search-box input {
                width: 100%;
                height: 40px;
                padding: 8px 35px 8px 12px;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 1em;
                background: #f8f9fa;
            }

            .mobile-patient-list .chat-item {
                padding: 15px;
                border-bottom: 1px solid #eee;
                margin-bottom: 0;
                border-radius: 0;
            }

            .mobile-patient-list .doctor-avatar {
                width: 40px;
                height: 40px;
                font-size: 1.2em;
            }

            .mobile-patient-list .doctor-name {
                font-size: 1em;
            }

            .patient-info-container {
                width: 100%;
                min-width: 0;
                padding: 0 2vw 20px 2vw;
                display: none; /* ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã§ã¯æœ€åˆã¯éè¡¨ç¤º */
            }

            .patient-info-container.has-selection {
                display: block; /* æ‚£è€…ãŒé¸æŠã•ã‚ŒãŸã‚‰è¡¨ç¤º */
            }

            /* PCç‰ˆã®ãƒ•ãƒƒã‚¿ãƒ¼ã‚’ã‚¹ãƒãƒ›ã§ã¯éš ã™ï¼ˆãƒŠãƒ“ãŒã‚ã‚‹ãŸã‚ï¼‰ */
            .footer {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- ğŸ’š ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="top-bar">
        <div class="header-inner">
            <div style="display: flex; align-items: center; gap: 10px;">
                <button class="hamburger-menu" id="hamburgerMenu">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo" style="font-size:2rem; font-weight:700; color:#2196f3; letter-spacing:0.08em; display:flex; align-items:center;">
                    <span data-translate="site_title" style="vertical-align:middle;">çµæ ¸æ²»ç™‚ã‚¢ãƒ—ãƒª</span>
                </div>
            </div>
            <nav>
                <ul class="tab-menu">
                    <li><a href="list.html" class="active">ğŸ‘¥ <span data-translate="æ‚£è€…è¨ºç™‚è¨˜éŒ²">æ‚£è€…è¨ºç™‚è¨˜éŒ²</span></a></li>
                    <li><a href="chat.html">ğŸ“… <span data-translate="ãƒãƒ£ãƒƒãƒˆ">ãƒãƒ£ãƒƒãƒˆ</span></a></li>
                    <li><a href="docterprofile.html">ğŸ¥ <span data-translate="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</span></a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼‰ -->
    <div class="patient-list-sidebar" id="patientListSidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-user-friends"></i> <span data-translate="æ‹…å½“æ‚£è€…ãƒªã‚¹ãƒˆ">æ‹…å½“æ‚£è€…ãƒªã‚¹ãƒˆ</span></h2>
            <button class="close-sidebar-btn" id="closeSidebarBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="search-box">
            <input type="text" id="patientSearchSidebar" placeholder="æ‚£è€…ã‚’æ¤œç´¢...">
            <i class="fas fa-search"></i>
        </div>
        <div class="chat-list" id="patientListSidebarContent"></div>
    </div>
        
    <div class="flex-container">
        <div class="patient-list-panel">
            <h2><i class="fas fa-user-friends"></i> <span data-translate="æ‹…å½“æ‚£è€…ãƒªã‚¹ãƒˆ">æ‹…å½“æ‚£è€…ãƒªã‚¹ãƒˆ</span></h2>
            <div class="search-box">
                <input type="text" id="patientSearch" data-translate="æ‚£è€…ã‚’æ¤œç´¢..." placeholder="æ‚£è€…ã‚’æ¤œç´¢...">
                <i class="fas fa-search"></i>
            </div>
            <div class="chat-list" id="patientList"></div>
        </div>
        <div class="patient-info-container" id="patientInfoArea">
            <div class="no-data">
                <i class="fas fa-user" style="font-size: 3em; color: #ccc; margin-bottom: 15px;"></i>
                <p>æ‚£è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav class="mobile-nav">
        <a href="list.html" class="nav-item active">
            <i class="fa-solid fa-clipboard-list"></i>
            <span data-translate="æ‚£è€…è¨ºç™‚è¨˜éŒ²">æ‚£è€…è¨ºç™‚è¨˜éŒ²</span>
        </a>
        <a href="chat.html" class="nav-item">
            <i class="fa-solid fa-comments"></i>
            <span data-translate="ãƒãƒ£ãƒƒãƒˆ">ãƒãƒ£ãƒƒãƒˆ</span>
        </a>
        <a href="docterprofile.html" class="nav-item">
            <i class="fa-regular fa-user"></i>
            <span data-translate="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</span>
        </a>
    </nav>
    
    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-links">
                    <a href="#" data-translate="terms">åˆ©ç”¨è¦ç´„</a>
                    <a href="#" data-translate="privacy">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
                </div>
                <div class="footer-copyright">
                    <small data-translate="copyright_name">Â© 2024 åŒ»ç™‚ç®¡ç†ã‚¢ãƒ—ãƒª. All rights reserved.</small>
                </div>
            </div>
        </div>
    </footer>

    <!-- è¨ºå¯Ÿè¨˜éŒ²è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="memoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-notes-medical"></i> è¨ºå¯Ÿè¨˜éŒ²ã‚’è¿½åŠ 
                </h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="memoForm">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-calendar-alt"></i> è¨ºå¯Ÿæ—¥
                        </label>
                        <input type="date" id="memoDate" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-stethoscope"></i> ç—…çŠ¶
                        </label>
                        <textarea id="memoCondition" class="form-input form-textarea" placeholder="æ‚£è€…ã®ç—‡çŠ¶ã‚„ç—…çŠ¶ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-pills"></i> å‡¦æ–¹ç®‹
                        </label>
                        <textarea id="memoPrescription" class="form-input form-textarea" placeholder="å‡¦æ–¹ã—ãŸè–¬ã‚„æ²»ç™‚å†…å®¹ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-pen"></i> ãã®ä»–ã®ãƒ¡ãƒ¢
                        </label>
                        <textarea id="memoOther" class="form-input form-textarea" placeholder="ãã®ä»–ã®æ³¨æ„äº‹é …ã‚„ãƒ¡ãƒ¢ãŒã‚ã‚Œã°è¨˜éŒ²ã—ã¦ãã ã•ã„"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="closeModalBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-primary" id="saveMemoBtn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
    const firebaseConfig = {
  apiKey: "AIzaSyB7TuGhOKbB4w7DDYt7KTejy-TrcxVZmpU",
  authDomain: "web01-2484d.firebaseapp.com",
  databaseURL: "https://web01-2484d-default-rtdb.firebaseio.com",
  projectId: "web01-2484d",
  storageBucket: "web01-2484d.firebasestorage.app",
  messagingSenderId: "90159472898",
  appId: "1:90159472898:web:261ec71f9919611011e21b",
  measurementId: "G-9TGR07ZSY9"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let currentUserId = null;
    let patients = [];
    let selectedPatientId = null;

    // æ‹…å½“æ‚£è€…ãƒªã‚¹ãƒˆå–å¾—
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
        window.location.href = 'login.html';
        return;
      }
      currentUserId = user.uid;
      // usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰æ‹…å½“æ‚£è€…ã‚’å–å¾—ï¼ˆassignedDoctor ã¨ assignedDoctorUid ã®ä¸¡æ–¹ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
      console.log('æ‹…å½“æ‚£è€…ã‚’å–å¾—ä¸­... åŒ»å¸«UID:', currentUserId);
      
      const patientMap = new Map();
      
      // assignedDoctor ã§ã‚¯ã‚¨ãƒª
      try {
        const patientsSnapshot1 = await db.collection('users')
          .where('role', '==', 'patient')
          .where('assignedDoctor', '==', currentUserId)
          .get();
        
        patientsSnapshot1.forEach(doc => {
          const data = doc.data();
          if (data.assignedDoctor === currentUserId || data.assignedDoctorUid === currentUserId) {
            patientMap.set(doc.id, { id: doc.id, ...data });
          }
        });
        console.log('assignedDoctor ã‚¯ã‚¨ãƒªã§å–å¾—:', patientsSnapshot1.size, 'ä»¶');
      } catch (e) {
        console.warn('assignedDoctor ã‚¯ã‚¨ãƒªã‚¨ãƒ©ãƒ¼:', e);
      }
      
      // assignedDoctorUid ã§ã‚¯ã‚¨ãƒª
      try {
        const patientsSnapshot2 = await db.collection('users')
          .where('role', '==', 'patient')
          .where('assignedDoctorUid', '==', currentUserId)
          .get();
        
        patientsSnapshot2.forEach(doc => {
          const data = doc.data();
          if (data.assignedDoctor === currentUserId || data.assignedDoctorUid === currentUserId) {
            patientMap.set(doc.id, { id: doc.id, ...data });
          }
        });
        console.log('assignedDoctorUid ã‚¯ã‚¨ãƒªã§å–å¾—:', patientsSnapshot2.size, 'ä»¶');
      } catch (e) {
        console.warn('assignedDoctorUid ã‚¯ã‚¨ãƒªã‚¨ãƒ©ãƒ¼ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœªä½œæˆã®å¯èƒ½æ€§ï¼‰:', e);
        // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæœªä½œæˆã®å ´åˆã€å…¨æ‚£è€…ã‚’å–å¾—ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        try {
          console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å…¨æ‚£è€…ã‚’å–å¾—ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°...');
          const allPatientsSnapshot = await db.collection('users')
            .where('role', '==', 'patient')
            .get();
          
          allPatientsSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.assignedDoctor === currentUserId || data.assignedDoctorUid === currentUserId) {
              patientMap.set(doc.id, { id: doc.id, ...data });
            }
          });
          console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§è¿½åŠ :', allPatientsSnapshot.size, 'ä»¶ä¸­', patientMap.size, 'ä»¶ãŒè©²å½“');
        } catch (fallbackError) {
          console.error('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¯ã‚¨ãƒªã‚‚å¤±æ•—:', fallbackError);
        }
      }
      
      patients = Array.from(patientMap.values());
      console.log('æœ€çµ‚çš„ãªæ‚£è€…æ•°:', patients.length);
      if (patients.length > 0) {
        console.log('æ‚£è€…ãƒªã‚¹ãƒˆ:', patients.map(p => ({ 
          id: p.id, 
          name: p.name, 
          assignedDoctor: p.assignedDoctor, 
          assignedDoctorUid: p.assignedDoctorUid 
        })));
      } else {
        console.warn('âš ï¸ æ‹…å½“æ‚£è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ‚£è€…ãƒ‡ãƒ¼ã‚¿ã® assignedDoctor ã¾ãŸã¯ assignedDoctorUid ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      }
      
      renderPatientList(); // PCç‰ˆ
      renderPatientListMobile(); // ãƒ¢ãƒã‚¤ãƒ«ç‰ˆ
    });

    function renderPatientList(targetDiv = null) {
      const listDiv = targetDiv || document.getElementById('patientList');
      if (!listDiv) return;
      
      listDiv.innerHTML = '';
      if (patients.length === 0) {
        listDiv.innerHTML = '<p style="color:var(--text-color-muted,#4A4A4A);text-align:center;margin:32px 0;">æ‹…å½“æ‚£è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
        return;
      }
      
      const maxVisible = 3;
      const hasMore = patients.length > maxVisible;
      
      patients.forEach((patient, index) => {
        const item = document.createElement('div');
        const isHidden = index >= maxVisible;
        item.className = 'chat-item' + (selectedPatientId === patient.id ? ' selected' : '') + (isHidden ? ' patient-item-hidden' : '');
        item.innerHTML = `
          <div class="doctor-avatar">${patient.name ? patient.name.charAt(0) : '?'}</div>
          <div class="chat-info">
            <div class="doctor-name">${patient.name || 'åç„¡ã—ã®æ‚£è€…'}</div>
            <div class="last-message">${patient.age ? patient.age + 'æ­³' : ''}</div>
          </div>
        `;
        item.onclick = () => {
          selectPatient(patient.id);
        };
        listDiv.appendChild(item);
      });
      
      // ã€Œã‚‚ã£ã¨è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
      if (hasMore) {
        const showMoreBtn = document.createElement('button');
        showMoreBtn.className = 'show-more-btn';
        showMoreBtn.textContent = `ã‚‚ã£ã¨è¦‹ã‚‹ (${patients.length - maxVisible}äºº)`;
        let isExpanded = false;
        showMoreBtn.onclick = function() {
          const allItems = listDiv.querySelectorAll('.chat-item');
          isExpanded = !isExpanded;
          
          if (isExpanded) {
            // å…¨ã¦è¡¨ç¤ºã™ã‚‹
            allItems.forEach((item, index) => {
              if (index >= maxVisible) {
                item.classList.remove('patient-item-hidden');
              }
            });
            showMoreBtn.textContent = 'é–‰ã˜ã‚‹';
          } else {
            // 4äººç›®ä»¥é™ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            allItems.forEach((item, index) => {
              if (index >= maxVisible) {
                item.classList.add('patient-item-hidden');
              }
            });
            showMoreBtn.textContent = `ã‚‚ã£ã¨è¦‹ã‚‹ (${patients.length - maxVisible}äºº)`;
          }
        };
        listDiv.appendChild(showMoreBtn);
      }
      
      // æœ€åˆã®æ‚£è€…ã‚’è‡ªå‹•é¸æŠï¼ˆPCç‰ˆã®ã¿ï¼‰
      if (!targetDiv && !selectedPatientId && patients.length > 0) {
        setTimeout(() => {
          selectPatient(patients[0].id);
        }, 100);
      }
    }

    function renderPatientListMobile() {
      const listDiv = document.getElementById('patientListMobile');
      if (!listDiv) return;
      
      listDiv.innerHTML = '';
      if (patients.length === 0) {
        listDiv.innerHTML = '<p style="color:var(--text-color-muted,#4A4A4A);text-align:center;margin:32px 0; padding: 20px;">æ‹…å½“æ‚£è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
        return;
      }
      
      patients.forEach((patient) => {
        const item = document.createElement('div');
        item.className = 'chat-item' + (selectedPatientId === patient.id ? ' selected' : '');
        item.innerHTML = `
          <div class="doctor-avatar">${patient.name ? patient.name.charAt(0) : '?'}</div>
          <div class="chat-info">
            <div class="doctor-name">${patient.name || t('unnamed_patient', 'åç„¡ã—ã®æ‚£è€…')}${t('honorific_suffix', 'ã•ã‚“')}</div>
          </div>
        `;
        item.onclick = () => {
          selectPatient(patient.id);
        };
        listDiv.appendChild(item);
      });
    }

    async function selectPatient(patientId) {
      console.log('æ‚£è€…ã‚’é¸æŠ:', patientId);
      selectedPatientId = patientId;
      const patient = patients.find(p => p.id === patientId);
      if (!patient) {
        console.log('æ‚£è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', patientId);
        return;
      }
      console.log('é¸æŠã•ã‚ŒãŸæ‚£è€…:', patient);
      
      // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆPCç‰ˆã¨ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã®ä¸¡æ–¹ï¼‰
      document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('selected');
        const nameEl = item.querySelector('.doctor-name');
        if (nameEl && nameEl.textContent.includes(patient.name)) {
          item.classList.add('selected');
        }
      });
      
      // ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã®ãƒªã‚¹ãƒˆã‚‚æ›´æ–°
      if (window.innerWidth <= 768) {
        renderPatientListMobile();
      }
      
      // æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—
      const doc = await db.collection('users').doc(patientId).get();
      const data = doc.data();
      const memos = data.memos || [];
      
      // æ‚£è€…æƒ…å ±ã‚’è¡¨ç¤º
      await renderPatientInfo(patient, data, memos);
    }

    async function renderPatientInfo(patient, data, memos) {
      const area = document.getElementById('patientInfoArea');
      const noDataDiv = document.getElementById('noPatientSelected');
      console.log('æ‚£è€…æƒ…å ±ã‚’è¡¨ç¤ºä¸­:', patient);
      
      // ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã§ã¯æ‚£è€…ãƒªã‚¹ãƒˆã‚’éè¡¨ç¤ºã«ã—ã¦è©³ç´°ã‚’è¡¨ç¤º
      if (window.innerWidth <= 768) {
        const mobileList = document.querySelector('.mobile-patient-list');
        if (mobileList) {
          mobileList.style.display = 'none';
        }
        // è©³ç´°ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
        area.classList.add('has-selection');
      }
      
      // ã‚¯ã‚¤ã‚ºçµæœã‚’å–å¾—
      const quizResults = await getQuizResults(patient.email);
      console.log('ã‚¯ã‚¤ã‚ºçµæœ:', quizResults);
      
      // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆãƒ¢ãƒã‚¤ãƒ«ç‰ˆã®ã¿ï¼‰
      const backButtonHtml = window.innerWidth <= 768 ? `
        <button class="back-to-list-btn" id="backToListBtn" style="margin-bottom: 20px; padding: 10px 15px; background: #2196f3; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em; width: 100%;">
          â† æ‚£è€…ãƒªã‚¹ãƒˆã«æˆ»ã‚‹
        </button>
      ` : '';
      
      area.innerHTML = backButtonHtml + `
        <div class="patient-header">
          <div class="patient-name">${patient.name || 'åç„¡ã—ã®æ‚£è€…'}</div>
          <div class="patient-details">
            <span><i class="fas fa-birthday-cake"></i> ${patient.age || 'æœªç™»éŒ²'}æ­³</span>
            <span><i class="fas fa-envelope"></i> ${patient.email || 'æœªç™»éŒ²'}</span>
            <span><i class="fas fa-calendar"></i> ç™»éŒ²æ—¥: ${patient.createdAt ? new Date(patient.createdAt.seconds * 1000).toLocaleDateString('ja-JP') : 'ä¸æ˜'}</span>
          </div>
        </div>
        
        <div class="info-section">
          <div class="section-title">
            <i class="fas fa-chart-line"></i> ã‚¯ã‚¤ã‚ºçµ±è¨ˆ
          </div>
          <div class="quiz-stats">
            <div class="stat-card">
              <div class="stat-value">${quizResults.totalQuizzes || 0}</div>
              <div class="stat-label">ç·ã‚¯ã‚¤ã‚ºå›æ•°</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${quizResults.averageAccuracy || 0}%</div>
              <div class="stat-label">å¹³å‡æ­£ç­”ç‡</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${quizResults.bestScore || 0}%</div>
              <div class="stat-label">æœ€é«˜ã‚¹ã‚³ã‚¢</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${quizResults.recentQuizzes || 0}</div>
              <div class="stat-label">æœ€è¿‘7æ—¥é–“</div>
            </div>
          </div>
        </div>
        
        <div class="info-section">
          <div class="section-title">
            <i class="fas fa-history"></i> æœ€è¿‘ã®ã‚¯ã‚¤ã‚ºçµæœ
          </div>
          <div class="quiz-history">
            ${quizResults.recentQuizzesList.length > 0 ? 
              quizResults.recentQuizzesList.map(quiz => {
                // Firebaseã®å®Ÿéš›ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’ä½¿ç”¨
                const score = quiz.score || 0;
                const total = quiz.total || 0;
                const accuracyPercent = total > 0 ? Math.round((score / total) * 100) : 0;
                
                // æ­£ç­”ç‡ã«åŸºã¥ãè‰²åˆ†ã‘ï¼ˆãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸åŸºæº–ï¼‰
                const itemClass = accuracyPercent >= 80 ? 'excellent' : accuracyPercent >= 60 ? 'good' : 'poor';
                
                return `
                  <div class="quiz-item ${itemClass}">
                    <div class="quiz-date">${new Date((quiz.createdAt && quiz.createdAt.seconds) ? quiz.createdAt.seconds * 1000 : Date.now()).toLocaleDateString('ja-JP')}</div>
                    <div class="quiz-score">æ­£ç­”ç‡: ${accuracyPercent}% (${score}/${total}å•)</div>
                  </div>
                `;
              }).join('') : 
              '<div class="no-data">ã‚¯ã‚¤ã‚ºçµæœãŒã‚ã‚Šã¾ã›ã‚“</div>'
            }
          </div>
        </div>
        
        <div class="info-section">
          <div class="section-title">
            <i class="fas fa-notes-medical"></i> è¨ºå¯Ÿè¨˜éŒ² (${memos.length}ä»¶)
            <button id="addMemoBtn" class="add-memo-btn" style="margin-left: auto; background: #2196f3; color: white; border: none; border-radius: 8px; padding: 8px 16px; cursor: pointer; font-size: 0.9em;">
              <i class="fas fa-plus"></i> è¨˜éŒ²ã‚’è¿½åŠ 
            </button>
          </div>
          <div class="memo-history">
            ${memos.length > 0 ? 
              memos.slice(0, 5).map(memo => `
                <div class="memo-item">
                  <div class="memo-date">${memo.date} - ${memo.doctorName || 'åŒ»å¸«'}</div>
                  <div class="memo-content">
                    ${memo.condition ? `<strong>ç—…çŠ¶:</strong> ${memo.condition}<br>` : ''}
                    ${memo.prescription ? `<strong>å‡¦æ–¹:</strong> ${memo.prescription}<br>` : ''}
                    ${memo.other ? `<strong>ãã®ä»–:</strong> ${memo.other}` : ''}
                  </div>
                </div>
              `).join('') : 
              '<div class="no-data">è¨ºå¯Ÿè¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>'
            }
          </div>
        </div>
      `;
      
      // è¨ºå¯Ÿè¨˜éŒ²è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      const addMemoBtn = document.getElementById('addMemoBtn');
      if (addMemoBtn) {
        addMemoBtn.onclick = function() {
          openMemoModal(patient);
        };
      }
      
      // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ï¼ˆãƒ¢ãƒã‚¤ãƒ«ç‰ˆã®ã¿ï¼‰
      if (window.innerWidth <= 768) {
        const backBtn = document.getElementById('backToListBtn');
        if (backBtn) {
          backBtn.onclick = function() {
            const mobileList = document.querySelector('.mobile-patient-list');
            if (mobileList) {
              mobileList.style.display = 'block';
            }
            area.classList.remove('has-selection');
            area.innerHTML = '<div class="no-data" id="noPatientSelected"><i class="fas fa-user" style="font-size: 3em; color: #ccc; margin-bottom: 15px;"></i><p>æ‚£è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</p></div>';
            selectedPatientId = null;
            document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('selected'));
          };
        }
      }
    }

    function renderMemoArea(patient, memos) {
      const area = document.getElementById('memoArea');
      const currentDate = new Date().toISOString().split('T')[0];
      
      area.innerHTML = `
        <h2><i class="fas fa-notes-medical"></i> ${patient.name}${t('honorific_suffix', 'ã•ã‚“')} ${t('medical_memo', 'ã®è¨ºç™‚ãƒ¡ãƒ¢')}</h2>
        <form id="memoForm">
          <div class="memo-field">
            <label><i class="fas fa-calendar-alt"></i> è¨ºå¯Ÿæ—¥</label>
            <input type="date" class="memo-input" id="memoDate" value="${currentDate}">
          </div>
          <div class="memo-field">
            <label><i class="fas fa-stethoscope"></i> ç—…çŠ¶ <span style="color:#666;font-size:0.9em;">(å¿…é ˆ)</span></label>
            <textarea class="memo-input" id="memoCondition" rows="3" placeholder="æ‚£è€…ã®ç—‡çŠ¶ã‚„ç—…çŠ¶ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„"></textarea>
          </div>
          <div class="memo-field">
            <label><i class="fas fa-pills"></i> å‡¦æ–¹ç®‹</label>
            <textarea class="memo-input" id="memoPrescription" rows="3" placeholder="å‡¦æ–¹ã—ãŸè–¬ã‚„æ²»ç™‚å†…å®¹ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„"></textarea>
          </div>
          <div class="memo-field">
            <label><i class="fas fa-pen"></i> ãã®ä»–ã®ãƒ¡ãƒ¢</label>
            <textarea class="memo-input" id="memoOther" rows="2" placeholder="ãã®ä»–ã®æ³¨æ„äº‹é …ã‚„ãƒ¡ãƒ¢ãŒã‚ã‚Œã°è¨˜éŒ²ã—ã¦ãã ã•ã„"></textarea>
          </div>
          <button class="save-btn" type="submit"><i class="fas fa-save"></i> è¨ºæ–­ãƒ¡ãƒ¢ã‚’ä¿å­˜</button>
        </form>
        <div class="memo-history">
          <h3><i class="fas fa-history"></i> ãƒ¡ãƒ¢å±¥æ­´ (${memos.length}ä»¶)</h3>
          ${memos.length === 0 ? '<p style="color:var(--text-color-muted,#4A4A4A);margin:12px 0;">ãƒ¡ãƒ¢ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>' : memos.map(memo => `
            <div class="memo-entry">
              <div class="memo-header">
                <div class="memo-date"><i class="fas fa-calendar-day"></i> ${memo.date}</div>
                <div class="memo-doctor" style="font-size:0.9em;color:#666;">
                  <i class="fas fa-user-md"></i> ${memo.doctorName || 'åŒ»å¸«'}
                </div>
              </div>
              <div class="memo-content">
                ${memo.condition ? `<div class="memo-item"><span class="memo-label"><i class="fas fa-stethoscope"></i> ç—…çŠ¶:</span><span>${memo.condition}</span></div>` : ''}
                ${memo.prescription ? `<div class="memo-item"><span class="memo-label"><i class="fas fa-pills"></i> å‡¦æ–¹ç®‹:</span><span>${memo.prescription}</span></div>` : ''}
                ${memo.other ? `<div class="memo-item"><span class="memo-label"><i class="fas fa-pen"></i> ãã®ä»–:</span><span>${memo.other}</span></div>` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      `;
      document.getElementById('memoForm').onsubmit = async function(e) {
        e.preventDefault();
        
        // ç¾åœ¨ã®æ—¥æ™‚ã‚’å–å¾—
        const now = new Date();
        const currentDate = now.toISOString().split('T')[0];
        
        const newMemo = {
          date: document.getElementById('memoDate').value || currentDate,
          condition: document.getElementById('memoCondition').value,
          prescription: document.getElementById('memoPrescription').value,
          other: document.getElementById('memoOther').value,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          doctorId: currentUserId,
          doctorName: firebase.auth().currentUser?.displayName || 'åŒ»å¸«'
        };
        
        if (!newMemo.condition && !newMemo.prescription && !newMemo.other) {
          alert('å°‘ãªãã¨ã‚‚ç—…çŠ¶ã€å‡¦æ–¹ç®‹ã€ãã®ä»–ã®ã„ãšã‚Œã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        
        try {
          // æ—¢å­˜ã®ãƒ¡ãƒ¢é…åˆ—ã‚’å–å¾—
          const patientDoc = await db.collection('users').doc(patient.id).get();
          const existingMemos = patientDoc.data().memos || [];
          
          // æ–°ã—ã„ãƒ¡ãƒ¢ã‚’é…åˆ—ã®å…ˆé ­ã«è¿½åŠ 
          existingMemos.unshift(newMemo);
          
          // Firebaseã«ä¿å­˜
          await db.collection('users').doc(patient.id).update({ 
            memos: existingMemos,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          alert('è¨ºæ–­ãƒ¡ãƒ¢ãŒæ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
          
          // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
          document.getElementById('memoCondition').value = '';
          document.getElementById('memoPrescription').value = '';
          document.getElementById('memoOther').value = '';
          document.getElementById('memoDate').value = currentDate;
          
          // æ‚£è€…æƒ…å ±ã‚’å†èª­ã¿è¾¼ã¿
          await selectPatient(patient.id);
          
        } catch (error) {
          console.error('ãƒ¡ãƒ¢ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
          alert('ãƒ¡ãƒ¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        }
      };
    }

    // ã‚¯ã‚¤ã‚ºçµæœã‚’å–å¾—ã™ã‚‹é–¢æ•°
    async function getQuizResults(patientEmail) {
      if (!patientEmail) {
        return {
          totalQuizzes: 0,
          averageAccuracy: 0,
          bestScore: 0,
          recentQuizzes: 0,
          recentQuizzesList: []
        };
      }
      
      try {
        // ai_quiz_scoresã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰æ‚£è€…ã®ã‚¯ã‚¤ã‚ºçµæœã‚’å–å¾—ï¼ˆorderByã‚’å‰Šé™¤ã—ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ï¼‰
        const quizSnapshot = await db.collection('ai_quiz_scores')
          .where('userEmail', '==', patientEmail)
          .get();
        
        if (quizSnapshot.empty) {
          return {
            totalQuizzes: 0,
            averageAccuracy: 0,
            bestScore: 0,
            recentQuizzes: 0,
            recentQuizzesList: []
          };
        }
        
        const quizzes = quizSnapshot.docs.map(doc => doc.data());
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨: æœ€åˆã®ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã®æ§‹é€ ã‚’ç¢ºèª
        if (quizzes.length > 0) {
          console.log('ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã®ä¾‹:', quizzes[0]);
        }
        
        // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—é †ã«ã‚½ãƒ¼ãƒˆï¼ˆcreatedAtãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½¿ç”¨ï¼‰
        quizzes.sort((a, b) => {
          const timestampA = a.createdAt && a.createdAt.seconds ? a.createdAt.seconds : 0;
          const timestampB = b.createdAt && b.createdAt.seconds ? b.createdAt.seconds : 0;
          return timestampB - timestampA; // é™é †ï¼ˆæ–°ã—ã„é †ï¼‰
        });
        
        const totalQuizzes = quizzes.length;
        
        // å¹³å‡æ­£ç­”ç‡ã‚’è¨ˆç®—ï¼ˆaccuracyã®å€¤ã®ç¯„å›²ã‚’ç¢ºèªã—ã¦é©åˆ‡ã«å‡¦ç†ï¼‰
        let totalAccuracy = 0;
        let maxAccuracy = 0;
        
        quizzes.forEach(quiz => {
          // Firebaseã®å®Ÿéš›ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’ä½¿ç”¨: score/totalã‹ã‚‰æ­£ç­”ç‡ã‚’è¨ˆç®—
          const score = quiz.score || 0;
          const total = quiz.total || 0;
          let accuracy = 0;
          
          if (total > 0) {
            accuracy = (score / total) * 100;
          }
          
          totalAccuracy += accuracy;
          maxAccuracy = Math.max(maxAccuracy, accuracy);
        });
        
        const averageAccuracy = Math.round(totalAccuracy / totalQuizzes);
        const bestScore = Math.round(maxAccuracy);
        
        // æœ€è¿‘7æ—¥é–“ã®ã‚¯ã‚¤ã‚ºæ•°
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        const recentQuizzes = quizzes.filter(quiz => {
          // createdAtãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½¿ç”¨
          const quizDate = quiz.createdAt && quiz.createdAt.seconds ? 
            new Date(quiz.createdAt.seconds * 1000) : new Date(0);
          return quizDate >= sevenDaysAgo;
        }).length;
        
        // æœ€è¿‘ã®ã‚¯ã‚¤ã‚ºçµæœï¼ˆæœ€å¤§5ä»¶ï¼‰
        const recentQuizzesList = quizzes.slice(0, 5);
        
        return {
          totalQuizzes,
          averageAccuracy,
          bestScore,
          recentQuizzes,
          recentQuizzesList
        };
        
      } catch (error) {
        console.error('ã‚¯ã‚¤ã‚ºçµæœå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        return {
          totalQuizzes: 0,
          averageAccuracy: 0,
          bestScore: 0,
          recentQuizzes: 0,
          recentQuizzesList: []
        };
      }
    }

    // æ¤œç´¢æ©Ÿèƒ½ï¼ˆPCç‰ˆã¨ã‚µã‚¤ãƒ‰ãƒãƒ¼ç‰ˆã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰
    function setupSearch(inputId, listSelector) {
      const searchInput = document.getElementById(inputId);
      if (!searchInput) return;
      
      searchInput.addEventListener('input', function(e) {
        const searchText = e.target.value.toLowerCase();
        const container = searchInput.closest('.patient-list-panel') || searchInput.closest('.patient-list-sidebar');
        const items = container ? container.querySelectorAll(listSelector) : document.querySelectorAll(listSelector);
        items.forEach(item => {
          const nameEl = item.querySelector('.doctor-name');
          if (nameEl) {
            const name = nameEl.textContent.toLowerCase();
            item.style.display = name.includes(searchText) ? 'flex' : 'none';
          }
        });
      });
    }

    // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®é–‹é–‰
    function openSidebar() {
      const sidebar = document.getElementById('patientListSidebar');
      const overlay = document.getElementById('sidebarOverlay');
      if (sidebar && overlay) {
        sidebar.classList.add('active');
        overlay.classList.add('active');
        // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«æ‚£è€…ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        const sidebarContent = document.getElementById('patientListSidebarContent');
        if (sidebarContent) {
          renderPatientList(sidebarContent);
        }
      }
    }

    function closeSidebar() {
      const sidebar = document.getElementById('patientListSidebar');
      const overlay = document.getElementById('sidebarOverlay');
      if (sidebar && overlay) {
        sidebar.classList.remove('active');
        overlay.classList.remove('active');
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    document.addEventListener('DOMContentLoaded', function() {
      // PCç‰ˆã®æ¤œç´¢
      setupSearch('patientSearch', '.chat-item');
      
      // ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã®æ¤œç´¢
      setupSearch('patientSearchMobile', '.chat-item');
      
      // ã‚µã‚¤ãƒ‰ãƒãƒ¼ç‰ˆã®æ¤œç´¢
      setupSearch('patientSearchSidebar', '.chat-item');
      
      // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³
      const hamburgerBtn = document.getElementById('hamburgerMenu');
      if (hamburgerBtn) {
        hamburgerBtn.addEventListener('click', openSidebar);
      }
      
      // ã‚µã‚¤ãƒ‰ãƒãƒ¼é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
      const closeSidebarBtn = document.getElementById('closeSidebarBtn');
      if (closeSidebarBtn) {
        closeSidebarBtn.addEventListener('click', closeSidebar);
      }
      
      // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      const overlay = document.getElementById('sidebarOverlay');
      if (overlay) {
        overlay.addEventListener('click', closeSidebar);
      }
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½ã‚’è¿½åŠ 
    let currentPatientForMemos = null;

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãé–¢æ•°
    function openMemoModal(patient) {
      console.log('openMemoModal called with patient:', patient);
      
      if (!patient || !patient.id) {
        alert('æ‚£è€…æƒ…å ±ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      currentPatientForMemos = patient;
      const modal = document.getElementById('memoModal');
      const memoDateInput = document.getElementById('memoDate');
      
      // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã—ã¦è¨­å®š
      const today = new Date().toISOString().split('T')[0];
      memoDateInput.value = today;
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('memoCondition').value = '';
      document.getElementById('memoPrescription').value = '';
      document.getElementById('memoOther').value = '';
      
      modal.style.display = 'block';
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚ŒãŸå¾Œã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’èª¿æ•´
      setTimeout(() => {
        const modalContent = modal.querySelector('.modal-content');
        if (modalContent) {
          modalContent.scrollTop = 0;
        }
      }, 100);
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹é–¢æ•°
    function closeMemoModal() {
      const modal = document.getElementById('memoModal');
      modal.style.display = 'none';
      currentPatientForMemos = null;
    }

    // è¨ºå¯Ÿè¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
    async function saveMemo() {
      console.log('saveMemo called, currentPatientForMemos:', currentPatientForMemos);
      
      if (!currentPatientForMemos || !currentPatientForMemos.id) {
        alert('æ‚£è€…æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ‚£è€…ã‚’é¸æŠã—ç›´ã—ã¦ãã ã•ã„ã€‚');
        closeMemoModal();
        return;
      }

      const condition = document.getElementById('memoCondition').value.trim();
      const prescription = document.getElementById('memoPrescription').value.trim();
      const other = document.getElementById('memoOther').value.trim();
      const date = document.getElementById('memoDate').value;

      if (!condition) {
        alert('ç—…çŠ¶ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        console.log('Saving memo for patient:', currentPatientForMemos.id);
        
        // æ—¢å­˜ã®è¨ºå¯Ÿè¨˜éŒ²ã‚’å–å¾—
        const patientDoc = await db.collection('users').doc(currentPatientForMemos.id).get();
        const existingMemos = patientDoc.data().memos || [];

        // æ–°ã—ã„è¨ºå¯Ÿè¨˜éŒ²ã‚’ä½œæˆ
        const newMemo = {
          date: date,
          condition: condition,
          prescription: prescription,
          other: other,
          createdAt: new Date().toISOString(),
          doctorId: currentUserId,
          doctorName: firebase.auth().currentUser?.displayName || 'åŒ»å¸«'
        };

        // æ–°ã—ã„è¨˜éŒ²ã‚’é…åˆ—ã«è¿½åŠ 
        existingMemos.unshift(newMemo);

        // Firebaseã«ä¿å­˜
        await db.collection('users').doc(currentPatientForMemos.id).update({
          memos: existingMemos,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert('è¨ºå¯Ÿè¨˜éŒ²ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ');
        closeMemoModal();

        // æ‚£è€…æƒ…å ±ã‚’å†èª­ã¿è¾¼ã¿
        await selectPatient(currentPatientForMemos.id);

      } catch (error) {
        console.error('è¨ºå¯Ÿè¨˜éŒ²ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('è¨ºå¯Ÿè¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('memoModal');
      const closeBtn = document.querySelector('.close');
      const closeModalBtn = document.getElementById('closeModalBtn');
      const saveMemoBtn = document.getElementById('saveMemoBtn');

      if (closeBtn) {
        closeBtn.onclick = closeMemoModal;
      }

      if (closeModalBtn) {
        closeModalBtn.onclick = closeMemoModal;
      }

      if (saveMemoBtn) {
        saveMemoBtn.onclick = saveMemo;
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
      window.onclick = function(event) {
        if (event.target === modal) {
          closeMemoModal();
        }
      }
    });
    </script>
</body>
</html>
