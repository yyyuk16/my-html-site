<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="æ‚£è€…è¨ºç™‚è¨˜éŒ²">æ‚£è€…è¨ºç™‚è¨˜éŒ²</title>
    <link rel="stylesheet" href="maintab.css">
    <link rel="stylesheet" href="footer.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- ç¿»è¨³æ©Ÿèƒ½ -->
    <script src="translation.js"></script>
    
    <style>
        /* æ‚£è€…æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .patient-info-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
        }
        
        .patient-header {
            background: linear-gradient(135deg, #2196f3, #21cbf3);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .patient-name {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .patient-details {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .info-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
            border: 1px solid #e3f2fd;
        }
        
        .section-title {
            color: #2196f3;
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .quiz-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #2196f3;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #2196f3;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        .quiz-history {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .quiz-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #4caf50;
        }
        
        .quiz-item.poor {
            border-left-color: #f44336;
        }
        
        .quiz-item.good {
            border-left-color: #ff9800;
        }
        
        .quiz-date {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .quiz-score {
            font-weight: 600;
            color: #2196f3;
        }
        
        .memo-history {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .memo-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #2196f3;
        }
        
        .memo-date {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .memo-content {
            font-size: 0.95em;
        }
        
        .no-data {
            text-align: center;
            color: #999;
            padding: 20px;
            font-style: italic;
        }
        
        /* æ‚£è€…ãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .flex-container {
            display: flex;
            gap: 20px;
            padding: 20px;
            min-height: 70vh;
        }
        
        .patient-list-panel {
            flex: 0 0 300px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
            border: 1px solid #e3f2fd;
        }
        
        .patient-list-panel h2 {
            color: #2196f3;
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 100%;
            height: 30px;
            padding: 3px 1px 3px 4px;
            border: 1px solid #cfd8dc;
            border-radius: 6px;
            font-size: 0.8em;
            outline: none;
            background: #f1f5f9;
            transition: border-color 0.2s, background-color .2s;
        }
        
        .search-box input:focus {
            border-color: #2196f3;
            background: #fff;
        }
        
        .search-box i {
            position: absolute;
            right: 2px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 0.75em;
        }
        
        .chat-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 1px solid transparent;
        }
        
        .chat-item:hover {
            background-color: #f8f9fa;
        }
        
        .chat-item.selected {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        
        .doctor-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2196f3, #21cbf3);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 12px;
            font-size: 0.9em;
        }
        
        .chat-info {
            flex: 1;
        }
        
        .doctor-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .last-message {
            font-size: 0.85em;
            color: #666;
        }
        
        .patient-info-container {
            flex: 1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
            border: 1px solid #e3f2fd;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 12px;
            border: none;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .modal-title {
            color: #2196f3;
            font-size: 1.3em;
            font-weight: 600;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .modal-body {
            margin-bottom: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            border-color: #2196f3;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            flex-shrink: 0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.3s;
            min-width: 100px;
        }

        .btn-primary {
            background-color: #2196f3;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1976d2;
        }

        .btn-secondary {
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
    </style>
</head>
<body>
    <!-- ğŸ’š ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="top-bar">
        <div class="header-inner">
            <div class="logo" style="font-size:2rem; font-weight:700; color:#2196f3; letter-spacing:0.08em; display:flex; align-items:center;">
                <span data-translate="site_title" style="vertical-align:middle;">åŒ»ç™‚ç®¡ç†ã‚¢ãƒ—ãƒª</span>
            </div>
            <nav>
                <ul class="tab-menu">
                    <li><a href="home.html">ğŸ¥ <span data-translate="HOME">HOME</span></a></li>
                    <li><a href="list.html" class="active">ğŸ‘¥ <span data-translate="æ‚£è€…è¨ºç™‚è¨˜éŒ²">æ‚£è€…è¨ºç™‚è¨˜éŒ²</span></a></li>
                    <li><a href="chat.html">ğŸ“… <span data-translate="ãƒãƒ£ãƒƒãƒˆ">ãƒãƒ£ãƒƒãƒˆ</span></a></li>
                    <li><a href="docterprofile.html">ğŸ‘¤ <span data-translate="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</span></a></li>
                </ul>
            </nav>
        </div>
    </header>
        
    <div class="flex-container">
        <div class="patient-list-panel">
            <h2><i class="fas fa-user-friends"></i> <span data-translate="æ‹…å½“æ‚£è€…ãƒªã‚¹ãƒˆ">æ‹…å½“æ‚£è€…ãƒªã‚¹ãƒˆ</span></h2>
            <div class="search-box">
                <input type="text" id="patientSearch" data-translate="æ‚£è€…ã‚’æ¤œç´¢..." placeholder="æ‚£è€…ã‚’æ¤œç´¢...">
                <i class="fas fa-search"></i>
            </div>
            <div class="chat-list" id="patientList"></div>
        </div>
        <div class="patient-info-container" id="patientInfoArea">
            <div class="no-data">
                <i class="fas fa-user" style="font-size: 3em; color: #ccc; margin-bottom: 15px;"></i>
                <p>æ‚£è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
            </div>
        </div>
    </div>
    
    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-links">
                    <a href="#" data-translate="terms">åˆ©ç”¨è¦ç´„</a>
                    <a href="#" data-translate="privacy">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
                </div>
                <div class="footer-copyright">
                    <small data-translate="copyright_name">Â© 2024 åŒ»ç™‚ç®¡ç†ã‚¢ãƒ—ãƒª. All rights reserved.</small>
                </div>
            </div>
        </div>
    </footer>

    <!-- è¨ºå¯Ÿè¨˜éŒ²è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="memoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-notes-medical"></i> è¨ºå¯Ÿè¨˜éŒ²ã‚’è¿½åŠ 
                </h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="memoForm">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-calendar-alt"></i> è¨ºå¯Ÿæ—¥
                        </label>
                        <input type="date" id="memoDate" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-stethoscope"></i> ç—…çŠ¶
                        </label>
                        <textarea id="memoCondition" class="form-input form-textarea" placeholder="æ‚£è€…ã®ç—‡çŠ¶ã‚„ç—…çŠ¶ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-pills"></i> å‡¦æ–¹ç®‹
                        </label>
                        <textarea id="memoPrescription" class="form-input form-textarea" placeholder="å‡¦æ–¹ã—ãŸè–¬ã‚„æ²»ç™‚å†…å®¹ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-pen"></i> ãã®ä»–ã®ãƒ¡ãƒ¢
                        </label>
                        <textarea id="memoOther" class="form-input form-textarea" placeholder="ãã®ä»–ã®æ³¨æ„äº‹é …ã‚„ãƒ¡ãƒ¢ãŒã‚ã‚Œã°è¨˜éŒ²ã—ã¦ãã ã•ã„"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="closeModalBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-primary" id="saveMemoBtn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
    const firebaseConfig = {
  apiKey: "AIzaSyB7TuGhOKbB4w7DDYt7KTejy-TrcxVZmpU",
  authDomain: "web01-2484d.firebaseapp.com",
  databaseURL: "https://web01-2484d-default-rtdb.firebaseio.com",
  projectId: "web01-2484d",
  storageBucket: "web01-2484d.firebasestorage.app",
  messagingSenderId: "90159472898",
  appId: "1:90159472898:web:261ec71f9919611011e21b",
  measurementId: "G-9TGR07ZSY9"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let currentUserId = null;
    let patients = [];
    let selectedPatientId = null;

    // æ‹…å½“æ‚£è€…ãƒªã‚¹ãƒˆå–å¾—
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
        window.location.href = 'login.html';
        return;
      }
      currentUserId = user.uid;
      // usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰æ‹…å½“æ‚£è€…ã‚’å–å¾—
      const patientsSnapshot = await db.collection('users')
        .where('role', '==', 'patient')
        .where('assignedDoctor', '==', currentUserId)
        .get();
      patients = patientsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderPatientList();
    });

    function renderPatientList() {
      const listDiv = document.getElementById('patientList');
      listDiv.innerHTML = '';
      if (patients.length === 0) {
        listDiv.innerHTML = '<p style="color:var(--text-color-muted,#4A4A4A);text-align:center;margin:32px 0;">æ‹…å½“æ‚£è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
        document.getElementById('memoArea').innerHTML = '';
        return;
      }
      patients.forEach(patient => {
        const item = document.createElement('div');
        item.className = 'chat-item' + (selectedPatientId === patient.id ? ' selected' : '');
        item.innerHTML = `
          <div class="doctor-avatar">${patient.name ? patient.name.charAt(0) : '?'}</div>
          <div class="chat-info">
            <div class="doctor-name">${patient.name || 'åç„¡ã—ã®æ‚£è€…'}</div>
            <div class="last-message">${patient.age ? patient.age + 'æ­³' : ''}</div>
          </div>
        `;
        item.onclick = () => {
          selectPatient(patient.id);
        };
        listDiv.appendChild(item);
      });
      // æœ€åˆã®æ‚£è€…ã‚’è‡ªå‹•é¸æŠ
      if (!selectedPatientId && patients.length > 0) {
        setTimeout(() => {
          selectPatient(patients[0].id);
        }, 100);
      }
    }

    async function selectPatient(patientId) {
      console.log('æ‚£è€…ã‚’é¸æŠ:', patientId);
      selectedPatientId = patientId;
      const patient = patients.find(p => p.id === patientId);
      if (!patient) {
        console.log('æ‚£è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', patientId);
        return;
      }
      console.log('é¸æŠã•ã‚ŒãŸæ‚£è€…:', patient);
      
      // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
      document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('selected'));
      // æ‚£è€…ãƒªã‚¹ãƒˆå†…ã®è©²å½“ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
      const patientItems = document.querySelectorAll('.chat-item');
      patientItems.forEach(item => {
        if (item.onclick && item.onclick.toString().includes(patientId)) {
          item.classList.add('selected');
        }
      });
      
      // æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—
      const doc = await db.collection('users').doc(patientId).get();
      const data = doc.data();
      const memos = data.memos || [];
      
      // æ‚£è€…æƒ…å ±ã‚’è¡¨ç¤º
      await renderPatientInfo(patient, data, memos);
    }

    async function renderPatientInfo(patient, data, memos) {
      const area = document.getElementById('patientInfoArea');
      console.log('æ‚£è€…æƒ…å ±ã‚’è¡¨ç¤ºä¸­:', patient);
      
      // ã‚¯ã‚¤ã‚ºçµæœã‚’å–å¾—
      const quizResults = await getQuizResults(patient.email);
      console.log('ã‚¯ã‚¤ã‚ºçµæœ:', quizResults);
      
      area.innerHTML = `
        <div class="patient-header">
          <div class="patient-name">${patient.name || 'åç„¡ã—ã®æ‚£è€…'}</div>
          <div class="patient-details">
            <span><i class="fas fa-birthday-cake"></i> ${patient.age || 'æœªç™»éŒ²'}æ­³</span>
            <span><i class="fas fa-envelope"></i> ${patient.email || 'æœªç™»éŒ²'}</span>
            <span><i class="fas fa-calendar"></i> ç™»éŒ²æ—¥: ${patient.createdAt ? new Date(patient.createdAt.seconds * 1000).toLocaleDateString('ja-JP') : 'ä¸æ˜'}</span>
          </div>
        </div>
        
        <div class="info-section">
          <div class="section-title">
            <i class="fas fa-chart-line"></i> ã‚¯ã‚¤ã‚ºçµ±è¨ˆ
          </div>
          <div class="quiz-stats">
            <div class="stat-card">
              <div class="stat-value">${quizResults.totalQuizzes || 0}</div>
              <div class="stat-label">ç·ã‚¯ã‚¤ã‚ºå›æ•°</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${quizResults.averageAccuracy || 0}%</div>
              <div class="stat-label">å¹³å‡æ­£ç­”ç‡</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${quizResults.bestScore || 0}%</div>
              <div class="stat-label">æœ€é«˜ã‚¹ã‚³ã‚¢</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${quizResults.recentQuizzes || 0}</div>
              <div class="stat-label">æœ€è¿‘7æ—¥é–“</div>
            </div>
          </div>
        </div>
        
        <div class="info-section">
          <div class="section-title">
            <i class="fas fa-history"></i> æœ€è¿‘ã®ã‚¯ã‚¤ã‚ºçµæœ
          </div>
          <div class="quiz-history">
            ${quizResults.recentQuizzesList.length > 0 ? 
              quizResults.recentQuizzesList.map(quiz => {
                // Firebaseã®å®Ÿéš›ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’ä½¿ç”¨
                const score = quiz.score || 0;
                const total = quiz.total || 0;
                const accuracyPercent = total > 0 ? Math.round((score / total) * 100) : 0;
                
                // æ­£ç­”ç‡ã«åŸºã¥ãè‰²åˆ†ã‘ï¼ˆãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸åŸºæº–ï¼‰
                const itemClass = accuracyPercent >= 80 ? 'excellent' : accuracyPercent >= 60 ? 'good' : 'poor';
                
                return `
                  <div class="quiz-item ${itemClass}">
                    <div class="quiz-date">${new Date((quiz.createdAt && quiz.createdAt.seconds) ? quiz.createdAt.seconds * 1000 : Date.now()).toLocaleDateString('ja-JP')}</div>
                    <div class="quiz-score">æ­£ç­”ç‡: ${accuracyPercent}% (${score}/${total}å•)</div>
                  </div>
                `;
              }).join('') : 
              '<div class="no-data">ã‚¯ã‚¤ã‚ºçµæœãŒã‚ã‚Šã¾ã›ã‚“</div>'
            }
          </div>
        </div>
        
        <div class="info-section">
          <div class="section-title">
            <i class="fas fa-notes-medical"></i> è¨ºå¯Ÿè¨˜éŒ² (${memos.length}ä»¶)
            <button id="addMemoBtn" class="add-memo-btn" style="margin-left: auto; background: #2196f3; color: white; border: none; border-radius: 8px; padding: 8px 16px; cursor: pointer; font-size: 0.9em;">
              <i class="fas fa-plus"></i> è¨˜éŒ²ã‚’è¿½åŠ 
            </button>
          </div>
          <div class="memo-history">
            ${memos.length > 0 ? 
              memos.slice(0, 5).map(memo => `
                <div class="memo-item">
                  <div class="memo-date">${memo.date} - ${memo.doctorName || 'åŒ»å¸«'}</div>
                  <div class="memo-content">
                    ${memo.condition ? `<strong>ç—…çŠ¶:</strong> ${memo.condition}<br>` : ''}
                    ${memo.prescription ? `<strong>å‡¦æ–¹:</strong> ${memo.prescription}<br>` : ''}
                    ${memo.other ? `<strong>ãã®ä»–:</strong> ${memo.other}` : ''}
                  </div>
                </div>
              `).join('') : 
              '<div class="no-data">è¨ºå¯Ÿè¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>'
            }
          </div>
        </div>
      `;
      
      // è¨ºå¯Ÿè¨˜éŒ²è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      const addMemoBtn = document.getElementById('addMemoBtn');
      if (addMemoBtn) {
        addMemoBtn.onclick = function() {
          openMemoModal(patient);
        };
      }
    }

    function renderMemoArea(patient, memos) {
      const area = document.getElementById('memoArea');
      const currentDate = new Date().toISOString().split('T')[0];
      
      area.innerHTML = `
        <h2><i class="fas fa-notes-medical"></i> ${patient.name} ã•ã‚“ã®è¨ºç™‚ãƒ¡ãƒ¢</h2>
        <form id="memoForm">
          <div class="memo-field">
            <label><i class="fas fa-calendar-alt"></i> è¨ºå¯Ÿæ—¥</label>
            <input type="date" class="memo-input" id="memoDate" value="${currentDate}">
          </div>
          <div class="memo-field">
            <label><i class="fas fa-stethoscope"></i> ç—…çŠ¶ <span style="color:#666;font-size:0.9em;">(å¿…é ˆ)</span></label>
            <textarea class="memo-input" id="memoCondition" rows="3" placeholder="æ‚£è€…ã®ç—‡çŠ¶ã‚„ç—…çŠ¶ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„"></textarea>
          </div>
          <div class="memo-field">
            <label><i class="fas fa-pills"></i> å‡¦æ–¹ç®‹</label>
            <textarea class="memo-input" id="memoPrescription" rows="3" placeholder="å‡¦æ–¹ã—ãŸè–¬ã‚„æ²»ç™‚å†…å®¹ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„"></textarea>
          </div>
          <div class="memo-field">
            <label><i class="fas fa-pen"></i> ãã®ä»–ã®ãƒ¡ãƒ¢</label>
            <textarea class="memo-input" id="memoOther" rows="2" placeholder="ãã®ä»–ã®æ³¨æ„äº‹é …ã‚„ãƒ¡ãƒ¢ãŒã‚ã‚Œã°è¨˜éŒ²ã—ã¦ãã ã•ã„"></textarea>
          </div>
          <button class="save-btn" type="submit"><i class="fas fa-save"></i> è¨ºæ–­ãƒ¡ãƒ¢ã‚’ä¿å­˜</button>
        </form>
        <div class="memo-history">
          <h3><i class="fas fa-history"></i> ãƒ¡ãƒ¢å±¥æ­´ (${memos.length}ä»¶)</h3>
          ${memos.length === 0 ? '<p style="color:var(--text-color-muted,#4A4A4A);margin:12px 0;">ãƒ¡ãƒ¢ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>' : memos.map(memo => `
            <div class="memo-entry">
              <div class="memo-header">
                <div class="memo-date"><i class="fas fa-calendar-day"></i> ${memo.date}</div>
                <div class="memo-doctor" style="font-size:0.9em;color:#666;">
                  <i class="fas fa-user-md"></i> ${memo.doctorName || 'åŒ»å¸«'}
                </div>
              </div>
              <div class="memo-content">
                ${memo.condition ? `<div class="memo-item"><span class="memo-label"><i class="fas fa-stethoscope"></i> ç—…çŠ¶:</span><span>${memo.condition}</span></div>` : ''}
                ${memo.prescription ? `<div class="memo-item"><span class="memo-label"><i class="fas fa-pills"></i> å‡¦æ–¹ç®‹:</span><span>${memo.prescription}</span></div>` : ''}
                ${memo.other ? `<div class="memo-item"><span class="memo-label"><i class="fas fa-pen"></i> ãã®ä»–:</span><span>${memo.other}</span></div>` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      `;
      document.getElementById('memoForm').onsubmit = async function(e) {
        e.preventDefault();
        
        // ç¾åœ¨ã®æ—¥æ™‚ã‚’å–å¾—
        const now = new Date();
        const currentDate = now.toISOString().split('T')[0];
        
        const newMemo = {
          date: document.getElementById('memoDate').value || currentDate,
          condition: document.getElementById('memoCondition').value,
          prescription: document.getElementById('memoPrescription').value,
          other: document.getElementById('memoOther').value,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          doctorId: currentUserId,
          doctorName: firebase.auth().currentUser?.displayName || 'åŒ»å¸«'
        };
        
        if (!newMemo.condition && !newMemo.prescription && !newMemo.other) {
          alert('å°‘ãªãã¨ã‚‚ç—…çŠ¶ã€å‡¦æ–¹ç®‹ã€ãã®ä»–ã®ã„ãšã‚Œã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        
        try {
          // æ—¢å­˜ã®ãƒ¡ãƒ¢é…åˆ—ã‚’å–å¾—
          const patientDoc = await db.collection('users').doc(patient.id).get();
          const existingMemos = patientDoc.data().memos || [];
          
          // æ–°ã—ã„ãƒ¡ãƒ¢ã‚’é…åˆ—ã®å…ˆé ­ã«è¿½åŠ 
          existingMemos.unshift(newMemo);
          
          // Firebaseã«ä¿å­˜
          await db.collection('users').doc(patient.id).update({ 
            memos: existingMemos,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          alert('è¨ºæ–­ãƒ¡ãƒ¢ãŒæ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
          
          // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
          document.getElementById('memoCondition').value = '';
          document.getElementById('memoPrescription').value = '';
          document.getElementById('memoOther').value = '';
          document.getElementById('memoDate').value = currentDate;
          
          // æ‚£è€…æƒ…å ±ã‚’å†èª­ã¿è¾¼ã¿
          await selectPatient(patient.id);
          
        } catch (error) {
          console.error('ãƒ¡ãƒ¢ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
          alert('ãƒ¡ãƒ¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        }
      };
    }

    // ã‚¯ã‚¤ã‚ºçµæœã‚’å–å¾—ã™ã‚‹é–¢æ•°
    async function getQuizResults(patientEmail) {
      if (!patientEmail) {
        return {
          totalQuizzes: 0,
          averageAccuracy: 0,
          bestScore: 0,
          recentQuizzes: 0,
          recentQuizzesList: []
        };
      }
      
      try {
        // ai_quiz_scoresã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰æ‚£è€…ã®ã‚¯ã‚¤ã‚ºçµæœã‚’å–å¾—ï¼ˆorderByã‚’å‰Šé™¤ã—ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ï¼‰
        const quizSnapshot = await db.collection('ai_quiz_scores')
          .where('userEmail', '==', patientEmail)
          .get();
        
        if (quizSnapshot.empty) {
          return {
            totalQuizzes: 0,
            averageAccuracy: 0,
            bestScore: 0,
            recentQuizzes: 0,
            recentQuizzesList: []
          };
        }
        
        const quizzes = quizSnapshot.docs.map(doc => doc.data());
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨: æœ€åˆã®ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã®æ§‹é€ ã‚’ç¢ºèª
        if (quizzes.length > 0) {
          console.log('ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã®ä¾‹:', quizzes[0]);
        }
        
        // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—é †ã«ã‚½ãƒ¼ãƒˆï¼ˆcreatedAtãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½¿ç”¨ï¼‰
        quizzes.sort((a, b) => {
          const timestampA = a.createdAt && a.createdAt.seconds ? a.createdAt.seconds : 0;
          const timestampB = b.createdAt && b.createdAt.seconds ? b.createdAt.seconds : 0;
          return timestampB - timestampA; // é™é †ï¼ˆæ–°ã—ã„é †ï¼‰
        });
        
        const totalQuizzes = quizzes.length;
        
        // å¹³å‡æ­£ç­”ç‡ã‚’è¨ˆç®—ï¼ˆaccuracyã®å€¤ã®ç¯„å›²ã‚’ç¢ºèªã—ã¦é©åˆ‡ã«å‡¦ç†ï¼‰
        let totalAccuracy = 0;
        let maxAccuracy = 0;
        
        quizzes.forEach(quiz => {
          // Firebaseã®å®Ÿéš›ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’ä½¿ç”¨: score/totalã‹ã‚‰æ­£ç­”ç‡ã‚’è¨ˆç®—
          const score = quiz.score || 0;
          const total = quiz.total || 0;
          let accuracy = 0;
          
          if (total > 0) {
            accuracy = (score / total) * 100;
          }
          
          totalAccuracy += accuracy;
          maxAccuracy = Math.max(maxAccuracy, accuracy);
        });
        
        const averageAccuracy = Math.round(totalAccuracy / totalQuizzes);
        const bestScore = Math.round(maxAccuracy);
        
        // æœ€è¿‘7æ—¥é–“ã®ã‚¯ã‚¤ã‚ºæ•°
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        const recentQuizzes = quizzes.filter(quiz => {
          // createdAtãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½¿ç”¨
          const quizDate = quiz.createdAt && quiz.createdAt.seconds ? 
            new Date(quiz.createdAt.seconds * 1000) : new Date(0);
          return quizDate >= sevenDaysAgo;
        }).length;
        
        // æœ€è¿‘ã®ã‚¯ã‚¤ã‚ºçµæœï¼ˆæœ€å¤§5ä»¶ï¼‰
        const recentQuizzesList = quizzes.slice(0, 5);
        
        return {
          totalQuizzes,
          averageAccuracy,
          bestScore,
          recentQuizzes,
          recentQuizzesList
        };
        
      } catch (error) {
        console.error('ã‚¯ã‚¤ã‚ºçµæœå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        return {
          totalQuizzes: 0,
          averageAccuracy: 0,
          bestScore: 0,
          recentQuizzes: 0,
          recentQuizzesList: []
        };
      }
    }

    document.getElementById('patientSearch').addEventListener('input', function(e) {
        const searchText = e.target.value.toLowerCase();
        const items = document.querySelectorAll('.chat-item');
        items.forEach(item => {
            const name = item.querySelector('.doctor-name').textContent.toLowerCase();
            item.style.display = name.includes(searchText) ? 'flex' : 'none';
        });
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½ã‚’è¿½åŠ 
    let currentPatientForMemos = null;

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãé–¢æ•°
    function openMemoModal(patient) {
      console.log('openMemoModal called with patient:', patient);
      
      if (!patient || !patient.id) {
        alert('æ‚£è€…æƒ…å ±ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      currentPatientForMemos = patient;
      const modal = document.getElementById('memoModal');
      const memoDateInput = document.getElementById('memoDate');
      
      // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã—ã¦è¨­å®š
      const today = new Date().toISOString().split('T')[0];
      memoDateInput.value = today;
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('memoCondition').value = '';
      document.getElementById('memoPrescription').value = '';
      document.getElementById('memoOther').value = '';
      
      modal.style.display = 'block';
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚ŒãŸå¾Œã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’èª¿æ•´
      setTimeout(() => {
        const modalContent = modal.querySelector('.modal-content');
        if (modalContent) {
          modalContent.scrollTop = 0;
        }
      }, 100);
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹é–¢æ•°
    function closeMemoModal() {
      const modal = document.getElementById('memoModal');
      modal.style.display = 'none';
      currentPatientForMemos = null;
    }

    // è¨ºå¯Ÿè¨˜éŒ²ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
    async function saveMemo() {
      console.log('saveMemo called, currentPatientForMemos:', currentPatientForMemos);
      
      if (!currentPatientForMemos || !currentPatientForMemos.id) {
        alert('æ‚£è€…æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ‚£è€…ã‚’é¸æŠã—ç›´ã—ã¦ãã ã•ã„ã€‚');
        closeMemoModal();
        return;
      }

      const condition = document.getElementById('memoCondition').value.trim();
      const prescription = document.getElementById('memoPrescription').value.trim();
      const other = document.getElementById('memoOther').value.trim();
      const date = document.getElementById('memoDate').value;

      if (!condition) {
        alert('ç—…çŠ¶ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        console.log('Saving memo for patient:', currentPatientForMemos.id);
        
        // æ—¢å­˜ã®è¨ºå¯Ÿè¨˜éŒ²ã‚’å–å¾—
        const patientDoc = await db.collection('users').doc(currentPatientForMemos.id).get();
        const existingMemos = patientDoc.data().memos || [];

        // æ–°ã—ã„è¨ºå¯Ÿè¨˜éŒ²ã‚’ä½œæˆ
        const newMemo = {
          date: date,
          condition: condition,
          prescription: prescription,
          other: other,
          createdAt: new Date().toISOString(),
          doctorId: currentUserId,
          doctorName: firebase.auth().currentUser?.displayName || 'åŒ»å¸«'
        };

        // æ–°ã—ã„è¨˜éŒ²ã‚’é…åˆ—ã«è¿½åŠ 
        existingMemos.unshift(newMemo);

        // Firebaseã«ä¿å­˜
        await db.collection('users').doc(currentPatientForMemos.id).update({
          memos: existingMemos,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert('è¨ºå¯Ÿè¨˜éŒ²ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ');
        closeMemoModal();

        // æ‚£è€…æƒ…å ±ã‚’å†èª­ã¿è¾¼ã¿
        await selectPatient(currentPatientForMemos.id);

      } catch (error) {
        console.error('è¨ºå¯Ÿè¨˜éŒ²ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('è¨ºå¯Ÿè¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('memoModal');
      const closeBtn = document.querySelector('.close');
      const closeModalBtn = document.getElementById('closeModalBtn');
      const saveMemoBtn = document.getElementById('saveMemoBtn');

      if (closeBtn) {
        closeBtn.onclick = closeMemoModal;
      }

      if (closeModalBtn) {
        closeModalBtn.onclick = closeMemoModal;
      }

      if (saveMemoBtn) {
        saveMemoBtn.onclick = saveMemo;
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
      window.onclick = function(event) {
        if (event.target === modal) {
          closeMemoModal();
        }
      }
    });
    </script>
</body>
</html>
