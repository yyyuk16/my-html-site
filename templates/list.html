<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="ÊÇ£ËÄÖË®∫ÁôÇË®òÈå≤">ÊÇ£ËÄÖË®∫ÁôÇË®òÈå≤</title>
    <link rel="stylesheet" href="maintab.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- ÁøªË®≥Ê©üËÉΩ -->
    <script src="translation.js"></script>
    
    <style>
        /* ÊÇ£ËÄÖÊÉÖÂ†±Ë°®Á§∫„Ç®„É™„Ç¢„ÅÆ„Çπ„Çø„Ç§„É´ */
        .patient-info-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
        }
        
        .patient-header {
            background: linear-gradient(135deg, #2196f3, #21cbf3);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .patient-name {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .patient-details {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .info-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
            border: 1px solid #e3f2fd;
        }
        
        .section-title {
            color: #2196f3;
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .quiz-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #2196f3;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #2196f3;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        .quiz-history {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .quiz-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #4caf50;
        }
        
        .quiz-item.poor {
            border-left-color: #f44336;
        }
        
        .quiz-item.good {
            border-left-color: #ff9800;
        }
        
        .quiz-date {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .quiz-score {
            font-weight: 600;
            color: #2196f3;
        }
        
        .memo-history {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .memo-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #2196f3;
        }
        
        .memo-date {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .memo-content {
            font-size: 0.95em;
        }
        
        .no-data {
            text-align: center;
            color: #999;
            padding: 20px;
            font-style: italic;
        }
        
        /* ÊÇ£ËÄÖ„É™„Çπ„Éà„ÅÆ„Çπ„Çø„Ç§„É´ */
        .flex-container {
            display: flex;
            gap: 20px;
            padding: 20px;
            min-height: 70vh;
        }
        
        .patient-list-panel {
            flex: 0 0 300px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
            border: 1px solid #e3f2fd;
        }
        
        .patient-list-panel h2 {
            color: #2196f3;
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: 1px solid #e3f2fd;
            border-radius: 8px;
            font-size: 0.95em;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .search-box input:focus {
            border-color: #2196f3;
        }
        
        .search-box i {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .chat-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 1px solid transparent;
        }
        
        .chat-item:hover {
            background-color: #f8f9fa;
        }
        
        .chat-item.selected {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        
        .doctor-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2196f3, #21cbf3);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 12px;
            font-size: 0.9em;
        }
        
        .chat-info {
            flex: 1;
        }
        
        .doctor-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .last-message {
            font-size: 0.85em;
            color: #666;
        }
        
        .patient-info-container {
            flex: 1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
            border: 1px solid #e3f2fd;
        }

        /* „É¢„Éº„ÉÄ„É´„Çπ„Çø„Ç§„É´ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            border: none;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .modal-title {
            color: #2196f3;
            font-size: 1.3em;
            font-weight: 600;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            border-color: #2196f3;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #2196f3;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1976d2;
        }

        .btn-secondary {
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
    </style>
</head>
<body>
    <!-- üíö „Éò„ÉÉ„ÉÄ„Éº -->
    <header class="top-bar">
        <div class="header-inner">
            <div class="logo" style="font-size:2rem; font-weight:700; color:#2196f3; letter-spacing:0.08em; display:flex; align-items:center;">
                <span data-translate="site_title" style="vertical-align:middle;">ÂåªÁôÇÁÆ°ÁêÜ„Ç¢„Éó„É™</span>
            </div>
            <nav>
                <ul class="tab-menu">
                    <li><a href="home.html">üè• <span data-translate="HOME">HOME</span></a></li>
                    <li><a href="list.html" class="active">üë• <span data-translate="ÊÇ£ËÄÖË®∫ÁôÇË®òÈå≤">ÊÇ£ËÄÖË®∫ÁôÇË®òÈå≤</span></a></li>
                    <li><a href="chat.html">üìÖ <span data-translate="„ÉÅ„É£„ÉÉ„Éà">„ÉÅ„É£„ÉÉ„Éà</span></a></li>
                    <li><a href="docterprofile.html">üë§ <span data-translate="„Éó„É≠„Éï„Ç£„Éº„É´">„Éó„É≠„Éï„Ç£„Éº„É´</span></a></li>
                </ul>
            </nav>
        </div>
    </header>
        
    <div class="flex-container">
        <div class="patient-list-panel">
            <h2><i class="fas fa-user-friends"></i> <span data-translate="ÊãÖÂΩìÊÇ£ËÄÖ„É™„Çπ„Éà">ÊãÖÂΩìÊÇ£ËÄÖ„É™„Çπ„Éà</span></h2>
            <div class="search-box">
                <input type="text" id="patientSearch" data-translate="ÊÇ£ËÄÖ„ÇíÊ§úÁ¥¢..." placeholder="ÊÇ£ËÄÖ„ÇíÊ§úÁ¥¢...">
                <i class="fas fa-search"></i>
            </div>
            <div class="chat-list" id="patientList"></div>
        </div>
        <div class="patient-info-container" id="patientInfoArea">
            <div class="no-data">
                <i class="fas fa-user" style="font-size: 3em; color: #ccc; margin-bottom: 15px;"></i>
                <p>ÊÇ£ËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            </div>
        </div>
    </div>
    
    <!-- „Éï„ÉÉ„Çø„Éº -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-links">
                    <a href="#" data-translate="terms">Âà©Áî®Ë¶èÁ¥Ñ</a>
                    <a href="#" data-translate="privacy">„Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº</a>
                </div>
                <div class="footer-copyright">
                    <small data-translate="copyright_name">¬© 2024 ÂåªÁôÇÁÆ°ÁêÜ„Ç¢„Éó„É™. All rights reserved.</small>
                </div>
            </div>
        </div>
    </footer>

    <!-- Ë®∫ÂØüË®òÈå≤ËøΩÂä†„É¢„Éº„ÉÄ„É´ -->
    <div id="memoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-notes-medical"></i> Ë®∫ÂØüË®òÈå≤„ÇíËøΩÂä†
                </h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="memoForm">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-calendar-alt"></i> Ë®∫ÂØüÊó•
                        </label>
                        <input type="date" id="memoDate" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-stethoscope"></i> ÁóÖÁä∂
                        </label>
                        <textarea id="memoCondition" class="form-input form-textarea" placeholder="ÊÇ£ËÄÖ„ÅÆÁóáÁä∂„ÇÑÁóÖÁä∂„ÇíË®òÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-pills"></i> Âá¶ÊñπÁÆã
                        </label>
                        <textarea id="memoPrescription" class="form-input form-textarea" placeholder="Âá¶Êñπ„Åó„ÅüËñ¨„ÇÑÊ≤ªÁôÇÂÜÖÂÆπ„ÇíË®òÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-pen"></i> „Åù„ÅÆ‰ªñ„ÅÆ„É°„É¢
                        </label>
                        <textarea id="memoOther" class="form-input form-textarea" placeholder="„Åù„ÅÆ‰ªñ„ÅÆÊ≥®ÊÑè‰∫ãÈ†Ö„ÇÑ„É°„É¢„Åå„ÅÇ„Çå„Å∞Ë®òÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="closeModalBtn">„Ç≠„É£„É≥„Çª„É´</button>
                <button type="button" class="btn btn-primary" id="saveMemoBtn">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <script>
    const firebaseConfig = {
  apiKey: "AIzaSyB7TuGhOKbB4w7DDYt7KTejy-TrcxVZmpU",
  authDomain: "web01-2484d.firebaseapp.com",
  databaseURL: "https://web01-2484d-default-rtdb.firebaseio.com",
  projectId: "web01-2484d",
  storageBucket: "web01-2484d.firebasestorage.app",
  messagingSenderId: "90159472898",
  appId: "1:90159472898:web:261ec71f9919611011e21b",
  measurementId: "G-9TGR07ZSY9"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let currentUserId = null;
    let patients = [];
    let selectedPatientId = null;

    // ÊãÖÂΩìÊÇ£ËÄÖ„É™„Çπ„ÉàÂèñÂæó
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        alert('„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        window.location.href = 'login.html';
        return;
      }
      currentUserId = user.uid;
      // users„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Åã„ÇâÊãÖÂΩìÊÇ£ËÄÖ„ÇíÂèñÂæó
      const patientsSnapshot = await db.collection('users')
        .where('role', '==', 'patient')
        .where('assignedDoctor', '==', currentUserId)
        .get();
      patients = patientsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderPatientList();
    });

    function renderPatientList() {
      const listDiv = document.getElementById('patientList');
      listDiv.innerHTML = '';
      if (patients.length === 0) {
        listDiv.innerHTML = '<p style="color:var(--text-color-muted,#4A4A4A);text-align:center;margin:32px 0;">ÊãÖÂΩìÊÇ£ËÄÖ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
        document.getElementById('memoArea').innerHTML = '';
        return;
      }
      patients.forEach(patient => {
        const item = document.createElement('div');
        item.className = 'chat-item' + (selectedPatientId === patient.id ? ' selected' : '');
        item.innerHTML = `
          <div class="doctor-avatar">${patient.name ? patient.name.charAt(0) : '?'}</div>
          <div class="chat-info">
            <div class="doctor-name">${patient.name || 'ÂêçÁÑ°„Åó„ÅÆÊÇ£ËÄÖ'}</div>
            <div class="last-message">${patient.age ? patient.age + 'Ê≠≥' : ''}</div>
          </div>
        `;
        item.onclick = () => {
          selectPatient(patient.id);
        };
        listDiv.appendChild(item);
      });
      // ÊúÄÂàù„ÅÆÊÇ£ËÄÖ„ÇíËá™ÂãïÈÅ∏Êäû
      if (!selectedPatientId && patients.length > 0) {
        setTimeout(() => {
          selectPatient(patients[0].id);
        }, 100);
      }
    }

    async function selectPatient(patientId) {
      console.log('ÊÇ£ËÄÖ„ÇíÈÅ∏Êäû:', patientId);
      selectedPatientId = patientId;
      const patient = patients.find(p => p.id === patientId);
      if (!patient) {
        console.log('ÊÇ£ËÄÖ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', patientId);
        return;
      }
      console.log('ÈÅ∏Êäû„Åï„Çå„ÅüÊÇ£ËÄÖ:', patient);
      
      // ÈÅ∏ÊäûÁä∂ÊÖã„ÇíÊõ¥Êñ∞
      document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('selected'));
      // ÊÇ£ËÄÖ„É™„Çπ„ÉàÂÜÖ„ÅÆË©≤ÂΩì„Åô„Çã„Ç¢„Ç§„ÉÜ„É†„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
      const patientItems = document.querySelectorAll('.chat-item');
      patientItems.forEach(item => {
        if (item.onclick && item.onclick.toString().includes(patientId)) {
          item.classList.add('selected');
        }
      });
      
      // ÊúÄÊñ∞„Éá„Éº„ÇøÂèñÂæó
      const doc = await db.collection('users').doc(patientId).get();
      const data = doc.data();
      const memos = data.memos || [];
      
      // ÊÇ£ËÄÖÊÉÖÂ†±„ÇíË°®Á§∫
      await renderPatientInfo(patient, data, memos);
    }

    async function renderPatientInfo(patient, data, memos) {
      const area = document.getElementById('patientInfoArea');
      console.log('ÊÇ£ËÄÖÊÉÖÂ†±„ÇíË°®Á§∫‰∏≠:', patient);
      
      // „ÇØ„Ç§„Ç∫ÁµêÊûú„ÇíÂèñÂæó
      const quizResults = await getQuizResults(patient.email);
      console.log('„ÇØ„Ç§„Ç∫ÁµêÊûú:', quizResults);
      
      area.innerHTML = `
        <div class="patient-header">
          <div class="patient-name">${patient.name || 'ÂêçÁÑ°„Åó„ÅÆÊÇ£ËÄÖ'}</div>
          <div class="patient-details">
            <span><i class="fas fa-birthday-cake"></i> ${patient.age || 'Êú™ÁôªÈå≤'}Ê≠≥</span>
            <span><i class="fas fa-envelope"></i> ${patient.email || 'Êú™ÁôªÈå≤'}</span>
            <span><i class="fas fa-calendar"></i> ÁôªÈå≤Êó•: ${patient.createdAt ? new Date(patient.createdAt.seconds * 1000).toLocaleDateString('ja-JP') : '‰∏çÊòé'}</span>
          </div>
        </div>
        
        <div class="info-section">
          <div class="section-title">
            <i class="fas fa-chart-line"></i> „ÇØ„Ç§„Ç∫Áµ±Ë®à
          </div>
          <div class="quiz-stats">
            <div class="stat-card">
              <div class="stat-value">${quizResults.totalQuizzes || 0}</div>
              <div class="stat-label">Á∑è„ÇØ„Ç§„Ç∫Êï∞</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${quizResults.averageAccuracy || 0}%</div>
              <div class="stat-label">Âπ≥ÂùáÊ≠£Á≠îÁéá</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${quizResults.bestScore || 0}%</div>
              <div class="stat-label">ÊúÄÈ´ò„Çπ„Ç≥„Ç¢</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${quizResults.recentQuizzes || 0}</div>
              <div class="stat-label">ÊúÄËøë7Êó•Èñì</div>
            </div>
          </div>
        </div>
        
        <div class="info-section">
          <div class="section-title">
            <i class="fas fa-history"></i> ÊúÄËøë„ÅÆ„ÇØ„Ç§„Ç∫ÁµêÊûú
          </div>
          <div class="quiz-history">
            ${quizResults.recentQuizzesList.length > 0 ? 
              quizResults.recentQuizzesList.map(quiz => {
                // Firebase„ÅÆÂÆüÈöõ„ÅÆ„Éï„Ç£„Éº„É´„ÉâÂêç„Çí‰ΩøÁî®
                const score = quiz.score || 0;
                const total = quiz.total || 0;
                const accuracyPercent = total > 0 ? Math.round((score / total) * 100) : 0;
                
                // Ê≠£Á≠îÁéá„Å´Âü∫„Å•„ÅèËâ≤ÂàÜ„ÅëÔºà„Éë„Éº„Çª„É≥„ÉÜ„Éº„Ç∏Âü∫Ê∫ñÔºâ
                const itemClass = accuracyPercent >= 80 ? 'excellent' : accuracyPercent >= 60 ? 'good' : 'poor';
                
                return `
                  <div class="quiz-item ${itemClass}">
                    <div class="quiz-date">${new Date((quiz.createdAt && quiz.createdAt.seconds) ? quiz.createdAt.seconds * 1000 : Date.now()).toLocaleDateString('ja-JP')}</div>
                    <div class="quiz-score">Ê≠£Á≠îÁéá: ${accuracyPercent}% (${score}/${total}Âïè)</div>
                  </div>
                `;
              }).join('') : 
              '<div class="no-data">„ÇØ„Ç§„Ç∫ÁµêÊûú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>'
            }
          </div>
        </div>
        
        <div class="info-section">
          <div class="section-title">
            <i class="fas fa-notes-medical"></i> Ë®∫ÂØüË®òÈå≤ (${memos.length}‰ª∂)
            <button id="addMemoBtn" class="add-memo-btn" style="margin-left: auto; background: #2196f3; color: white; border: none; border-radius: 8px; padding: 8px 16px; cursor: pointer; font-size: 0.9em;">
              <i class="fas fa-plus"></i> Ë®òÈå≤„ÇíËøΩÂä†
            </button>
          </div>
          <div class="memo-history">
            ${memos.length > 0 ? 
              memos.slice(0, 5).map(memo => `
                <div class="memo-item">
                  <div class="memo-date">${memo.date} - ${memo.doctorName || 'ÂåªÂ∏´'}</div>
                  <div class="memo-content">
                    ${memo.condition ? `<strong>ÁóÖÁä∂:</strong> ${memo.condition}<br>` : ''}
                    ${memo.prescription ? `<strong>Âá¶Êñπ:</strong> ${memo.prescription}<br>` : ''}
                    ${memo.other ? `<strong>„Åù„ÅÆ‰ªñ:</strong> ${memo.other}` : ''}
                  </div>
                </div>
              `).join('') : 
              '<div class="no-data">Ë®∫ÂØüË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>'
            }
          </div>
        </div>
      `;
      
      // Ë®∫ÂØüË®òÈå≤ËøΩÂä†„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
      const addMemoBtn = document.getElementById('addMemoBtn');
      if (addMemoBtn) {
        addMemoBtn.onclick = function() {
          openMemoModal(patient);
        };
      }
    }

    function renderMemoArea(patient, memos) {
      const area = document.getElementById('memoArea');
      const currentDate = new Date().toISOString().split('T')[0];
      
      area.innerHTML = `
        <h2><i class="fas fa-notes-medical"></i> ${patient.name} „Åï„Çì„ÅÆË®∫ÁôÇ„É°„É¢</h2>
        <form id="memoForm">
          <div class="memo-field">
            <label><i class="fas fa-calendar-alt"></i> Ë®∫ÂØüÊó•</label>
            <input type="date" class="memo-input" id="memoDate" value="${currentDate}">
          </div>
          <div class="memo-field">
            <label><i class="fas fa-stethoscope"></i> ÁóÖÁä∂ <span style="color:#666;font-size:0.9em;">(ÂøÖÈ†à)</span></label>
            <textarea class="memo-input" id="memoCondition" rows="3" placeholder="ÊÇ£ËÄÖ„ÅÆÁóáÁä∂„ÇÑÁóÖÁä∂„ÇíË®òÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ"></textarea>
          </div>
          <div class="memo-field">
            <label><i class="fas fa-pills"></i> Âá¶ÊñπÁÆã</label>
            <textarea class="memo-input" id="memoPrescription" rows="3" placeholder="Âá¶Êñπ„Åó„ÅüËñ¨„ÇÑÊ≤ªÁôÇÂÜÖÂÆπ„ÇíË®òÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ"></textarea>
          </div>
          <div class="memo-field">
            <label><i class="fas fa-pen"></i> „Åù„ÅÆ‰ªñ„ÅÆ„É°„É¢</label>
            <textarea class="memo-input" id="memoOther" rows="2" placeholder="„Åù„ÅÆ‰ªñ„ÅÆÊ≥®ÊÑè‰∫ãÈ†Ö„ÇÑ„É°„É¢„Åå„ÅÇ„Çå„Å∞Ë®òÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ"></textarea>
          </div>
          <button class="save-btn" type="submit"><i class="fas fa-save"></i> Ë®∫Êñ≠„É°„É¢„Çí‰øùÂ≠ò</button>
        </form>
        <div class="memo-history">
          <h3><i class="fas fa-history"></i> „É°„É¢Â±•Ê≠¥ (${memos.length}‰ª∂)</h3>
          ${memos.length === 0 ? '<p style="color:var(--text-color-muted,#4A4A4A);margin:12px 0;">„É°„É¢„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</p>' : memos.map(memo => `
            <div class="memo-entry">
              <div class="memo-header">
                <div class="memo-date"><i class="fas fa-calendar-day"></i> ${memo.date}</div>
                <div class="memo-doctor" style="font-size:0.9em;color:#666;">
                  <i class="fas fa-user-md"></i> ${memo.doctorName || 'ÂåªÂ∏´'}
                </div>
              </div>
              <div class="memo-content">
                ${memo.condition ? `<div class="memo-item"><span class="memo-label"><i class="fas fa-stethoscope"></i> ÁóÖÁä∂:</span><span>${memo.condition}</span></div>` : ''}
                ${memo.prescription ? `<div class="memo-item"><span class="memo-label"><i class="fas fa-pills"></i> Âá¶ÊñπÁÆã:</span><span>${memo.prescription}</span></div>` : ''}
                ${memo.other ? `<div class="memo-item"><span class="memo-label"><i class="fas fa-pen"></i> „Åù„ÅÆ‰ªñ:</span><span>${memo.other}</span></div>` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      `;
      document.getElementById('memoForm').onsubmit = async function(e) {
        e.preventDefault();
        
        // ÁèæÂú®„ÅÆÊó•ÊôÇ„ÇíÂèñÂæó
        const now = new Date();
        const currentDate = now.toISOString().split('T')[0];
        
        const newMemo = {
          date: document.getElementById('memoDate').value || currentDate,
          condition: document.getElementById('memoCondition').value,
          prescription: document.getElementById('memoPrescription').value,
          other: document.getElementById('memoOther').value,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          doctorId: currentUserId,
          doctorName: firebase.auth().currentUser?.displayName || 'ÂåªÂ∏´'
        };
        
        if (!newMemo.condition && !newMemo.prescription && !newMemo.other) {
          alert('Â∞ë„Å™„Åè„Å®„ÇÇÁóÖÁä∂„ÄÅÂá¶ÊñπÁÆã„ÄÅ„Åù„ÅÆ‰ªñ„ÅÆ„ÅÑ„Åö„Çå„Åã„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
          return;
        }
        
        try {
          // Êó¢Â≠ò„ÅÆ„É°„É¢ÈÖçÂàó„ÇíÂèñÂæó
          const patientDoc = await db.collection('users').doc(patient.id).get();
          const existingMemos = patientDoc.data().memos || [];
          
          // Êñ∞„Åó„ÅÑ„É°„É¢„ÇíÈÖçÂàó„ÅÆÂÖàÈ†≠„Å´ËøΩÂä†
          existingMemos.unshift(newMemo);
          
          // Firebase„Å´‰øùÂ≠ò
          await db.collection('users').doc(patient.id).update({ 
            memos: existingMemos,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
          alert('Ë®∫Êñ≠„É°„É¢„ÅåÊ≠£Â∏∏„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åó„ÅüÔºÅ');
          
          // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
          document.getElementById('memoCondition').value = '';
          document.getElementById('memoPrescription').value = '';
          document.getElementById('memoOther').value = '';
          document.getElementById('memoDate').value = currentDate;
          
          // ÊÇ£ËÄÖÊÉÖÂ†±„ÇíÂÜçË™≠„ÅøËæº„Åø
          await selectPatient(patient.id);
          
        } catch (error) {
          console.error('„É°„É¢‰øùÂ≠ò„Ç®„É©„Éº:', error);
          alert('„É°„É¢„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
        }
      };
    }

    // „ÇØ„Ç§„Ç∫ÁµêÊûú„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
    async function getQuizResults(patientEmail) {
      if (!patientEmail) {
        return {
          totalQuizzes: 0,
          averageAccuracy: 0,
          bestScore: 0,
          recentQuizzes: 0,
          recentQuizzesList: []
        };
      }
      
      try {
        // ai_quiz_scores„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Åã„ÇâÊÇ£ËÄÖ„ÅÆ„ÇØ„Ç§„Ç∫ÁµêÊûú„ÇíÂèñÂæóÔºàorderBy„ÇíÂâäÈô§„Åó„Å¶„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Ç®„É©„Éº„ÇíÂõûÈÅøÔºâ
        const quizSnapshot = await db.collection('ai_quiz_scores')
          .where('userEmail', '==', patientEmail)
          .get();
        
        if (quizSnapshot.empty) {
          return {
            totalQuizzes: 0,
            averageAccuracy: 0,
            bestScore: 0,
            recentQuizzes: 0,
            recentQuizzesList: []
          };
        }
        
        const quizzes = quizSnapshot.docs.map(doc => doc.data());
        
        // „Éá„Éê„ÉÉ„Ç∞Áî®: ÊúÄÂàù„ÅÆ„ÇØ„Ç§„Ç∫„Éá„Éº„Çø„ÅÆÊßãÈÄ†„ÇíÁ¢∫Ë™ç
        if (quizzes.length > 0) {
          console.log('„ÇØ„Ç§„Ç∫„Éá„Éº„Çø„ÅÆ‰æã:', quizzes[0]);
        }
        
        // „ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂÅ¥„Åß„Çø„Ç§„É†„Çπ„Çø„É≥„ÉóÈ†Ü„Å´„ÇΩ„Éº„ÉàÔºàcreatedAt„Éï„Ç£„Éº„É´„Éâ„Çí‰ΩøÁî®Ôºâ
        quizzes.sort((a, b) => {
          const timestampA = a.createdAt && a.createdAt.seconds ? a.createdAt.seconds : 0;
          const timestampB = b.createdAt && b.createdAt.seconds ? b.createdAt.seconds : 0;
          return timestampB - timestampA; // ÈôçÈ†ÜÔºàÊñ∞„Åó„ÅÑÈ†ÜÔºâ
        });
        
        const totalQuizzes = quizzes.length;
        
        // Âπ≥ÂùáÊ≠£Á≠îÁéá„ÇíË®àÁÆóÔºàaccuracy„ÅÆÂÄ§„ÅÆÁØÑÂõ≤„ÇíÁ¢∫Ë™ç„Åó„Å¶ÈÅ©Âàá„Å´Âá¶ÁêÜÔºâ
        let totalAccuracy = 0;
        let maxAccuracy = 0;
        
        quizzes.forEach(quiz => {
          // Firebase„ÅÆÂÆüÈöõ„ÅÆ„Éï„Ç£„Éº„É´„ÉâÂêç„Çí‰ΩøÁî®: score/total„Åã„ÇâÊ≠£Á≠îÁéá„ÇíË®àÁÆó
          const score = quiz.score || 0;
          const total = quiz.total || 0;
          let accuracy = 0;
          
          if (total > 0) {
            accuracy = (score / total) * 100;
          }
          
          totalAccuracy += accuracy;
          maxAccuracy = Math.max(maxAccuracy, accuracy);
        });
        
        const averageAccuracy = Math.round(totalAccuracy / totalQuizzes);
        const bestScore = Math.round(maxAccuracy);
        
        // ÊúÄËøë7Êó•Èñì„ÅÆ„ÇØ„Ç§„Ç∫Êï∞
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        const recentQuizzes = quizzes.filter(quiz => {
          // createdAt„Éï„Ç£„Éº„É´„Éâ„Çí‰ΩøÁî®
          const quizDate = quiz.createdAt && quiz.createdAt.seconds ? 
            new Date(quiz.createdAt.seconds * 1000) : new Date(0);
          return quizDate >= sevenDaysAgo;
        }).length;
        
        // ÊúÄËøë„ÅÆ„ÇØ„Ç§„Ç∫ÁµêÊûúÔºàÊúÄÂ§ß5‰ª∂Ôºâ
        const recentQuizzesList = quizzes.slice(0, 5);
        
        return {
          totalQuizzes,
          averageAccuracy,
          bestScore,
          recentQuizzes,
          recentQuizzesList
        };
        
      } catch (error) {
        console.error('„ÇØ„Ç§„Ç∫ÁµêÊûúÂèñÂæó„Ç®„É©„Éº:', error);
        return {
          totalQuizzes: 0,
          averageAccuracy: 0,
          bestScore: 0,
          recentQuizzes: 0,
          recentQuizzesList: []
        };
      }
    }

    document.getElementById('patientSearch').addEventListener('input', function(e) {
        const searchText = e.target.value.toLowerCase();
        const items = document.querySelectorAll('.chat-item');
        items.forEach(item => {
            const name = item.querySelector('.doctor-name').textContent.toLowerCase();
            item.style.display = name.includes(searchText) ? 'flex' : 'none';
        });
    });

    // „É¢„Éº„ÉÄ„É´Ê©üËÉΩ„ÇíËøΩÂä†
    let currentPatientForMemos = null;

    // „É¢„Éº„ÉÄ„É´„ÇíÈñã„ÅèÈñ¢Êï∞
    function openMemoModal(patient) {
      currentPatientForMemos = patient;
      const modal = document.getElementById('memoModal');
      const memoDateInput = document.getElementById('memoDate');
      
      // ‰ªäÊó•„ÅÆÊó•‰ªò„Çí„Éá„Éï„Ç©„É´„ÉàÂÄ§„Å®„Åó„Å¶Ë®≠ÂÆö
      const today = new Date().toISOString().split('T')[0];
      memoDateInput.value = today;
      
      // „Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
      document.getElementById('memoCondition').value = '';
      document.getElementById('memoPrescription').value = '';
      document.getElementById('memoOther').value = '';
      
      modal.style.display = 'block';
    }

    // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„ÇãÈñ¢Êï∞
    function closeMemoModal() {
      const modal = document.getElementById('memoModal');
      modal.style.display = 'none';
      currentPatientForMemos = null;
    }

    // Ë®∫ÂØüË®òÈå≤„Çí‰øùÂ≠ò„Åô„ÇãÈñ¢Êï∞
    async function saveMemo() {
      if (!currentPatientForMemos) {
        alert('ÊÇ£ËÄÖÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
        return;
      }

      const condition = document.getElementById('memoCondition').value.trim();
      const prescription = document.getElementById('memoPrescription').value.trim();
      const other = document.getElementById('memoOther').value.trim();
      const date = document.getElementById('memoDate').value;

      if (!condition) {
        alert('ÁóÖÁä∂„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }

      try {
        // Êó¢Â≠ò„ÅÆË®∫ÂØüË®òÈå≤„ÇíÂèñÂæó
        const patientDoc = await db.collection('users').doc(currentPatientForMemos.id).get();
        const existingMemos = patientDoc.data().memos || [];

        // Êñ∞„Åó„ÅÑË®∫ÂØüË®òÈå≤„Çí‰ΩúÊàê
        const newMemo = {
          date: date,
          condition: condition,
          prescription: prescription,
          other: other,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          doctorId: currentUserId,
          doctorName: firebase.auth().currentUser?.displayName || 'ÂåªÂ∏´'
        };

        // Êñ∞„Åó„ÅÑË®òÈå≤„ÇíÈÖçÂàó„Å´ËøΩÂä†
        existingMemos.unshift(newMemo);

        // Firebase„Å´‰øùÂ≠ò
        await db.collection('users').doc(currentPatientForMemos.id).update({
          memos: existingMemos,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert('Ë®∫ÂØüË®òÈå≤„Åå‰øùÂ≠ò„Åï„Çå„Åæ„Åó„Åü');
        closeMemoModal();

        // ÊÇ£ËÄÖÊÉÖÂ†±„ÇíÂÜçË™≠„ÅøËæº„Åø
        await selectPatient(currentPatientForMemos.id);

      } catch (error) {
        console.error('Ë®∫ÂØüË®òÈå≤‰øùÂ≠ò„Ç®„É©„Éº:', error);
        alert('Ë®∫ÂØüË®òÈå≤„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
      }
    }

    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('memoModal');
      const closeBtn = document.querySelector('.close');
      const closeModalBtn = document.getElementById('closeModalBtn');
      const saveMemoBtn = document.getElementById('saveMemoBtn');

      if (closeBtn) {
        closeBtn.onclick = closeMemoModal;
      }

      if (closeModalBtn) {
        closeModalBtn.onclick = closeMemoModal;
      }

      if (saveMemoBtn) {
        saveMemoBtn.onclick = saveMemo;
      }

      // „É¢„Éº„ÉÄ„É´Â§ñ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„ÇâÈñâ„Åò„Çã
      window.onclick = function(event) {
        if (event.target === modal) {
          closeMemoModal();
        }
      }
    });
    </script>
</body>
</html>
