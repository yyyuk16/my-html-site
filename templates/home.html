<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="åŒ»ç™‚æƒ…å ±ç®¡ç†ã‚¢ãƒ—ãƒª - åŒ»å¸«ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰">åŒ»ç™‚æƒ…å ±ç®¡ç†ã‚¢ãƒ—ãƒª - åŒ»å¸«ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="maintab.css">
    <link rel="stylesheet" href="footer.css">
  
</head>
<body>
    <!-- ğŸ’š ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="top-bar">
        <div class="header-inner">
            <div class="logo" style="font-size:2rem; font-weight:700; color:#2196f3; letter-spacing:0.08em; display:flex; align-items:center;">
                <span data-translate="site_title" style="vertical-align:middle;">åŒ»ç™‚ç®¡ç†ã‚¢ãƒ—ãƒª</span>
            </div>
            <nav>
                <ul class="tab-menu">
                    <li><a href="home.html" class="active">ğŸ¥ <span data-translate="HOME">HOME</span></a></li>
                    <li><a href="list.html">ğŸ‘¥ <span data-translate="æ‚£è€…è¨ºç™‚è¨˜éŒ²">æ‚£è€…è¨ºç™‚è¨˜éŒ²</span></a></li>
                    <li><a href="chat.html">ğŸ“… <span data-translate="ãƒãƒ£ãƒƒãƒˆ">ãƒãƒ£ãƒƒãƒˆ</span></a></li>
                    <li><a href="docterprofile.html">ğŸ‘¤ <span data-translate="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</span></a></li>
                </ul>
            </nav>
        </div>
    </header>
    
    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-links">
                    <a href="#" data-translate="terms">åˆ©ç”¨è¦ç´„</a>
                    <a href="#" data-translate="privacy">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
                </div>
                <div class="footer-copyright">
                    <small data-translate="copyright_name">Â© 2024 åŒ»ç™‚ç®¡ç†ã‚¢ãƒ—ãƒª. All rights reserved.</small>
                </div>
            </div>
        </div>
    </footer>
    
        <!-- Firebase SDKã®èª­ã¿è¾¼ã¿ -->
        <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js"></script>
        
        <!-- å¤šè¨€èªå¯¾å¿œã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
        <script src="multilang.js"></script>
        <script>
        document.addEventListener("DOMContentLoaded", async function() {
            // å¤šè¨€èªå¯¾å¿œã®åˆæœŸåŒ–
            if (window.multiLang && typeof window.multiLang.updateUI === 'function') {
                try { 
                    window.multiLang.updateUI(); 
                } catch (_) {}
            }
            
            // Firebaseã®åˆæœŸåŒ–
            const firebaseConfig = {
                apiKey: "AIzaSyB7TuGhOKbB4w7DDYt7KTejy-TrcxVZmpU",
                authDomain: "web01-2484d.firebaseapp.com",
                databaseURL: "https://web01-2484d-default-rtdb.firebaseio.com",
                projectId: "web01-2484d",
                storageBucket: "web01-2484d.firebasestorage.app",
                messagingSenderId: "90159472898",
                appId: "1:90159472898:web:261ec71f9919611011e21b",
                measurementId: "G-9TGR07ZSY9"
            };

            // Firebase Appã¨Databaseã®åˆæœŸåŒ–
            if (!window.firebaseApp) {
                window.firebaseApp = firebase.initializeApp(firebaseConfig);
            }
            const database = firebase.database();
            const firestore = firebase.firestore();

            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
            let currentUser = null;
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    currentUser = user;
                    loadNewMessageCount();
                } else {
                    document.getElementById("patientMessageCount").textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„";
                    document.getElementById("messageDetails").innerHTML = "";
                }
            });

            // æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã‚’å–å¾—ã™ã‚‹é–¢æ•°
            async function loadNewMessageCount() {
                try {
                    // ç¾åœ¨ã®åŒ»å¸«ãŒæ‹…å½“ã—ã¦ã„ã‚‹æ‚£è€…ã‚’å–å¾—
                    const patientsSnapshot = await firestore.collection('users')
                        .where('role', '==', 'patient')
                        .where('assignedDoctor', '==', currentUser.uid)
                        .get();

                    if (patientsSnapshot.empty) {
                        document.getElementById("patientMessageCount").textContent = "0 ä»¶";
                        document.getElementById("messageDetails").innerHTML = "æ‹…å½“æ‚£è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“";
                        return;
                    }

                    let totalNewMessages = 0;
                    let patientMessageDetails = [];
                    const now = new Date();
                    const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000); // 24æ™‚é–“å‰

                    // å„æ‚£è€…ã¨ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ç¢ºèª
                    for (const patientDoc of patientsSnapshot.docs) {
                        const patient = patientDoc.data();
                        const chatRoomId = [currentUser.uid, patientDoc.id].sort().join('_');
                        
                        try {
                            // Firestoreã‹ã‚‰ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å–å¾—
                            const chatRef = firestore.collection('chats').doc(chatRoomId).collection('messages');
                            const messagesSnapshot = await chatRef
                                .where('timestamp', '>=', oneDayAgo)
                                .where('senderId', '==', patientDoc.id) // æ‚£è€…ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿
                                .orderBy('timestamp', 'desc')
                                .get();

                            const newMessageCount = messagesSnapshot.size;
                            totalNewMessages += newMessageCount;

                            if (newMessageCount > 0) {
                                patientMessageDetails.push({
                                    name: patient.name || 'åç„¡ã—ã®æ‚£è€…',
                                    count: newMessageCount,
                                    lastMessage: messagesSnapshot.docs[0]?.data()?.text || 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—'
                                });
                            }
                        } catch (error) {
                            console.error(`æ‚£è€… ${patient.name} ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:`, error);
                        }
                    }

                    // çµæœã‚’è¡¨ç¤º
                    document.getElementById("patientMessageCount").textContent = totalNewMessages + " ä»¶";
                    
                    if (totalNewMessages > 0) {
                        const detailsHTML = patientMessageDetails.map(detail => 
                            `<div style="margin: 8px 0; padding: 8px; background: #f5f5f5; border-radius: 8px;">
                                <strong>${detail.name}</strong>: ${detail.count}ä»¶
                                <div style="font-size: 0.9em; color: #888; margin-top: 4px;">
                                    æœ€æ–°: ${detail.lastMessage.substring(0, 50)}${detail.lastMessage.length > 50 ? '...' : ''}
                                </div>
                            </div>`
                        ).join('');
                        document.getElementById("messageDetails").innerHTML = detailsHTML;
                    } else {
                        document.getElementById("messageDetails").innerHTML = "éå»24æ™‚é–“ã«æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“";
                    }

                } catch (error) {
                    console.error("æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                    document.getElementById("patientMessageCount").textContent = "å–å¾—å¤±æ•—";
                    document.getElementById("messageDetails").innerHTML = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message;
                }
            }

            // åŠ±ã¾ã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
            function showEncouragementMessage() {
                const encouragements = [
                    { start: 5, end: 10, msg: "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼ä»Šæ—¥ã‚‚ç´ æ•µãªä¸€æ—¥ã«ãªã‚Šã¾ã™ã‚ˆã†ã«ã€‚" },
                    { start: 10, end: 12, msg: "åˆå‰ä¸­ã‚‚ã‚ã¨å°‘ã—ã€é ‘å¼µã£ã¦ãã ã•ã„ï¼" },
                    { start: 12, end: 14, msg: "ãŠæ˜¼ä¼‘æ†©ã‚‚å¿˜ã‚Œãšã«ã€ã—ã£ã‹ã‚Šãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ã¾ã—ã‚‡ã†ã€‚" },
                    { start: 14, end: 18, msg: "åˆå¾Œã‚‚å¼•ãç¶šãã€ç„¡ç†ã›ãšé ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼" },
                    { start: 18, end: 22, msg: "ä»Šæ—¥ã‚‚ãŠç–²ã‚Œæ§˜ã§ã™ã€‚ã‚ã¨å°‘ã—ã€ãƒ•ã‚¡ã‚¤ãƒˆã§ã™ï¼" },
                    { start: 22, end: 24, msg: "é…ãã¾ã§ãŠç–²ã‚Œæ§˜ã§ã™ã€‚ã—ã£ã‹ã‚Šä¼‘ã‚“ã§ãã ã•ã„ã­ã€‚" },
                    { start: 0, end: 5, msg: "å¤œé…ãã¾ã§ãŠä»•äº‹ãŠç–²ã‚Œæ§˜ã§ã™ã€‚ä½“èª¿ã«æ°—ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚" }
                ];
                const now = new Date();
                const hour = now.getHours();
                let encouragement = "ä»Šæ—¥ã‚‚é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼";
                for (const e of encouragements) {
                    if (hour >= e.start && hour < e.end) {
                        encouragement = e.msg;
                        break;
                    }
                }
                document.getElementById("encouragementMessage").textContent = encouragement;
            }

            // åˆå›è¡¨ç¤º
            showEncouragementMessage();

            // 1åˆ†ã”ã¨ã«åŠ±ã¾ã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
            setInterval(showEncouragementMessage, 60000);

            // 5åˆ†ã”ã¨ã«æ–°ç€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ã‚’æ›´æ–°
            setInterval(loadNewMessageCount, 5 * 60 * 1000);
        });
        </script>
</body>
</html>