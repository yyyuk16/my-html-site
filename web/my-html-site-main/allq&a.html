<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="ã‚¯ã‚¤ã‚ºçµæœ">ã‚¯ã‚¤ã‚ºçµæœ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="maintab.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- ç¿»è¨³æ©Ÿèƒ½ -->
    <script src="translation.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 data-translate="åŒ»ç™‚æƒ…å ±ç®¡ç†ã‚¢ãƒ—ãƒª">åŒ»ç™‚æƒ…å ±ç®¡ç†ã‚¢ãƒ—ãƒª</h1>
    </div>
      
    <div class="tab-container">
        <div class="tab-header">
          <button class="tab-button" onclick="location.href='choise.html'">
            <span class="tab-icon">ğŸ‘¤</span>
            <span class="tab-text" data-translate="HOME">HOME</span>
          </button>
          <button class="tab-button" onclick="location.href='ai.html'">
            <span class="tab-icon">ğŸ’¬</span>
            <span class="tab-text" data-translate="ãƒãƒ£ãƒƒãƒˆ">ãƒãƒ£ãƒƒãƒˆ</span>
          </button>
          <button class="tab-button active" onclick="location.href='score.html'">
            <span class="tab-icon">â“</span>
            <span class="tab-text" data-translate="Q&A">Q&A</span>
          </button>
          <button class="tab-button" onclick="location.href='movie.html'">
            <span class="tab-icon">ğŸ¬</span>
            <span class="tab-text" data-translate="å‹•ç”»è¦–è´">å‹•ç”»è¦–è´</span>
          </button>
          <button class="tab-button" onclick="location.href='profile.html'">
            <span class="tab-icon">ğŸ‘¤</span>
            <span class="tab-text" data-translate="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</span>
          </button>
        </div>
    </div>
    <!-- ã‚¯ã‚¤ã‚ºã®ã‚¹ã‚³ã‚¢è¡¨ç¤ºã¨ãƒ©ãƒ³ã‚¯è¡¨ç¤ºã®ç”»é¢ -->
<div class="quiz-container" style="max-width:600px;margin:40px auto;padding:24px;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
  <h2 style="text-align:center;">AIã‚¯ã‚¤ã‚ºï¼ˆ5å•ãƒ©ãƒ³ãƒ€ãƒ ï¼‰</h2>
  <div id="quiz-area">
    <div style="text-align:center;margin:32px 0;">
      <button id="startQuizBtn" style="font-size:1.2em;padding:12px 32px;border-radius:8px;background:#1976d2;color:#fff;border:none;cursor:pointer;">ã‚¯ã‚¤ã‚ºã‚’å§‹ã‚ã‚‹</button>
    </div>
  </div>
</div>

<script>
// Firebaseã®è¨­å®š
const firebaseConfig = {
  apiKey: "AIzaSyC31W-TEE7mIBGFwrRxJAuPugjnEFfWe_k",
  authDomain: "web01-2484d.firebaseapp.com",
  projectId: "web01-2484d",
  storageBucket: "web01-2484d.appspot.com",
  messagingSenderId: "90159472898",
  appId: "1:90159472898:web:261ec71f9919611011e21b"
};

// Firebaseã®åˆæœŸåŒ–
if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}

const HF_API_KEY = "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"; // Hugging Faceã®APIãƒˆãƒ¼ã‚¯ãƒ³
const HF_API_URL = "https://api-inference.huggingface.co/models/microsoft/DialoGPT-medium";

async function fetchQuizQuestions() {
  const prompt = `
ã‚ãªãŸã¯åŒ»ç™‚åˆ†é‡ã®ã‚¯ã‚¤ã‚ºä½œæˆAIã§ã™ã€‚çµæ ¸ã«é–¢ã™ã‚‹4æŠã‚¯ã‚¤ã‚ºã‚’æ—¥æœ¬èªã§5å•ãƒ©ãƒ³ãƒ€ãƒ ã«ä½œæˆã—ã¦ãã ã•ã„ã€‚
å„å•é¡Œã¯ä»¥ä¸‹ã®å½¢å¼ã§æœ‰åŠ¹ãªJSONé…åˆ—ã¨ã—ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

[
  {
    "question": "å•é¡Œæ–‡",
    "choices": ["é¸æŠè‚¢1", "é¸æŠè‚¢2", "é¸æŠè‚¢3", "é¸æŠè‚¢4"],
    "answer": "æ­£è§£ã®é¸æŠè‚¢",
    "explanation": "è§£èª¬æ–‡"
  }
]
  `;

  try {
    const res = await fetch(HF_API_URL, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${HF_API_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        inputs: prompt,
        parameters: {
          max_new_tokens: 1200,   // å‡ºåŠ›ãŒé€”ä¸­ã§åˆ‡ã‚Œãªã„ã‚ˆã†ã«é•·ã‚
          temperature: 0.7,       // ãƒ©ãƒ³ãƒ€ãƒ æ€§ï¼ˆå°ã•ã‚ã«ã™ã‚‹ã¨çœŸé¢ç›®ãªå›ç­”ã«ãªã‚Šã‚„ã™ã„ï¼‰
        }
      })
    });

    if (!res.ok) {
      throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${res.status} - ${res.statusText}`);
    }

    const data = await res.json();
    console.log("APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:", data);

    // Hugging Face ã®è¿”ç­”ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
    let text = "";
    if (Array.isArray(data) && data[0]?.generated_text) {
      text = data[0].generated_text;
    } else if (data.generated_text) {
      text = data.generated_text;
    }

    // JSONéƒ¨åˆ†ã ã‘ã‚’æŠ½å‡º
    const jsonStart = text.indexOf("[");
    const jsonEnd = text.lastIndexOf("]");
    if (jsonStart !== -1 && jsonEnd !== -1) {
      text = text.substring(jsonStart, jsonEnd + 1);
    }

    // ãƒ‘ãƒ¼ã‚¹
    const questions = JSON.parse(text);
    console.log("ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸã‚¯ã‚¤ã‚º:", questions);
    return questions;
  } catch (e) {
    console.error("ã‚¯ã‚¤ã‚ºå–å¾—ã‚¨ãƒ©ãƒ¼:", e);
    alert("ã‚¯ã‚¤ã‚ºã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚\nã‚¨ãƒ©ãƒ¼: " + e.message);
    return [];
  }
}

// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ï¼ˆ5å•ï¼‰
const fallbackQuestions = [
  {
    question: "çµæ ¸ã¨ã¯ã©ã‚“ãªç—…æ°—ã§ã™ã‹ï¼Ÿ",
    choices: ["ç´°èŒã«ã‚ˆã‚‹æ„ŸæŸ“ç—‡", "ã‚¦ã‚¤ãƒ«ã‚¹ã«ã‚ˆã‚‹æ„ŸæŸ“ç—‡", "éºä¼æ€§ã®ç—…æ°—", "è‡ªå·±å…ç–«ç–¾æ‚£"],
    answer: "ç´°èŒã«ã‚ˆã‚‹æ„ŸæŸ“ç—‡",
    explanation: "çµæ ¸ã¯çµæ ¸èŒã¨ã„ã†ç´°èŒã«ã‚ˆã£ã¦å¼•ãèµ·ã“ã•ã‚Œã‚‹æ„ŸæŸ“ç—‡ã§ã™ã€‚ä¸»ã«è‚ºã«æ„ŸæŸ“ã—ã¾ã™ãŒã€ä»–ã®è‡“å™¨ã«ã‚‚æ„ŸæŸ“ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"
  },
  {
    question: "çµæ ¸ã®ä¸»ãªç—‡çŠ¶ã¯ä½•ã§ã™ã‹ï¼Ÿ",
    choices: ["é•·å¼•ãå’³", "è…¹ç—›", "çš®è†šã®ã‹ã‚†ã¿", "è¦–åŠ›ä½ä¸‹"],
    answer: "é•·å¼•ãå’³",
    explanation: "çµæ ¸ã®ä¸»ãªç—‡çŠ¶ã¯2é€±é–“ä»¥ä¸Šç¶šãå’³ã€ç—°ã€ç™ºç†±ã€ä½“é‡æ¸›å°‘ã€å€¦æ€ æ„Ÿãªã©ã§ã™ã€‚é¢¨é‚ªã¨ä¼¼ã¦ã„ã‚‹ãŸã‚ã€è¨ºæ–­ãŒé…ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚"
  },
  {
    question: "çµæ ¸ã®æ²»ç™‚æœŸé–“ã¯ã©ã‚Œãã‚‰ã„ã§ã™ã‹ï¼Ÿ",
    choices: ["1é€±é–“", "1ã‹æœˆ", "6ã‹æœˆä»¥ä¸Š", "1å¹´æœªæº€"],
    answer: "6ã‹æœˆä»¥ä¸Š",
    explanation: "çµæ ¸ã®æ²»ç™‚ã¯é€šå¸¸6ã‹æœˆã‹ã‚‰9ã‹æœˆé–“ã€è¤‡æ•°ã®æŠ—çµæ ¸è–¬ã‚’çµ„ã¿åˆã‚ã›ã¦è¡Œã„ã¾ã™ã€‚é€”ä¸­ã§è–¬ã‚’ã‚„ã‚ã‚‹ã¨è€æ€§èŒãŒã§ãã‚‹å±é™ºãŒã‚ã‚Šã¾ã™ã€‚"
  },
  {
    question: "çµæ ¸ã¯è‚ºä»¥å¤–ã®è‡“å™¨ã«ã‚‚å½±éŸ¿ã—ã¾ã™ã‹ï¼Ÿ",
    choices: ["ã¯ã„", "ã„ã„ãˆ", "ã‚ã‹ã‚‰ãªã„", "ãã®ä»–"],
    answer: "ã¯ã„",
    explanation: "çµæ ¸ã¯è‚ºä»¥å¤–ã«ã‚‚ã€éª¨ã€è…¸ã€çš®è†šã€è„³ãªã©å…¨èº«ã®è‡“å™¨ã«ç™ºç—‡ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚’è‚ºå¤–çµæ ¸ã¨å‘¼ã³ã¾ã™ã€‚"
  },
  {
    question: "çµæ ¸ã®æ„ŸæŸ“ã‚’é˜²ããŸã‚ã«ã€æ™®æ®µã‹ã‚‰å¿ƒãŒã‘ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
    choices: ["å¥åº·çš„ãªç”Ÿæ´»", "é‹å‹•ã‚’æ§ãˆã‚‹", "æ—¥å…‰ã‚’é¿ã‘ã‚‹", "èª­æ›¸ã‚’æ§ãˆã‚‹"],
    answer: "å¥åº·çš„ãªç”Ÿæ´»",
    explanation: "å…ç–«åŠ›ã‚’é«˜ã‚ã‚‹ãŸã‚ã€è¦å‰‡æ­£ã—ã„ç”Ÿæ´»ã€ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸé£Ÿäº‹ã€é©åº¦ãªé‹å‹•ã€ååˆ†ãªç¡çœ ãŒé‡è¦ã§ã™ã€‚ã¾ãŸã€å®šæœŸçš„ãªå¥åº·è¨ºæ–­ã‚‚å¤§åˆ‡ã§ã™ã€‚"
  }
];

// ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
firebase.auth().onAuthStateChanged(user => {
  if (user) {
    console.log("ãƒ­ã‚°ã‚¤ãƒ³ä¸­:", user.uid);
  } else {
    console.log("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“");
  }
});

// ã‚¯ã‚¤ã‚ºé–‹å§‹
document.getElementById("startQuizBtn").onclick = async function() {
  document.getElementById("quiz-area").innerHTML = "<div style='text-align:center;margin:32px;'>ã‚¯ã‚¤ã‚ºã‚’æº–å‚™ä¸­...</div>";
  
  // APIã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¯ã‚¤ã‚ºã‚’ç›´æ¥ä½¿ç”¨
  console.log("ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¯ã‚¤ã‚ºã‚’ä½¿ç”¨ã—ã¾ã™");
  quizQuestions = fallbackQuestions;
  
  if (quizQuestions.length >= 5) {
    currentQuestion = 0;
    score = 0;
    userAnswers = [];
    showQuestion();
  } else {
    document.getElementById("quiz-area").innerHTML = "<div style='color:red;text-align:center;'>ã‚¯ã‚¤ã‚ºã®æº–å‚™ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>";
  }
};

// å•é¡Œè¡¨ç¤º
function showQuestion() {
  const q = quizQuestions[currentQuestion];
  let html = `
    <div style="margin-bottom:16px;">
      <span style="font-weight:bold;">Q${currentQuestion+1}ï¼š</span>${q.question}
    </div>
    <form id="quizForm">
  `;
  
  // choicesãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  if (q.choices && Array.isArray(q.choices)) {
    q.choices.forEach((choice, idx) => {
      html += `
        <div style="margin:8px 0;">
          <label>
            <input type="radio" name="choice" value="${choice}" required>
            ${String.fromCharCode(65+idx)}. ${choice}
          </label>
        </div>
      `;
    });
  } else {
    // choicesãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é¸æŠè‚¢ã‚’ç”Ÿæˆ
    const defaultChoices = [
      "ã¯ã„",
      "ã„ã„ãˆ", 
      "ã‚ã‹ã‚‰ãªã„",
      "ãã®ä»–"
    ];
    defaultChoices.forEach((choice, idx) => {
      html += `
        <div style="margin:8px 0;">
          <label>
            <input type="radio" name="choice" value="${choice}" required>
            ${String.fromCharCode(65+idx)}. ${choice}
          </label>
        </div>
      `;
    });
  }
  
  html += `
      <button type="submit" style="margin-top:16px;padding:8px 24px;background:#1976d2;color:#fff;border:none;border-radius:6px;cursor:pointer;">å›ç­”ã™ã‚‹</button>
    </form>
    <div style="margin-top:16px;text-align:right;">${currentQuestion+1} / 5å•</div>
  `;
  document.getElementById("quiz-area").innerHTML = html;

  document.getElementById("quizForm").onsubmit = function(e) {
    e.preventDefault();
    const form = e.target;
    const selected = form.choice.value;
    userAnswers.push(selected);
    
    // æ­£è§£åˆ¤å®šã‚’ä¿®æ­£
    const correctAnswer = q.answer || q.choices?.[0] || "ã¯ã„";
    if (selected === correctAnswer) score++;
    
    currentQuestion++;
    if (currentQuestion < 5) {
      showQuestion();
    } else {
      showResult();
    }
  };
}

// Firebaseã«ã‚¹ã‚³ã‚¢ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
async function saveQuizScore() {
  try {
    const user = firebase.auth().currentUser;
    if (!user) {
      console.log("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“");
      return;
    }

    const db = firebase.firestore();
    const quizData = {
      userId: user.uid,
      userEmail: user.email,
      userName: user.displayName || "åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼",
      correct: score,
      total: 5,
      accuracy: parseFloat((score / 5 * 100).toFixed(1)),
      category: "AIã‚¯ã‚¤ã‚ºï¼ˆ5å•ãƒ©ãƒ³ãƒ€ãƒ ï¼‰",
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      userType: "registered"
    };

    await db.collection('ai_quiz_scores').add(quizData);
    console.log("AIã‚¯ã‚¤ã‚ºã®ã‚¹ã‚³ã‚¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ:", quizData);
    
    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    showSaveSuccessMessage();
  } catch (error) {
    console.error("ã‚¹ã‚³ã‚¢ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
    showSaveErrorMessage();
  }
}

// ä¿å­˜æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
function showSaveSuccessMessage() {
  const successDiv = document.createElement('div');
  successDiv.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #4CAF50;
    color: white;
    padding: 12px 20px;
    border-radius: 4px;
    z-index: 1000;
    font-size: 14px;
  `;
  successDiv.textContent = 'ã‚¹ã‚³ã‚¢ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼';
  document.body.appendChild(successDiv);
  
  setTimeout(() => {
    document.body.removeChild(successDiv);
  }, 3000);
}

// ä¿å­˜ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
function showSaveErrorMessage() {
  const errorDiv = document.createElement('div');
  errorDiv.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #f44336;
    color: white;
    padding: 12px 20px;
    border-radius: 4px;
    z-index: 1000;
    font-size: 14px;
  `;
  errorDiv.textContent = 'ã‚¹ã‚³ã‚¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ';
  document.body.appendChild(errorDiv);
  
  setTimeout(() => {
    document.body.removeChild(errorDiv);
  }, 3000);
}

// çµæœè¡¨ç¤º
async function showResult() {
  // ã‚¹ã‚³ã‚¢ã‚’Firebaseã«ä¿å­˜
  await saveQuizScore();
  
  let resultHtml = `
    <div style="text-align:center;">
      <h3>ã‚¯ã‚¤ã‚ºçµ‚äº†ï¼</h3>
      <div style="font-size:1.3em;margin:16px 0;">ã‚ãªãŸã®ã‚¹ã‚³ã‚¢: <b>${score} / 5</b></div>
      <div style="font-size:1.1em;margin:16px 0;">æ­£ç­”ç‡: <b>${(score/5*100).toFixed(1)}%</b></div>
      <button onclick="location.reload()" style="padding:8px 24px;background:#1976d2;color:#fff;border:none;border-radius:6px;cursor:pointer;">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
    </div>
    <hr style="margin:32px 0;">
    <div>
      <h4>è§£ç­”ã¨è§£èª¬</h4>
      <ol>
  `;
  quizQuestions.forEach((q, i) => {
    const correctAnswer = q.answer || q.choices?.[0] || "ã¯ã„";
    const isCorrect = userAnswers[i] === correctAnswer;
    resultHtml += `
      <li style="margin-bottom:12px;">
        <div><b>Q${i+1}ï¼š</b>${q.question}</div>
        <div>ã‚ãªãŸã®ç­”ãˆ: <span style="color:${isCorrect?'green':'red'};">${userAnswers[i] || 'æœªå›ç­”'}</span>ã€€/ã€€æ­£è§£: <b>${correctAnswer}</b></div>
        ${q.explanation ? `<div style="margin-top:8px;color:#666;font-size:0.9em;">è§£èª¬: ${q.explanation}</div>` : ''}
      </li>
    `;
  });
  resultHtml += "</ol></div>";
  document.getElementById("quiz-area").innerHTML = resultHtml;
}
</script>

</body>
</html>
